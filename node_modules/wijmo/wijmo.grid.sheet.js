/*
    *
    * Wijmo Library 5.20172.334
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the Wijmo Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */
var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","wijmo/wijmo","wijmo/wijmo.xlsx","wijmo/wijmo.grid","wijmo/wijmo.input","wijmo/wijmo.grid.filter","wijmo/wijmo.grid.xlsx","wijmo/wijmo.grid.sheet"],function(n,t,i,r,u,f,e,o,s){"use strict";var wt,k,c,a,l,p,v,h,bt,nt,y,st,b,d,ht,ct,ut,ft,kt,et,dt,lt,ot,at,vt,gt,ni,tt,ti,ii,it,rt,w,ri,ui,yt,pt,fi,g,ei,oi,si,hi,ci,li,ai;Object.defineProperty(t,"__esModule",{value:!0});window.wijmo=window.wijmo||{};window.wijmo.grid=window.wijmo.grid||{};window.wijmo.grid.sheet=s;wt=function(){function n(n){this._expressionCache={};this._idChars='$:!';this._functionTable={};this._cacheSize=0;this.unknownFunction=new i.Event;this._owner=n;this._buildSymbolTable();this._registerAggregateFunction();this._registerMathFunction();this._registerLogicalFunction();this._registerTextFunction();this._registerDateFunction();this._registLookUpReferenceFunction();this._registFinacialFunction()}return n.prototype.onUnknownFunction=function(n,t){var u,r,i;if(t&&t.length>0)for(u=[],i=0;i<t.length;i++)u[i]=t[i].evaluate();if(r=new ii(n,u),this.unknownFunction.raise(this,r),r.value!=null)return new h(r.value);throw'The function "'+n+'" has not supported in FlexSheet yet.';},n.prototype.evaluate=function(n,t,r,u,f){var o,e;try{if(n&&n.length>1&&n[0]==='='){for(o=this._checkCache(n),e=o.evaluate(r,u,f);e instanceof h;)e=e.evaluate(r);return t&&i.isPrimitive(e)?i.Globalize.format(e,t):e}return n?n:''}catch(s){return"Error: "+s}},n.prototype.addCustomFunction=function(n,t,i,r){var u=this;n=n.toLowerCase();this._functionTable[n]=new c(function(n){var r,f=[],i;if(n.length>0)for(i=0;i<n.length;i++)r=n[i],f[i]=r instanceof y?r.cells:r.evaluate();return t.apply(u,f)},r,i)},n.prototype.addFunction=function(n,t,i,r){var u=this;n=n.toLowerCase();this._functionTable[n]=new c(function(n){var r,f=[],i;if(n.length>0)for(i=0;i<n.length;i++)r=n[i],f[i]=r instanceof y?r.getValuseWithTwoDimensions():[[r.evaluate()]];return t.apply(u,f)},r,i)},n.prototype._clearExpressionCache=function(){this._expressionCache=null;this._expressionCache={};this._cacheSize=0},n.prototype._parse=function(n){return this._expression=n,this._expressLength=n?n.length:0,this._pointer=0,this._expressLength>0&&this._expression[0]==='='&&this._pointer++,this._parseExpression()},n.prototype._buildSymbolTable=function(){this._tokenTable||(this._tokenTable={},this._addToken('+',l.ADD,a.ADDSUB),this._addToken('-',l.SUB,a.ADDSUB),this._addToken('(',l.OPEN,a.GROUP),this._addToken(')',l.CLOSE,a.GROUP),this._addToken('*',l.MUL,a.MULDIV),this._addToken(',',l.COMMA,a.GROUP),this._addToken('.',l.PERIOD,a.GROUP),this._addToken('/',l.DIV,a.MULDIV),this._addToken('\\',l.DIVINT,a.MULDIV),this._addToken('=',l.EQ,a.COMPARE),this._addToken('>',l.GT,a.COMPARE),this._addToken('<',l.LT,a.COMPARE),this._addToken('^',l.POWER,a.POWER),this._addToken("<>",l.NE,a.COMPARE),this._addToken(">=",l.GE,a.COMPARE),this._addToken("<=",l.LE,a.COMPARE),this._addToken('&',l.CONCAT,a.CONCAT))},n.prototype._registerAggregateFunction=function(){var n=this;n._functionTable.sum=new c(function(t,r){return n._getAggregateResult(i.Aggregate.Sum,t,r)});n._functionTable.average=new c(function(t,r){return n._getAggregateResult(i.Aggregate.Avg,t,r)});n._functionTable.max=new c(function(t,r){return n._getAggregateResult(i.Aggregate.Max,t,r)});n._functionTable.min=new c(function(t,r){return n._getAggregateResult(i.Aggregate.Min,t,r)});n._functionTable['var']=new c(function(t,r){return n._getAggregateResult(i.Aggregate.Var,t,r)});n._functionTable.varp=new c(function(t,r){return n._getAggregateResult(i.Aggregate.VarPop,t,r)});n._functionTable.stdev=new c(function(t,r){return n._getAggregateResult(i.Aggregate.Std,t,r)});n._functionTable.stdevp=new c(function(t,r){return n._getAggregateResult(i.Aggregate.StdPop,t,r)});n._functionTable.count=new c(function(t,i){return n._getFlexSheetAggregateResult(p.Count,t,i)});n._functionTable.counta=new c(function(t,i){return n._getFlexSheetAggregateResult(p.CountA,t,i)});n._functionTable.countblank=new c(function(t,i){return n._getFlexSheetAggregateResult(p.ConutBlank,t,i)});n._functionTable.countif=new c(function(t,i){return n._getFlexSheetAggregateResult(p.CountIf,t,i)},2,2);n._functionTable.countifs=new c(function(t,i){return n._getFlexSheetAggregateResult(p.CountIfs,t,i)},254,2);n._functionTable.sumif=new c(function(t,i){return n._getFlexSheetAggregateResult(p.SumIf,t,i)},3,2);n._functionTable.sumifs=new c(function(t,i){return n._getFlexSheetAggregateResult(p.SumIfs,t,i)},255,2);n._functionTable.rank=new c(function(t,i){return n._getFlexSheetAggregateResult(p.Rank,t,i)},3,2);n._functionTable.product=new c(function(t,i){return n._getFlexSheetAggregateResult(p.Product,t,i)},255,1);n._functionTable.subtotal=new c(function(t,i){return n._handleSubtotal(t,i)},255,2);n._functionTable.dcount=new c(function(t,i){return n._handleDCount(t,i)},3,3);n._functionTable.sumproduct=new c(function(t,i){return n._getSumProduct(t,i)},255,1)},n.prototype._registerMathFunction=function(){var n=this;n._functionTable.pi=new c(function(){return Math.PI},0,0);n._functionTable.rand=new c(function(){return Math.random()},0,0);n._functionTable.power=new c(function(n,t){return Math.pow(h.toNumber(n[0],t),h.toNumber(n[1],t))},2,2);n._functionTable.atan2=new c(function(n,t){var i=h.toNumber(n[0],t),r=h.toNumber(n[1],t);if(i===0&&r===0)throw'The x number and y number can\'t both be zero for the atan2 function';return Math.atan2(r,i)},2,2);n._functionTable.mod=new c(function(n,t){return h.toNumber(n[0],t)%h.toNumber(n[1],t)},2,2);n._functionTable.trunc=new c(function(n,t){var i=h.toNumber(n[0],t),u=n.length===2?h.toNumber(n[1],t):0,r;return u===0?i>=0?Math.floor(i):Math.ceil(i):(r=Math.pow(10,u),i>=0?Math.floor(i*r)/r:Math.ceil(i*r)/r)},2,1);['round','rounddown','roundup'].forEach(function(t){n._functionTable[t]=new c(function(n,r){var u=h.toNumber(n[0],r),o=h.toNumber(n[1],r),e,s,f;if(o===0){switch(t){case'rounddown':e=u>=0?Math.floor(u):Math.ceil(u);break;case'roundup':e=u>=0?Math.ceil(u):Math.floor(u);break;case'round':e=Math.round(u);break;default:e=Math.floor(u)}s='n0'}else if(o>0&&i.isInt(o)){f=Math.pow(10,o);switch(t){case'rounddown':e=u>=0?Math.floor(u*f)/f:Math.ceil(u*f)/f;break;case'roundup':e=u>=0?Math.ceil(u*f)/f:Math.floor(u*f)/f;break;case'round':e=Math.round(u*f)/f}s='n'+o}if(e!=null)return{value:e,format:s};throw'Invalid precision!';},2,2)});['abs','acos','asin','atan','ceiling','cos','exp','floor','ln','sin','sqrt','tan'].forEach(function(t){n._functionTable[t]=new c(function(n,i){switch(t){case'ceiling':return Math.ceil(h.toNumber(n[0],i));case'ln':return Math.log(h.toNumber(n[0],i));default:return Math[t](h.toNumber(n[0],i))}},1,1)})},n.prototype._registerLogicalFunction=function(){this._functionTable.and=new c(function(n,t){for(var i=!0,r=0;r<n.length;r++)if(i=i&&h.toBoolean(n[r],t),!i)break;return i},Number.MAX_VALUE,1);this._functionTable.or=new c(function(n,t){for(var i=!1,r=0;r<n.length;r++)if(i=i||h.toBoolean(n[r],t),i)break;return i},Number.MAX_VALUE,1);this._functionTable.not=new c(function(n,t){return!h.toBoolean(n[0],t)},1,1);this._functionTable['if']=new c(function(n,t){return n.length===3?h.toBoolean(n[0],t)?n[1].evaluate(t):n[2].evaluate(t):h.toBoolean(n[0],t)?n[1].evaluate(t):!1},3,2);this._functionTable['true']=new c(function(){return!0},0,0);this._functionTable['false']=new c(function(){return!1},0,0)},n.prototype._registerTextFunction=function(){this._functionTable.char=new c(function(n,t){for(var r='',i=0;i<n.length;i++)r+=String.fromCharCode(h.toNumber(n[i],t));return r},Number.MAX_VALUE,1);this._functionTable.code=new c(function(n,t){var i=h.toString(n[0],t);return i&&i.length>0?i.charCodeAt(0):-1},1,1);this._functionTable.concatenate=new c(function(n,t){for(var r='',i=0;i<n.length;i++)r=r.concat(h.toString(n[i],t));return r},Number.MAX_VALUE,1);this._functionTable.left=new c(function(n,t){var i=h.toString(n[0],t),r=Math.floor(h.toNumber(n[1],t));return i&&i.length>0?i.slice(0,r):undefined},2,2);this._functionTable.right=new c(function(n,t){var i=h.toString(n[0],t),r=Math.floor(h.toNumber(n[1],t));return i&&i.length>0?i.slice(-r):undefined},2,2);this._functionTable.find=new c(function(n,t){var f=h.toString(n[0],t),r=h.toString(n[1],t),u=n[2]!=null?i.asInt(h.toNumber(n[2])):0,e;return r!=null&&f!=null&&(e=!isNaN(u)&&u>0&&u<r.length?r.indexOf(f,u):r.indexOf(f),e>-1)?e+1:-1},3,2);this._functionTable.search=new c(function(n,t){var o=h.toString(n[0],t),r=h.toString(n[1],t),u=n[2]!=null?i.asInt(h.toNumber(n[2])):0,f,s,e;return r!=null&&o!=null&&(s=new RegExp(o,'i'),!isNaN(u)&&u>0&&u<r.length?(r=r.substring(u),f=u+1):f=1,e=r.search(s),e>-1)?e+f:-1},3,2);this._functionTable.len=new c(function(n,t){var i=h.toString(n[0],t);return i?i.length:-1},1,1);this._functionTable.mid=new c(function(n,t){var i=h.toString(n[0],t),r=Math.floor(h.toNumber(n[1],t)),u=Math.floor(h.toNumber(n[2],t));return i&&i.length>0&&r>0?i.substr(r-1,u):undefined},3,3);this._functionTable.lower=new c(function(n,t){var i=h.toString(n[0],t);return i&&i.length>0?i.toLowerCase():undefined},1,1);this._functionTable.upper=new c(function(n,t){var i=h.toString(n[0],t);return i&&i.length>0?i.toUpperCase():undefined},1,1);this._functionTable.proper=new c(function(n,t){var i=h.toString(n[0],t);return i&&i.length>0?i[0].toUpperCase()+i.substring(1).toLowerCase():undefined},1,1);this._functionTable.trim=new c(function(n,t){var i=h.toString(n[0],t);return i&&i.length>0?i.trim():undefined},1,1);this._functionTable.replace=new c(function(n,t){var i=h.toString(n[0],t),r=Math.floor(h.toNumber(n[1],t)),u=Math.floor(h.toNumber(n[2],t)),f=h.toString(n[3],t);return i&&i.length>0&&r>0?i.substring(0,r-1)+f+i.slice(r-1+u):undefined},4,4);this._functionTable.substitute=new c(function(n,t){var i=h.toString(n[0],t),r=h.toString(n[1],t),f=h.toString(n[2],t),u;return i&&i.length>0&&r&&r.length>0?(u=new RegExp(r,'g'),i.replace(u,f)):undefined},3,3);this._functionTable.rept=new c(function(n,t){var i=h.toString(n[0],t),f=Math.floor(h.toNumber(n[1],t)),r='',u;if(i&&i.length>0&&f>0)for(u=0;u<f;u++)r=r.concat(i);return r},2,2);this._functionTable.text=new c(function(n,t){var f=n[0].evaluate(),u=h.toString(n[1],t);return!!u&&u.indexOf('#')>-1&&(u=r.Workbook.fromXlsxFormat(u)[0]),i.Globalize.format(f,u)},2,2);this._functionTable.value=new c(function(n,t){return h.toNumber(n[0],t)},1,1)},n.prototype._registerDateFunction=function(){this._functionTable.now=new c(function(){return{value:new Date,format:'M/d/yyyy h:mm'}},0,0);this._functionTable.today=new c(function(){var n=new Date;return{value:new Date(n.getFullYear(),n.getMonth(),n.getDate()),format:'d'}},0,0);this._functionTable.year=new c(function(n,t){var r=h.toDate(n[0],t);return!i.isPrimitive(r)&&r?r.value:i.isDate(r)?r.getFullYear():1900},1,1);this._functionTable.month=new c(function(n,t){var r=h.toDate(n[0],t);return!i.isPrimitive(r)&&r?r.value:i.isDate(r)?r.getMonth()+1:1},1,1);this._functionTable.day=new c(function(n,t){var r=h.toDate(n[0],t);return!i.isPrimitive(r)&&r?r.value:i.isDate(r)?r.getDate():0},1,1);this._functionTable.hour=new c(function(n,t){var r=n[0].evaluate(t);if(i.isNumber(r)&&!isNaN(r))return Math.floor(24*(r-Math.floor(r)));if(i.isDate(r)||(r=h.toDate(n[0],t),!i.isPrimitive(r)&&r&&(r=r.value),i.isDate(r)))return r.getHours();throw'Invalid parameter.';},1,1);this._functionTable.time=new c(function(n,t){var r=n[0].evaluate(t),u=n[1].evaluate(t),f=n[2].evaluate(t);if(i.isNumber(r)&&i.isNumber(u)&&i.isNumber(f))return r%=24,u%=60,f%=60,{value:new Date(0,0,0,r,u,f),format:'t'};throw'Invalid parameters.';},3,3);this._functionTable.date=new c(function(n,t){var r=n[0].evaluate(t),u=n[1].evaluate(t),f=n[2].evaluate(t);if(i.isNumber(r)&&i.isNumber(u)&&i.isNumber(f))return{value:new Date(r,u-1,f),format:'d'};throw'Invalid parameters.';},3,3);this._functionTable.datedif=new c(function(n,t){var u=h.toDate(n[0],t),r=h.toDate(n[1],t),l=n[2].evaluate(t),s,c,e,f,o;if(!i.isPrimitive(u)&&u&&(u=u.value),!i.isPrimitive(r)&&r&&(r=r.value),i.isDate(u)&&i.isDate(r)&&i.isString(l)){if(s=u.getTime(),c=r.getTime(),s>c)throw'Start date is later than end date.';e=r.getDate()-u.getDate();f=r.getMonth()-u.getMonth();o=r.getFullYear()-u.getFullYear();switch(l.toUpperCase()){case'Y':return f>0?o:f<0?o-1:e>=0?o:o-1;case'M':return e>=0?o*12+f:o*12+f-1;case'D':return(c-s)/864e5;case'YM':return f=e>=0?o*12+f:o*12+f-1,f%12;case'YD':return f>0?(new Date(u.getFullYear(),r.getMonth(),r.getDate()).getTime()-u.getTime())/864e5:f<0?(new Date(u.getFullYear()+1,r.getMonth(),r.getDate()).getTime()-u.getTime())/864e5:e>=0?e:(new Date(u.getFullYear()+1,r.getMonth(),r.getDate()).getTime()-u.getTime())/864e5;case'MD':return e>=0?e:new Date(r.getFullYear(),r.getMonth(),0).getDate()-new Date(r.getFullYear(),r.getMonth()-1,1).getDate()+1+e;default:throw'Invalid unit.';}}throw'Invalid parameters.';},3,3)},n.prototype._registLookUpReferenceFunction=function(){var n=this;n._functionTable.column=new c(function(t,i,r,u){var f;if(t==null)return u+1;if(f=t[0],f=n._ensureNonFunctionExpression(f),f instanceof y)return f.cells.col+1;throw'Invalid Cell Reference.';},1,0);n._functionTable.columns=new c(function(t){var i=t[0];if(i=n._ensureNonFunctionExpression(i),i instanceof y)return i.cells.columnSpan;throw'Invalid Cell Reference.';},1,1);n._functionTable.row=new c(function(t,i,r){var u;if(t==null)return r+1;if(u=t[0],u=n._ensureNonFunctionExpression(u),u instanceof y)return u.cells.row+1;throw'Invalid Cell Reference.';},1,0);n._functionTable.rows=new c(function(t){var i=t[0];if(i=n._ensureNonFunctionExpression(i),i instanceof y)return i.cells.rowSpan;throw'Invalid Cell Reference.';},1,1);n._functionTable.choose=new c(function(n,t){var i=h.toNumber(n[0],t);if(isNaN(i))throw'Invalid index number.';if(i<1||i>=n.length)throw'The index number is out of the list range.';return n[i].evaluate(t)},255,2);n._functionTable.index=new c(function(t,i){var o=t[0],r,f=h.toNumber(t[1],i),e=t[2]!=null?h.toNumber(t[2],i):0;if(isNaN(f)||f<0)throw'Invalid Row Number.';if(isNaN(e)||e<0)throw'Invalid Column Number.';if(o=n._ensureNonFunctionExpression(o),o instanceof y){if(r=o.cells,f>r.rowSpan||e>r.columnSpan)throw'Index is out of the cell range.';if(f>0&&e>0)return n._owner.getCellValue(r.topRow+f-1,r.leftCol+e-1,!0,i);if(f===0&&e===0)return o;if(f===0)return new y(new u.CellRange(r.topRow,r.leftCol+e-1,r.bottomRow,r.leftCol+e-1),o.sheetRef,n._owner);if(e===0)return new y(new u.CellRange(r.topRow+f-1,r.leftCol,r.topRow+f-1,r.rightCol),o.sheetRef,n._owner)}throw'Invalid Cell Reference.';},4,2);n._functionTable.hlookup=new c(function(t,i){return n._handleHLookup(t,i)},4,3)},n.prototype._registFinacialFunction=function(){var n=this;n._functionTable.rate=new c(function(t,i){var r=n._calculateRate(t,i);return{value:r,format:'p2'}},6,3)},n.prototype._addToken=function(n,t,i){var r=new k(n,t,i);this._tokenTable[n]=r},n.prototype._parseExpression=function(){return this._getToken(),this._parseCompareOrConcat()},n.prototype._parseCompareOrConcat=function(){for(var n=this._parseAddSub(),t,i;this._token.tokenType===a.COMPARE||this._token.tokenType===a.CONCAT;)t=this._token,this._getToken(),i=this._parseAddSub(),n=new nt(t,n,i);return n},n.prototype._parseAddSub=function(){for(var n=this._parseMulDiv(),t,i;this._token.tokenType===a.ADDSUB;)t=this._token,this._getToken(),i=this._parseMulDiv(),n=new nt(t,n,i);return n},n.prototype._parseMulDiv=function(){for(var n=this._parsePower(),t,i;this._token.tokenType===a.MULDIV;)t=this._token,this._getToken(),i=this._parsePower(),n=new nt(t,n,i);return n},n.prototype._parsePower=function(){for(var n=this._parseUnary(),t,i;this._token.tokenType===a.POWER;)t=this._token,this._getToken(),i=this._parseUnary(),n=new nt(t,n,i);return n},n.prototype._parseUnary=function(){var n,t;return this._token.tokenID===l.ADD||this._token.tokenID===l.SUB?(n=this._token,this._getToken(),t=this._parseAtom(),new bt(n,t)):this._parseAtom()},n.prototype._parseAtom=function(){var n=null,r,t,u,o,e,i,c,v,p,f,s,w;switch(this._token.tokenType){case a.LITERAL:n=new h(this._token);break;case a.IDENTIFIER:if(r=this._token.value.toString().toLowerCase(),t=this._functionTable[r],t){if(u=this._getParameters(),o=u?u.length:0,t.paramMin!==-1&&o<t.paramMin)throw'Too few parameters.';if(t.paramMax!==-1&&o>t.paramMax)throw'Too many parameters.';n=new st(t,u,r!=='rand');break}if(f=r.split('!'),f.length===2?(w=f[0],s=f[1]):s=f[0],i=this._getDefinedName(s),i)if(i.sheetName&&i.sheetName!==this._owner.selectedSheet.name&&i.sheetName.toLowerCase()!==w)throw'The defined name item works in '+i.sheetName+'.  It does not work in current sheet.';else{p=this._pointer;v=this._expressLength;c=this._expression;this._pointer=0;n=this._checkCache(i.value);this._pointer=p;this._expressLength=v;this._expression=c;break}if(e=this._getCellRange(r),e){n=new y(e.cellRange,e.sheetRef,this._owner);break}u=this._getParameters();n=this.onUnknownFunction(r,u);break;case a.GROUP:if(this._token.tokenID!==l.OPEN)throw'Expression expected.';if(this._getToken(),n=this._parseCompareOrConcat(),this._token.tokenID!==l.CLOSE)throw'Unbalanced parenthesis.';}if(n===null)throw'';return this._getToken(),n},n.prototype._getToken=function(){for(var t,n,o,u,f,e='',i='',s=new RegExp('[\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\uff00-\uff9f\u4e00-\u9faf\u3400-\u4dbf]'),r;this._pointer<this._expressLength&&this._expression[this._pointer]===' ';)this._pointer++;if(this._pointer>=this._expressLength){this._token=new k(null,l.END,a.GROUP);return}if(n=this._expression[this._pointer],u=n>='a'&&n<='z'||n>='A'&&n<='Z'||s.test(n),f=n>='0'&&n<='9'||n=='.',!u&&!f&&(r=this._tokenTable[n],r)){this._token=r;this._pointer++;this._pointer<this._expressLength&&(n==='>'||n==='<')&&(r=this._tokenTable[this._expression.substring(this._pointer-1,this._pointer+1)],r&&(this._token=r,this._pointer++));return}if(f){this._parseDigit();return}if(n==='\"'){this._parseString();return}if(n!=='\''||(i=this._parseSheetRef(),i)){if(n==='#'){this._parseDate();return}if(!u&&n!=='_'&&this._idChars.indexOf(n)<0&&!i)throw'Identifier expected.';for(t=1;t+this._pointer<this._expressLength;t++){if(n=this._expression[this._pointer+t],u=n>='a'&&n<='z'||n>='A'&&n<='Z'||s.test(n),f=n>='0'&&n<='9',n==='\''&&o===':'){e=i+this._expression.substring(this._pointer,this._pointer+t);this._pointer+=t;i=this._parseSheetRef();t=0;continue}if(o=n,!u&&!f&&n!=='_'&&this._idChars.indexOf(n)<0)break}e+=i+this._expression.substring(this._pointer,this._pointer+t);this._pointer+=t;this._token=new k(e,l.ATOM,a.IDENTIFIER)}},n.prototype._parseDigit=function(){for(var i=-1,u=!1,f=!1,r=0,n,e,t=0;t+this._pointer<this._expressLength;t++){if(n=this._expression[this._pointer+t],n>='0'&&n<='9'){r=r*10+(+n-0);i>-1&&(i*=10);continue}if(n==='.'&&i<0){i=1;continue}if((n==='E'||n==='e')&&!u){u=!0;n=this._expression[this._pointer+t+1];(n==='+'||n==='-')&&t++;continue}if(n==='%'){f=!0;t++;break}break}u?(e=this._expression.substring(this._pointer,this._pointer+t),r=+e):(i>1&&(r/=i),f&&(r/=100));this._token=new k(r,l.ATOM,a.LITERAL);this._pointer+=t},n.prototype._parseString=function(){for(var t,i,r,n=1;n+this._pointer<this._expressLength;n++)if(t=this._expression[this._pointer+n],t==='\"'){if(i=n+this._pointer<this._expressLength-1?this._expression[this._pointer+n+1]:' ',i!=='\"')break;n++}if(t!=='\"')throw'Can\'t find final quote.';if(r=this._expression.substring(this._pointer+1,this._pointer+n),this._pointer+=n+1,this._expression[this._pointer]==='!')throw'Illegal cross sheet reference.';this._token=new k(r.replace('\"\"','\"'),l.ATOM,a.LITERAL)},n.prototype._parseDate=function(){for(var t,i,n=1;n+this._pointer<this._expressLength;n++)if(t=this._expression[this._pointer+n],t==='#')break;if(t!=='#')throw'Can\'t find final date delimiter ("#").';i=this._expression.substring(this._pointer+1,this._pointer+n);this._pointer+=n+1;this._token=new k(Date.parse(i),l.ATOM,a.LITERAL)},n.prototype._parseSheetRef=function(){for(var t,i,r,n=1;n+this._pointer<this._expressLength;n++)if(t=this._expression[this._pointer+n],t==='\''){if(i=n+this._pointer<this._expressLength-1?this._expression[this._pointer+n+1]:' ',i!=='\'')break;n++}if(t!=='\'')throw'Can\'t find final quote.';return r=this._expression.substring(this._pointer+1,this._pointer+n),this._pointer+=n+1,this._expression[this._pointer]==='!'?r.replace(/\'\'/g,'\''):''},n.prototype._getCellRange=function(n){var i,r,u,t,f;if(n&&(i=n.split(':'),i.length>0&&i.length<3&&(r=this._parseCell(i[0]),t=r.cellRange,t&&i.length===2))){if(u=this._parseCell(i[1]),f=u.cellRange,r.sheetRef&&!u.sheetRef&&(u.sheetRef=r.sheetRef),r.sheetRef!==u.sheetRef)throw'The cell reference must be in the same sheet!';f?(t.col2=f.col,t.row2=f.row):t=null}return t==null?null:{cellRange:t,sheetRef:r.sheetRef}},n.prototype._parseCellRange=function(n){for(var r=-1,f=-1,e=!1,o=!1,t,i=0;i<n.length;i++){if(t=n[i],t==='$'&&!e){e=!0;continue}if(!(t>='a'&&t<='z')&&!(t>='A'&&t<='Z'))break;r<0&&(r=0);r=26*r+(t.toUpperCase().charCodeAt(0)-'A'.charCodeAt(0)+1)}for(;i<n.length;i++){if(t=n[i],t==='$'&&!o){o=!0;continue}if(!(t>='0'&&t<='9'))break;f<0&&(f=0);f=10*f+(+t-0)}return(i<n.length&&(f=r=-1),f===-1||r===-1)?null:new u.CellRange(f-1,r-1)},n.prototype._parseCell=function(n){var r,t,i,u;if(t=n.lastIndexOf('!'),t>0&&t<n.length-1)u=n.substring(0,t),i=n.substring(t+1);else if(t<=0)i=n;else return null;return r=this._parseCellRange(i),{cellRange:r,sheetRef:u}},n.prototype._getParameters=function(){var i=this._pointer,r=this._token,n,t;if(this._getToken(),this._token.tokenID!==l.OPEN)return this._pointer=i,this._token=r,null;if(i=this._pointer,this._getToken(),this._token.tokenID===l.CLOSE)return null;for(this._pointer=i,n=[],t=this._parseExpression(),n.push(t);this._token.tokenID===l.COMMA;)t=this._parseExpression(),n.push(t);if(this._token.tokenID!==l.CLOSE)throw'Syntax error.';return n},n.prototype._getAggregateResult=function(n,t,r){var f=this._getItemList(t,r),u;return u=i.getAggregate(n,f.items),f.isDate&&(u=new Date(u)),u},n.prototype._getFlexSheetAggregateResult=function(n,t,i){var r,u,f,e;switch(n){case p.Count:return r=this._getItemList(t,i,!0,!1),this._countNumberCells(r.items);case p.CountA:return r=this._getItemList(t,i,!1,!1),r.items.length;case p.ConutBlank:return r=this._getItemList(t,i,!1,!0),this._countBlankCells(r.items);case p.Rank:if(f=h.toNumber(t[0],i),e=t[2]?h.toNumber(t[2],i):0,isNaN(f))throw'Invalid number.';if(isNaN(e))throw'Invalid order.';if(t[1]=this._ensureNonFunctionExpression(t[1]),t[1]instanceof y)return r=this._getItemList([t[1]],i),this._getRankOfCellRange(f,r.items,e);throw'Invalid Cell Reference.';case p.CountIf:if(t[0]=this._ensureNonFunctionExpression(t[0]),t[0]instanceof y)return r=this._getItemList([t[0]],i,!1),this._countCellsByCriterias([r.items],[t[1]],i);throw'Invalid Cell Reference.';case p.CountIfs:return this._handleCountIfs(t,i);case p.SumIf:if(t[0]=this._ensureNonFunctionExpression(t[0]),t[0]instanceof y)return r=this._getItemList([t[0]],i,!1),t[2]=this._ensureNonFunctionExpression(t[2]),t[2]!=null&&t[2]instanceof y&&(u=this._getItemList([t[2]],i)),this._sumCellsByCriterias([r.items],[t[1]],u?u.items:null,i);throw'Invalid Cell Reference.';case p.SumIfs:return this._handleSumIfs(t,i);case p.Product:return r=this._getItemList(t,i),this._getProductOfNumbers(r.items)}throw'Invalid aggregate type.';},n.prototype._getItemList=function(n,t,i,r,u,f){i===void 0&&(i=!0);r===void 0&&(r=!1);u===void 0&&(u=!0);for(var c=[],e,a,v,o,s=!0,l=0;l<n.length;l++)if(o=n[l],o=this._ensureNonFunctionExpression(o),o instanceof y){v=o.getValues(u,f,t);n:for(a=0;a<v.length;a++)(e=v[a],r||e!=null&&e!=='')&&(s=s&&e instanceof Date,e=i?+e:e,c.push(e))}else{if(e=o instanceof h?o.evaluate(t):o,!r&&(e==null||e===''))continue;s=s&&e instanceof Date;e=i?+e:e;c.push(e)}return c.length===0&&(s=!1),{isDate:s,items:c}},n.prototype._countBlankCells=function(n){for(var r=0,u=0,t;r<n.length;r++)t=n[r],(t==null||i.isString(t)&&t===''||i.isNumber(t)&&isNaN(t))&&u++;return u},n.prototype._countNumberCells=function(n){for(var r=0,u=0,t;r<n.length;r++)t=n[r],t!=null&&i.isNumber(t)&&!isNaN(t)&&u++;return u},n.prototype._getRankOfCellRange=function(n,t,i){i===void 0&&(i=0);var r=0,f=0,u;for(i?t.sort(function(n,t){return isNaN(n)||isNaN(t)?-1:n-t}):t.sort(function(n,t){return isNaN(n)||isNaN(t)?1:t-n});r<t.length;r++)if((u=t[r],!isNaN(u))&&(f++,n===u))return f;throw n+' is not in the cell range.';},n.prototype._handleCountIfs=function(n,t){var r=0,u=[],f=[],e,i,o,s;if(n.length%2!=0)throw'Invalid params.';for(;r<n.length/2;r++)if(i=n[2*r],i=this._ensureNonFunctionExpression(i),i instanceof y){if(r===0)if(i.cells)o=i.cells.rowSpan,s=i.cells.columnSpan;else throw'Invalid Cell Reference.';else if(i.cells){if(i.cells.rowSpan!==o||i.cells.columnSpan!==s)throw'The row span and column span of each cell range has to be same with each other.';}else throw'Invalid Cell Reference.';e=this._getItemList([i],t,!1);u[r]=e.items;f[r]=n[2*r+1]}else throw'Invalid Cell Reference.';return this._countCellsByCriterias(u,f,t)},n.prototype._countCellsByCriterias=function(n,t,r,u){for(var c=0,e=0,a=0,p=n[0].length,v=[],o,l,y,s,f;e<t.length;e++){if(f=h.toString(t[e],r),f.length===0)throw'Invalid Criteria.';f==='*'?v.push(f):v.push(this._parseRightExpr(f))}for(;c<p;c++){o=!1;n:for(e=0;e<n.length;e++)if(y=n[e],s=y[c],f=v[e],typeof f=='string'){if(f!=='*'&&(s==null||s==='')){o=!1;break n}if(o=f==='*'||this.evaluate(this._combineExpr(s,f),null,r),!o)break n}else if(o=o=f.reg.test(s.toString())===f.checkMathces,!o)break n;o&&(u?(l=u[c],l!=null&&i.isNumber(l)&&!isNaN(l)&&a++):a++)}return a},n.prototype._handleSumIfs=function(n,t){var u=1,f=[],e=[],o,s,i,r,h,c;if(n.length%2!=1)throw'Invalid params.';if(i=n[0],i=this._ensureNonFunctionExpression(i),i instanceof y){if(i.cells)h=i.cells.rowSpan,c=i.cells.columnSpan;else throw'Invalid Sum Cell Reference.';s=this._getItemList([i],t)}else throw'Invalid Sum Cell Reference.';for(;u<(n.length+1)/2;u++)if(r=n[2*u-1],r=this._ensureNonFunctionExpression(r),r instanceof y){if(r.cells){if(r.cells.rowSpan!==h||r.cells.columnSpan!==c)throw'The row span and column span of each cell range has to be same with each other.';}else throw'Invalid Criteria Cell Reference.';o=this._getItemList([r],t,!1);f[u-1]=o.items;e[u-1]=n[2*u]}else throw'Invalid Criteria Cell Reference.';return this._sumCellsByCriterias(f,e,s.items,t)},n.prototype._sumCellsByCriterias=function(n,t,r,u){var c=0,e=0,v=0,l,p=n[0].length,a=[],o,y,s,f;for(r==null&&(r=n[0]);e<t.length;e++){if(f=h.toString(t[e],u),f.length===0)throw'Invalid Criteria.';f==='*'?a.push(f):a.push(this._parseRightExpr(f))}for(;c<p;c++){o=!1;l=r[c];n:for(e=0;e<n.length;e++)if(y=n[e],s=y[c],f=a[e],typeof f=='string'){if(f!=='*'&&(s==null||s==='')){o=!1;break n}if(o=f==='*'||this.evaluate(this._combineExpr(s,f),null,u),!o)break n}else if(o=f.reg.test(s.toString())===f.checkMathces,!o)break n;o&&i.isNumber(l)&&!isNaN(l)&&(v+=l)}return v},n.prototype._getProductOfNumbers=function(n){var t,r=0,u=1,f=!1;if(n)for(;r<n.length;r++)t=n[r],i.isNumber(t)&&!isNaN(t)&&(u*=t,f=!0);return f?u:0},n.prototype._handleSubtotal=function(n,t){var r,f,u,e,o=!0;if(r=h.toNumber(n[0],t),r>=1&&r<=11||r>=101&&r<=111){r>=101&&r<=111&&(o=!1);r=i.asEnum(r,v);f=this._getItemList(n.slice(1),t,!0,!1,o);switch(r){case v.Count:case v.CountWithoutHidden:return this._countNumberCells(f.items);case v.CountA:case v.CountAWithoutHidden:return f.items.length;case v.Product:case v.ProductWithoutHidden:return this._getProductOfNumbers(f.items);case v.Average:case v.AverageWithoutHidden:u=i.Aggregate.Avg;break;case v.Max:case v.MaxWithoutHidden:u=i.Aggregate.Max;break;case v.Min:case v.MinWithoutHidden:u=i.Aggregate.Min;break;case v.Std:case v.StdWithoutHidden:u=i.Aggregate.Std;break;case v.StdPop:case v.StdPopWithoutHidden:u=i.Aggregate.StdPop;break;case v.Sum:case v.SumWithoutHidden:u=i.Aggregate.Sum;break;case v.Var:case v.VarWithoutHidden:u=i.Aggregate.Var;break;case v.VarPop:case v.VarPopWithoutHidden:u=i.Aggregate.VarPop}return e=i.getAggregate(u,f.items),f.isDate&&(e=new Date(e)),e}throw'Invalid Subtotal function.';},n.prototype._handleDCount=function(n,t){var i=n[0],r=n[2],f,e,u;if(i=this._ensureNonFunctionExpression(i),r=this._ensureNonFunctionExpression(r),i instanceof y&&r instanceof y&&(f=n[1].evaluate(t),e=this._getColumnIndexByField(i,f),u=this._getItemList([i],t,!0,!1,!0,e),u.items&&u.items.length>1))return this._DCountWithCriterias(u.items.slice(1),i,r);throw'Invalid Count Cell Reference.';},n.prototype._DCountWithCriterias=function(n,t,i){var r=i.cells,v=0,s,c,y,f,u,p,e,w,o,l,a;if(s=this._getSheet(t.sheetRef),c=this._getSheet(i.sheetRef),r.rowSpan>1){for(y=r.topRow,f=r.bottomRow;f>r.topRow;f--){for(l=[],a=[],u=r.leftCol;u<=r.rightCol;u++)if(e=this._owner.getCellValue(f,u,!1,c),e!=null&&e!=='')if(a.push(new h(e)),w=this._owner.getCellValue(y,u,!1,c),p=this._getColumnIndexByField(t,w),o=this._getItemList([t],s,!1,!1,!0,p),o.items!=null&&o.items.length>1)l.push(o.items.slice(1));else throw'Invalid Count Cell Reference.';v+=this._countCellsByCriterias(l,a,s,n)}return v}throw'Invalid Criteria Cell Reference.';},n.prototype._getColumnIndexByField=function(n,t){var r,o,f,u,e;if(r=n.cells,e=r.topRow,e===-1)throw'Invalid Count Cell Reference.';if(i.isInt(t)&&!isNaN(t)){if(t>=1&&t<=r.columnSpan)return r.leftCol+t-1}else for(o=this._getSheet(n.sheetRef),f=r.leftCol;f<=r.rightCol;f++)if(u=this._owner.getCellValue(e,f,!1,o),t=i.isString(t)?t.toLowerCase():t,u=i.isString(u)?u.toLowerCase():u,t===u)return f;throw'Invalid field.';},n.prototype._getSumProduct=function(n,t){var f,e=0,i=this._getItemListForSumProduct(n,t),o,s,r,u;if(i.length>0)for(o=i[0].length,s=i.length,r=0;r<o;r++){for(f=1,u=0;u<s;u++)f*=i[u][r];e+=f}return e},n.prototype._getItemListForSumProduct=function(n,t){for(var o=[[]],u,f,e,s,i,r=0;r<n.length;r++){if(i=n[r],u=[],i=this._ensureNonFunctionExpression(i),i instanceof y)for(s=i.getValues(!0,null,t),e=0;e<s.length;e++)f=s[e],u.push(+f);else f=i instanceof h?i.evaluate(t):i,u.push(+f);if(r>0&&u.length!==o[0].length)throw'The cell ranges of the sumProduct formula must have the same dimensions.';o[r]=u}return o},n.prototype._getSheet=function(n){var t=0,i;if(n)for(;t<this._owner.sheets.length;t++)if(i=this._owner.sheets[t],i.name===n)break;return i},n.prototype._parseRightExpr=function(n){var t,r,i=!1;if(n.indexOf('?')>-1||n.indexOf('*')>-1){if(t=n.match(/([\?\*]*)(\w+)([\?\*]*)(\w+)([\?\*]*)/),t!=null&&t.length===6)r=new RegExp('^'+(t[1].length>0?this._parseRegCriteria(t[1]):'')+t[2]+(t[3].length>0?this._parseRegCriteria(t[3]):'')+t[4]+(t[5].length>0?this._parseRegCriteria(t[5]):'')+'$','i');else throw'Invalid Criteria.';return/^[<>=]/.test(n)?n.trim()[0]==='='&&(i=!0):i=!0,{reg:r,checkMathces:i}}if(isNaN(+n))if(/^\w/.test(n))n='="'+n+'"';else if(/^[<>=]{1,2}\s*-?\w+$/.test(n))n=n.replace(/([<>=]{1,2})\s*(-?\w+)/,'$1"$2"');else throw'Invalid Criteria.';else n='='+n;return n},n.prototype._combineExpr=function(n,t){return i.isString(n)&&(n='"'+n+'"'),n='='+n,n+t},n.prototype._parseRegCriteria=function(n){for(var i=0,t=0,r='';i<n.length;i++)n[i]==='*'?(t>0&&(r+='\\w{'+t+'}',t=0),r+='\\w*'):n[i]==='?'&&t++;return t>0&&(r+='\\w{'+t+'}'),r},n.prototype._calculateRate=function(n,t){var v=1e-7,w=20,p=0,b=0,y,i,r,f,e,o,c,k,a,u,l,s;for(r=h.toNumber(n[0],t),f=h.toNumber(n[1],t),e=h.toNumber(n[2],t),o=n[3]!=null?h.toNumber(n[3],t):0,c=n[4]!=null?h.toNumber(n[4],t):0,k=n[5]!=null?h.toNumber(n[5],t):.1,i=k,Math.abs(i)<v?a=e*(1+r*i)+f*(1+i*c)*r+o:(u=Math.exp(r*Math.log(1+i)),a=e*u+f*(1/i+c)*(u-1)+o),l=e+f*r+o,s=e*u+f*(1/i+c)*(u-1)+o,y=i;Math.abs(l-s)>v&&p<w;)i=(s*b-l*y)/(s-l),b=y,y=i,Math.abs(i)<v?a=e*(1+r*i)+f*(1+i*c)*r+o:(u=Math.exp(r*Math.log(1+i)),a=e*u+f*(1/i+c)*(u-1)+o),l=s,s=a,++p;if(Math.abs(l-s)>v&&p===w)throw'It is not able to calculate the rate with current parameters.';return i},n.prototype._handleHLookup=function(n,t){var u=n[0].evaluate(t),f=n[1],e=h.toNumber(n[2],t),o=n[3]!=null?h.toBoolean(n[3],t):!0,i,r;if(u==null||u=='')throw'Invalid lookup value.';if(isNaN(e)||e<0)throw'Invalid row index.';if(f=this._ensureNonFunctionExpression(f),f instanceof y){if(i=f.cells,e>i.rowSpan)throw'Row index is out of the cell range.';if(o?(r=this._exactMatch(u,i,t,!1),r===-1&&(r=this._approximateMatch(u,i,t))):r=this._exactMatch(u,i,t),r===-1)throw'Lookup Value is not found.';return this._owner.getCellValue(i.topRow+e-1,r,!1,t)}throw'Invalid Cell Reference.';},n.prototype._exactMatch=function(n,t,r,u){u===void 0&&(u=!0);var h=t.topRow,e,o,f,s;if(i.isString(n)&&(n=n.toLowerCase()),u&&i.isString(n)&&(n.indexOf('?')>-1||n.indexOf('*')>-1))if(f=n.match(/([\?\*]*)(\w+)([\?\*]*)(\w+)([\?\*]*)/),f!=null&&f.length===6)s=new RegExp('^'+(f[1].length>0?this._parseRegCriteria(f[1]):'')+f[2]+(f[3].length>0?this._parseRegCriteria(f[3]):'')+f[4]+(f[5].length>0?this._parseRegCriteria(f[5]):'')+'$','i');else throw'Invalid lookup value.';for(e=t.leftCol;e<=t.rightCol;e++)if(o=this._owner.getCellValue(h,e,!1,r),s!=null){if(s.test(o))return e}else if(i.isString(o)&&(o=o.toLowerCase()),n===o)return e;return-1},n.prototype._approximateMatch=function(n,t,r){var u,f,s=t.topRow,e=[],o=0;for(i.isString(n)&&(n=n.toLowerCase()),f=t.leftCol;f<=t.rightCol;f++)u=this._owner.getCellValue(s,f,!1,r),u=isNaN(+u)?u:+u,e.push({value:u,index:f});for(e.sort(function(n,t){return(i.isString(n.value)&&(n.value=n.value.toLowerCase()),i.isString(t.value)&&(t.value=t.value.toLowerCase()),n.value>t.value)?-1:n.value===t.value?t.index-n.index:1});o<e.length;o++)if(u=e[o],i.isString(u.value)&&(u.value=u.value.toLowerCase()),n>u.value)return u.index;throw'Lookup Value is not found.';},n.prototype._checkCache=function(n){var t=this._expressionCache[n];return t?t:(t=this._parse(n),this._cacheSize>1e4&&this._clearExpressionCache(),this._expressionCache[n]=t,this._cacheSize++,t)},n.prototype._ensureNonFunctionExpression=function(n,t){while(n instanceof st)n=n.evaluate(t);return n},n.prototype._getDefinedName=function(n){for(var t,i=0;i<this._owner.definedNames.length;i++)if(t=this._owner.definedNames[i],t.name.toLowerCase()===n)return t;return null},n}();t._CalcEngine=wt;k=function(){function n(n,t,i){this._value=n;this._tokenID=t;this._tokenType=i}return Object.defineProperty(n.prototype,"value",{get:function(){return this._value},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"tokenID",{get:function(){return this._tokenID},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"tokenType",{get:function(){return this._tokenType},enumerable:!0,configurable:!0}),n}();t._Token=k;c=function(){function n(n,t,r){this._paramMax=Number.MAX_VALUE;this._paramMin=Number.MIN_VALUE;this._func=n;i.isNumber(t)&&!isNaN(t)&&(this._paramMax=t);i.isNumber(r)&&!isNaN(r)&&(this._paramMin=r)}return Object.defineProperty(n.prototype,"paramMax",{get:function(){return this._paramMax},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"paramMin",{get:function(){return this._paramMin},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"func",{get:function(){return this._func},enumerable:!0,configurable:!0}),n}();t._FunctionDefinition=c,function(n){n[n.COMPARE=0]="COMPARE";n[n.ADDSUB=1]="ADDSUB";n[n.MULDIV=2]="MULDIV";n[n.POWER=3]="POWER";n[n.CONCAT=4]="CONCAT";n[n.GROUP=5]="GROUP";n[n.LITERAL=6]="LITERAL";n[n.IDENTIFIER=7]="IDENTIFIER"}(a=t._TokenType||(t._TokenType={})),function(n){n[n.GT=0]="GT";n[n.LT=1]="LT";n[n.GE=2]="GE";n[n.LE=3]="LE";n[n.EQ=4]="EQ";n[n.NE=5]="NE";n[n.ADD=6]="ADD";n[n.SUB=7]="SUB";n[n.MUL=8]="MUL";n[n.DIV=9]="DIV";n[n.DIVINT=10]="DIVINT";n[n.MOD=11]="MOD";n[n.POWER=12]="POWER";n[n.CONCAT=13]="CONCAT";n[n.OPEN=14]="OPEN";n[n.CLOSE=15]="CLOSE";n[n.END=16]="END";n[n.COMMA=17]="COMMA";n[n.PERIOD=18]="PERIOD";n[n.ATOM=19]="ATOM"}(l=t._TokenID||(t._TokenID={})),function(n){n[n.Count=0]="Count";n[n.CountA=1]="CountA";n[n.ConutBlank=2]="ConutBlank";n[n.CountIf=3]="CountIf";n[n.CountIfs=4]="CountIfs";n[n.Rank=5]="Rank";n[n.SumIf=6]="SumIf";n[n.SumIfs=7]="SumIfs";n[n.Product=8]="Product"}(p||(p={})),function(n){n[n.Average=1]="Average";n[n.Count=2]="Count";n[n.CountA=3]="CountA";n[n.Max=4]="Max";n[n.Min=5]="Min";n[n.Product=6]="Product";n[n.Std=7]="Std";n[n.StdPop=8]="StdPop";n[n.Sum=9]="Sum";n[n.Var=10]="Var";n[n.VarPop=11]="VarPop";n[n.AverageWithoutHidden=101]="AverageWithoutHidden";n[n.CountWithoutHidden=102]="CountWithoutHidden";n[n.CountAWithoutHidden=103]="CountAWithoutHidden";n[n.MaxWithoutHidden=104]="MaxWithoutHidden";n[n.MinWithoutHidden=105]="MinWithoutHidden";n[n.ProductWithoutHidden=106]="ProductWithoutHidden";n[n.StdWithoutHidden=107]="StdWithoutHidden";n[n.StdPopWithoutHidden=108]="StdPopWithoutHidden";n[n.SumWithoutHidden=109]="SumWithoutHidden";n[n.VarWithoutHidden=110]="VarWithoutHidden";n[n.VarPopWithoutHidden=111]="VarPopWithoutHidden"}(v||(v={}));h=function(){function n(n){this._token=n?n instanceof k?n:new k(n,l.ATOM,a.LITERAL):new k(null,l.ATOM,a.IDENTIFIER)}return Object.defineProperty(n.prototype,"token",{get:function(){return this._token},enumerable:!0,configurable:!0}),n.prototype.evaluate=function(){if(this._token.tokenType!==a.LITERAL)throw'Bad expression.';return this._token.value},n.toString=function(n,t){var r=n.evaluate(t);return i.isPrimitive(r)||(r=r.value),r!=null?r.toString():''},n.toNumber=function(n,t){var r=n.evaluate(t);return(i.isPrimitive(r)||(r=r.value),i.isNumber(r))?r:i.isBoolean(r)?r?1:0:i.isDate(r)?this._toOADate(r):i.isString(r)?r?+r:0:i.changeType(r,i.DataType.Number,'')},n.toBoolean=function(n,t){var r=n.evaluate(t);return(i.isPrimitive(r)||(r=r.value),i.isBoolean(r))?r:i.isNumber(r)?r===0?!1:!0:i.changeType(r,i.DataType.Boolean,'')},n.toDate=function(n,t){var r=n.evaluate(t);return(i.isPrimitive(r)||(r=r.value),i.isDate(r))?r:i.isNumber(r)?this._fromOADate(r):i.changeType(r,i.DataType.Date,'')},n._toOADate=function(n){var t=Date.UTC(1899,11,30),i=Date.UTC(n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds(),n.getMilliseconds());return(i-t)/864e5},n._fromOADate=function(n){var t=Date.UTC(1899,11,30),i=new Date,r=n>=60?0:864e5;return new Date(n*864e5+t+i.getTimezoneOffset()*6e4+r)},n}();t._Expression=h;bt=function(n){function t(t,i){var r=n.call(this,t)||this;return r._expr=i,r}return __extends(t,n),t.prototype.evaluate=function(n){if(this.token.tokenID===l.SUB)return this._evaluatedValue==null&&(this._evaluatedValue=-h.toNumber(this._expr,n)),this._evaluatedValue;if(this.token.tokenID===l.ADD)return this._evaluatedValue==null&&(this._evaluatedValue=+h.toNumber(this._expr,n)),this._evaluatedValue;throw'Bad expression.';},t}(h);t._UnaryExpression=bt;nt=function(n){function t(t,i,r){var u=n.call(this,t)||this;return u._leftExpr=i,u._rightExpr=r,u}return __extends(t,n),t.prototype.evaluate=function(n){var u,f,e,o,t,i,r,s=!1;if(this._evaluatedValue!=null)return this._evaluatedValue;if(u=h.toString(this._leftExpr,n),f=h.toString(this._rightExpr,n),this.token.tokenType===a.CONCAT)return this._evaluatedValue=u+f,this._evaluatedValue;if(e=this._leftExpr.evaluate(n),o=this._rightExpr.evaluate(n),s=this._isDateValue(e)||this._isDateValue(o),t=h.toNumber(this._leftExpr,n),i=h.toNumber(this._rightExpr,n),r=t-i,this.token.tokenType===a.COMPARE)switch(this.token.tokenID){case l.GT:return r>0;case l.LT:return r<0;case l.GE:return r>=0;case l.LE:return r<=0;case l.EQ:return isNaN(r)?(this._evaluatedValue=u.toLowerCase()===f.toLowerCase(),this._evaluatedValue):(this._evaluatedValue=r===0,this._evaluatedValue);case l.NE:return isNaN(r)?(this._evaluatedValue=u.toLowerCase()!==f.toLowerCase(),this._evaluatedValue):(this._evaluatedValue=r!==0,this._evaluatedValue)}switch(this.token.tokenID){case l.ADD:this._evaluatedValue=t+i;break;case l.SUB:this._evaluatedValue=t-i;break;case l.MUL:this._evaluatedValue=t*i;break;case l.DIV:this._evaluatedValue=t/i;break;case l.DIVINT:this._evaluatedValue=Math.floor(t/i);break;case l.MOD:this._evaluatedValue=Math.floor(t%i);break;case l.POWER:i===0&&(this._evaluatedValue=1);i===.5&&(this._evaluatedValue=Math.sqrt(t));i===1&&(this._evaluatedValue=t);i===2&&(this._evaluatedValue=t*t);i===3&&(this._evaluatedValue=t*t*t);i===4&&(this._evaluatedValue=t*t*t*t);this._evaluatedValue=Math.pow(t,i);break;default:this._evaluatedValue=NaN}if(!isNaN(this._evaluatedValue))return s&&(this._evaluatedValue={value:h._fromOADate(this._evaluatedValue),format:e.format||o.format}),this._evaluatedValue;throw'Bad expression.';},t.prototype._isDateValue=function(n){return i.isPrimitive(n)?i.isDate(n):i.isDate(n.value)},t}(h);t._BinaryExpression=nt;y=function(n){function t(t,i,r){var u=n.call(this)||this;return u._cells=t,u._sheetRef=i,u._flex=r,u._evalutingRange={},u}return __extends(t,n),t.prototype.evaluate=function(n){return this._evaluatedValue==null&&(this._evaluatedValue=this._getCellValue(this._cells,n)),this._evaluatedValue},t.prototype.getValues=function(n,t,r){n===void 0&&(n=!0);var e,o=[],s=0,f,t,h,c;if(h=t!=null&&!isNaN(+t)?t:this._cells.leftCol,c=t!=null&&!isNaN(+t)?t:this._cells.rightCol,r=this._getSheet()||r||this._flex.selectedSheet,!r)return null;for(f=this._cells.topRow;f<=this._cells.bottomRow;f++){if(f>=r.grid.rows.length)throw'The cell reference is out of the cell range of the flexsheet.';if(n||r.grid.rows[f].isVisible!==!1)for(t=h;t<=c;t++){if(t>=r.grid.columns.length)throw'The cell reference is out of the cell range of the flexsheet.';(n||r.grid.columns[t].isVisible!==!1)&&(e=this._getCellValue(new u.CellRange(f,t),r),i.isPrimitive(e)||(e=e.value),o[s]=e,s++)}}return o},t.prototype.getValuseWithTwoDimensions=function(n,t){n===void 0&&(n=!0);var e,c=[],s,h=0,o=0,r,f;if(t=this._getSheet()||t||this._flex.selectedSheet,!t)return null;for(r=this._cells.topRow;r<=this._cells.bottomRow;r++){if(r>=t.grid.rows.length)throw'The cell reference is out of the cell range of the flexsheet.';if(!n&&t.grid.rows[r].isVisible===!1){h++;continue}for(s=[],o=0,f=this._cells.leftCol;f<=this._cells.rightCol;f++){if(f>=t.grid.columns.length)throw'The cell reference is out of the cell range of the flexsheet.';if(!n&&t.grid.columns[f].isVisible===!1){o++;continue}e=this._getCellValue(new u.CellRange(r,f),t);i.isPrimitive(e)||(e=e.value);s[o]=e;o++}c[h]=s;h++}return c},Object.defineProperty(t.prototype,"cells",{get:function(){return this._cells},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sheetRef",{get:function(){return this._sheetRef},enumerable:!0,configurable:!0}),t.prototype._getCellValue=function(n,t){var t,i;if(t=this._getSheet()||t||this._flex.selectedSheet,!t)return null;if(i=t.name+':'+n.row+','+n.col+'-'+n.row2+','+n.col2,this._evalutingRange[i])throw'Circular Reference';try{if(this._flex)return this._evalutingRange[i]=!0,this._flex.getCellValue(n.row,n.col,!1,t)}finally{delete this._evalutingRange[i]}},t.prototype._getSheet=function(){var n=0,t;if(!this._sheetRef)return null;for(;n<this._flex.sheets.length;n++)if(t=this._flex.sheets[n],t.name.toLowerCase()===this._sheetRef)return t;throw'Invalid sheet reference';},t}(h);t._CellRangeExpression=y;st=function(n){function t(t,i,r){r===void 0&&(r=!0);var u=n.call(this)||this;return u._funcDefinition=t,u._params=i,u._needCacheEvaluatedVal=r,u}return __extends(t,n),t.prototype.evaluate=function(n,t,i){return this._needCacheEvaluatedVal?(this._evaluatedValue==null&&(this._evaluatedValue=this._funcDefinition.func(this._params,n,t,i)),this._evaluatedValue):this._funcDefinition.func(this._params,n,t,i)},t}(h);t._FunctionExpression=st;b=function(){function n(n){this._owner=n;this._sheetIndex=n.selectedSheetIndex}return Object.defineProperty(n.prototype,"sheetIndex",{get:function(){return this._sheetIndex},enumerable:!0,configurable:!0}),n.prototype.undo=function(){throw'This abstract method must be overridden.';},n.prototype.redo=function(){throw'This abstract method must be overridden.';},n.prototype.saveNewState=function(){throw'This abstract method must be overridden.';},n}();t._UndoAction=b;d=function(n){function t(t,i){var r=this,o,i,f,u,e;for(r=n.call(this,t)||this,r._isPaste=!1,r._selections=i?[i]:t.selectedSheet.selectionRanges.slice(),r._oldValues={},r._mergeAction=new et(t),o=0;o<r._selections.length;o++)for(i=r._selections[o],f=i.topRow;f<=i.bottomRow;f++)for(u=i.leftCol;u<=i.rightCol;u++)e=t.getCellData(f,u,!!t.columns[u].dataMap),e=e==null?'':e,r._oldValues['r'+f+'_c'+u]={row:f,col:u,value:e};return r}return __extends(t,n),Object.defineProperty(t.prototype,"isPaste",{get:function(){return this._isPaste},enumerable:!0,configurable:!0}),t.prototype.undo=function(){var n=this,t,i;n._owner._clearCalcEngine();n._owner.selectedSheet.selectionRanges.clear();n._owner.deferUpdate(function(){for(t=0;t<n._selections.length;t++)i=n._selections[t],n._owner.selectedSheet.selectionRanges.push(i);Object.keys(n._oldValues).forEach(function(t){var i=n._oldValues[t];n._owner.setCellData(i.row,i.col,i.value)});n._mergeAction.undo();n._owner.refresh(!1)})},t.prototype.redo=function(){var n=this,t,i;n._owner._clearCalcEngine();n._owner.selectedSheet.selectionRanges.clear();n._owner.deferUpdate(function(){for(t=0;t<n._selections.length;t++)i=n._selections[t],n._owner.selectedSheet.selectionRanges.push(i);Object.keys(n._newValues).forEach(function(t){var i=n._newValues[t];n._owner.setCellData(i.row,i.col,i.value)});n._mergeAction.redo();n._owner.refresh(!1)})},t.prototype.saveNewState=function(){var u,i,f,t,n,r;for(this._newValues={},u=0;u<this._selections.length;u++)for(i=this._selections[u],t=i.topRow;t<=i.bottomRow;t++)for(n=i.leftCol;n<=i.rightCol;n++){if(f=this._owner.columns[n],!f)return!1;r=this._owner.getCellData(t,n,!!f.dataMap);r=r==null?'':r;this._newValues['r'+t+'_c'+n]={row:t,col:n,value:r}}return this._mergeAction.saveNewState(),!this._checkActionState()},t.prototype.markIsPaste=function(){this._isPaste=!0},t.prototype.updateForPasting=function(n){var t=this._selections[this._selections.length-1],i=this._owner.getCellData(n.row,n.col,!!this._owner.columns[n.col].dataMap);t||(t=this._owner.selection,this._selections=[t]);i=i==null?'':i;this._oldValues['r'+n.row+'_c'+n.col]={row:n.row,col:n.col,value:i};t.row=Math.min(t.topRow,n.topRow);t.row2=Math.max(t.bottomRow,n.bottomRow);t.col=Math.min(t.leftCol,n.leftCol);t.col2=Math.max(t.rightCol,n.rightCol)},t.prototype._checkActionState=function(){var n=this,t=!0;return Object.keys(n._oldValues).forEach(function(i){var r,u;t&&(r=n._oldValues[i],u=n._newValues[i],r&&u&&r.value!==u.value&&(t=!1))}),t},t}(b);t._EditAction=d;ht=function(n){function t(t,i,r){var u=n.call(this,t)||this;return u._panel=i,u._colIndex=r,u._oldColWidth=i.columns[r].width,u}return __extends(t,n),t.prototype.undo=function(){this._panel.columns[this._colIndex].width=this._oldColWidth},t.prototype.redo=function(){this._panel.columns[this._colIndex].width=this._newColWidth},t.prototype.saveNewState=function(){return(this._newColWidth=this._panel.columns[this._colIndex].width,this._oldColWidth===this._newColWidth)?!1:!0},t}(b);t._ColumnResizeAction=ht;ct=function(n){function t(t,i,r){var u=n.call(this,t)||this;return u._panel=i,u._rowIndex=r,u._oldRowHeight=i.rows[r].height,u}return __extends(t,n),t.prototype.undo=function(){this._panel.rows[this._rowIndex].height=this._oldRowHeight},t.prototype.redo=function(){this._panel.rows[this._rowIndex].height=this._newRowHeight},t.prototype.saveNewState=function(){return(this._newRowHeight=this._panel.rows[this._rowIndex].height,this._oldRowHeight===this._newRowHeight)?!1:!0},t}(b);t._RowResizeAction=ct;ut=function(n){function t(t){var i=this,r,u=[];for(i=n.call(this,t)||this,i._selection=t.selection,r=0;r<t.columns.length;r++)u.push(t.columns[r]);return i._oldValue={columns:u,sortList:t.sortManager._committedList.slice(),styledCells:t.selectedSheet?JSON.parse(JSON.stringify(t.selectedSheet._styledCells)):null,mergedCells:t._cloneMergedCells()},i}return __extends(t,n),t.prototype.undo=function(){var i,r,u,t,n=this;if(n._owner.selectedSheet){for(n._owner._clearCalcEngine(),n._owner.finishEditing(),n._owner.columns.clear(),n._owner.selectedSheet._styledCells=undefined,n._owner.selectedSheet._mergedRanges=undefined,n._owner.columns.beginUpdate(),i=0;i<n._oldValue.columns.length;i++)n._owner.columns.push(n._oldValue.columns[i]);n._owner.columns.endUpdate();n._owner.selectedSheet._styledCells=n._oldValue.styledCells;n._owner.selectedSheet._mergedRanges=n._oldValue.mergedCells;n._affectedFormulas&&(t=n._affectedFormulas.oldFormulas);n._owner.deferUpdate(function(){if(n._owner.selection=n._selection,!!t&&t.length>0)for(r=0;r<t.length;r++)u=t[r],n._owner.setCellData(u.point.x,u.point.y,u.formula);n._owner._copyTo(n._owner.selectedSheet);n._owner._copyFrom(n._owner.selectedSheet)});n._owner.selectedSheet.grid.wj_sheetInfo.styledCells=n._owner.selectedSheet._styledCells;n._owner.selectedSheet.grid.wj_sheetInfo.mergedRanges=n._owner.selectedSheet._mergedRanges;n._owner.sortManager.sortDescriptions.sourceCollection=n._oldValue.sortList.slice();n._owner.sortManager.commitSort(!1);n._owner.sortManager._refresh();n._owner.selection=n._selection;n._owner.refresh(!0);setTimeout(function(){n._owner._setFlexSheetToDirty();n._owner.refresh(!0)},10)}},t.prototype.redo=function(){var i,r,u,t,n=this;if(n._owner.selectedSheet){for(n._owner._clearCalcEngine(),n._owner.finishEditing(),n._owner.columns.clear(),n._owner.selectedSheet._styledCells=undefined,n._owner.selectedSheet._mergedRanges=undefined,n._owner.columns.beginUpdate(),i=0;i<n._newValue.columns.length;i++)n._owner.columns.push(n._newValue.columns[i]);n._owner.columns.endUpdate();n._owner.selectedSheet._styledCells=n._newValue.styledCells;n._owner.selectedSheet._mergedRanges=n._newValue.mergedCells;n._affectedFormulas&&(t=n._affectedFormulas.newFormulas);n._owner.deferUpdate(function(){if(n._owner.selection=n._selection,!!t&&t.length>0)for(r=0;r<t.length;r++)u=t[r],n._owner.setCellData(u.point.x,u.point.y,u.formula);n._owner._copyTo(n._owner.selectedSheet);n._owner._copyFrom(n._owner.selectedSheet)});n._owner.selectedSheet.grid.wj_sheetInfo.styledCells=n._owner.selectedSheet._styledCells;n._owner.selectedSheet.grid.wj_sheetInfo.mergedRanges=n._owner.selectedSheet._mergedRanges;n._owner.sortManager.sortDescriptions.sourceCollection=n._newValue.sortList.slice();n._owner.sortManager.commitSort(!1);n._owner.sortManager._refresh();n._owner.selection=n._selection;n._owner.refresh(!0);setTimeout(function(){n._owner._setFlexSheetToDirty();n._owner.refresh(!0)},10)}},t.prototype.saveNewState=function(){for(var t=[],n=0;n<this._owner.columns.length;n++)t.push(this._owner.columns[n]);return this._newValue={columns:t,sortList:this._owner.sortManager._committedList.slice(),styledCells:this._owner.selectedSheet?JSON.parse(JSON.stringify(this._owner.selectedSheet._styledCells)):null,mergedCells:this._owner._cloneMergedCells()},!0},t}(b);t._ColumnsChangedAction=ut;ft=function(n){function t(t){var i=this,r,u,f=[],e=[];for(i=n.call(this,t)||this,i._selection=t.selection,r=0;r<t.rows.length;r++)f.push(t.rows[r]);for(u=0;u<t.columns.length;u++)e.push(t.columns[u]);return i._oldValue={rows:f,columns:e,itemsSource:t.itemsSource?t.itemsSource.slice():undefined,styledCells:t.selectedSheet?JSON.parse(JSON.stringify(t.selectedSheet._styledCells)):null,mergedCells:t._cloneMergedCells()},i}return __extends(t,n),t.prototype.undo=function(){var t,u,f,i,e,r,n=this,o=!!n._oldValue.itemsSource;if(n._owner.selectedSheet){for(n._owner._clearCalcEngine(),n._owner.finishEditing(),n._owner.columns.clear(),n._owner.rows.clear(),n._owner.selectedSheet._styledCells=undefined,n._owner.selectedSheet._mergedRanges=undefined,o&&(n._owner.autoGenerateColumns=!1,n._owner.itemsSource=n._oldValue.itemsSource.slice()),n._owner.rows.beginUpdate(),t=0;t<n._oldValue.rows.length;t++)i=n._oldValue.rows[t],o?i.dataItem||i instanceof w||n._owner.rows.splice(t,0,i):n._owner.rows.push(i);for(u=0;u<n._oldValue.columns.length;u++)n._owner.columns.push(n._oldValue.columns[u]);n._owner.rows.endUpdate();n._owner.selectedSheet._styledCells=n._oldValue.styledCells;n._owner.selectedSheet._mergedRanges=n._oldValue.mergedCells;n._affectedFormulas&&(r=n._affectedFormulas.oldFormulas);n._owner.deferUpdate(function(){if(n._owner.selection=n._selection,!!r&&r.length>0)for(f=0;f<r.length;f++)e=r[f],n._owner.setCellData(e.point.x,e.point.y,e.formula);n._owner._copyTo(n._owner.selectedSheet);n._owner._copyFrom(n._owner.selectedSheet)});n._owner.selectedSheet.grid.wj_sheetInfo.styledCells=n._owner.selectedSheet._styledCells;n._owner.selectedSheet.grid.wj_sheetInfo.mergedRanges=n._owner.selectedSheet._mergedRanges;n._owner.selection=n._selection;n._owner.refresh(!0);setTimeout(function(){n._owner._setFlexSheetToDirty();n._owner.refresh(!0)},10)}},t.prototype.redo=function(){var t,u,f,i,e,r,n=this,o=!!n._newValue.itemsSource;if(n._owner.selectedSheet){for(n._owner._clearCalcEngine(),n._owner.finishEditing(),n._owner.columns.clear(),n._owner.rows.clear(),n._owner.selectedSheet._styledCells=undefined,n._owner.selectedSheet._mergedRanges=undefined,o&&(n._owner.autoGenerateColumns=!1,n._owner.itemsSource=n._newValue.itemsSource.slice()),n._owner.rows.beginUpdate(),t=0;t<n._newValue.rows.length;t++)i=n._newValue.rows[t],o?i.dataItem||i instanceof w||n._owner.rows.splice(t,0,i):n._owner.rows.push(i);for(u=0;u<n._newValue.columns.length;u++)n._owner.columns.push(n._newValue.columns[u]);n._owner.rows.endUpdate();n._owner.selectedSheet._styledCells=n._newValue.styledCells;n._owner.selectedSheet._mergedRanges=n._newValue.mergedCells;n._affectedFormulas&&(r=n._affectedFormulas.newFormulas);n._owner.deferUpdate(function(){if(!!r&&r.length>0)for(f=0;f<r.length;f++)e=r[f],n._owner.setCellData(e.point.x,e.point.y,e.formula);n._owner._copyTo(n._owner.selectedSheet);n._owner._copyFrom(n._owner.selectedSheet)});n._owner.selectedSheet.grid.wj_sheetInfo.styledCells=n._owner.selectedSheet._styledCells;n._owner.selectedSheet.grid.wj_sheetInfo.mergedRanges=n._owner.selectedSheet._mergedRanges;n._owner.selection=n._selection;n._owner.refresh(!0);setTimeout(function(){n._owner._setFlexSheetToDirty();n._owner.refresh(!0)},10)}},t.prototype.saveNewState=function(){for(var t,i=[],r=[],n=0;n<this._owner.rows.length;n++)i.push(this._owner.rows[n]);for(t=0;t<this._owner.columns.length;t++)r.push(this._owner.columns[t]);return this._newValue={rows:i,columns:r,itemsSource:this._owner.itemsSource?this._owner.itemsSource.slice():undefined,styledCells:this._owner.selectedSheet?JSON.parse(JSON.stringify(this._owner.selectedSheet._styledCells)):null,mergedCells:this._owner._cloneMergedCells()},!0},t}(b);t._RowsChangedAction=ft;kt=function(n){function t(t,i){var r=n.call(this,t)||this;return r._oldStyledCells=i?JSON.parse(JSON.stringify(i)):t.selectedSheet?JSON.parse(JSON.stringify(t.selectedSheet._styledCells)):null,r}return __extends(t,n),t.prototype.undo=function(){this._owner.selectedSheet&&(this._owner.selectedSheet._styledCells=JSON.parse(JSON.stringify(this._oldStyledCells)),this._owner.selectedSheet.grid.wj_sheetInfo.styledCells=this._owner.selectedSheet._styledCells,this._owner.refresh(!1))},t.prototype.redo=function(){this._owner.selectedSheet&&(this._owner.selectedSheet._styledCells=JSON.parse(JSON.stringify(this._newStyledCells)),this._owner.selectedSheet.grid.wj_sheetInfo.styledCells=this._owner.selectedSheet._styledCells,this._owner.refresh(!1))},t.prototype.saveNewState=function(){return this._newStyledCells=this._owner.selectedSheet?JSON.parse(JSON.stringify(this._owner.selectedSheet._styledCells)):null,!0},t}(b);t._CellStyleAction=kt;et=function(n){function t(t){var i=n.call(this,t)||this;return i._oldMergedCells=t._cloneMergedCells(),i}return __extends(t,n),t.prototype.undo=function(){this._owner.selectedSheet&&(this._owner._clearCalcEngine(),this._owner.selectedSheet._mergedRanges=this._oldMergedCells,this._owner.selectedSheet.grid.wj_sheetInfo.mergedRanges=this._owner.selectedSheet._mergedRanges,this._owner.refresh(!0))},t.prototype.redo=function(){this._owner.selectedSheet&&(this._owner._clearCalcEngine(),this._owner.selectedSheet._mergedRanges=this._newMergedCells,this._owner.selectedSheet.grid.wj_sheetInfo.mergedRanges=this._owner.selectedSheet._mergedRanges,this._owner.refresh(!0))},t.prototype.saveNewState=function(){return this._newMergedCells=this._owner._cloneMergedCells(),!0},t}(b);t._CellMergeAction=et;dt=function(n){function t(t){var u=this,i,r,f=[],e=[];if(u=n.call(this,t)||this,!t.itemsSource){for(i=0;i<t.rows.length;i++)e.push(t.rows[i]);for(r=0;r<t.columns.length;r++)f.push(t.columns[r])}return u._oldValue={sortList:t.sortManager._committedList.slice(),rows:e,columns:f,formulas:t._scanFormulas()},u}return __extends(t,n),t.prototype.undo=function(){var n=this,t,i,r,u;n._owner.selectedSheet&&(n._owner._isUndoing=!0,n._owner.deferUpdate(function(){if(n._owner._clearCalcEngine(),n._owner.sortManager.sortDescriptions.sourceCollection=n._oldValue.sortList.slice(),n._owner.sortManager.commitSort(!1),n._owner.sortManager._refresh(),!n._owner.itemsSource){for(n._owner.rows.clear(),n._owner.columns.clear(),n._owner.selectedSheet.grid.rows.clear(),n._owner.selectedSheet.grid.columns.clear(),t=0;t<n._oldValue.rows.length;t++)r=n._oldValue.rows[t],n._owner.rows.push(r),n._owner.selectedSheet.grid.rows.push(r);for(i=0;i<n._oldValue.columns.length;i++)u=n._oldValue.columns[i],n._owner.columns.push(u),n._owner.selectedSheet.grid.columns.push(u);n._owner._resetFormulas(n._oldValue.formulas);n._owner._isUndoing=!1;setTimeout(function(){n._owner._setFlexSheetToDirty();n._owner.refresh(!0)},10)}}))},t.prototype.redo=function(){var n=this,t,i,r,u;n._owner.selectedSheet&&(n._owner._isUndoing=!0,n._owner.deferUpdate(function(){if(n._owner._clearCalcEngine(),n._owner.sortManager.sortDescriptions.sourceCollection=n._newValue.sortList.slice(),n._owner.sortManager.commitSort(!1),n._owner.sortManager._refresh(),!n._owner.itemsSource){for(n._owner.rows.clear(),n._owner.columns.clear(),n._owner.selectedSheet.grid.rows.clear(),n._owner.selectedSheet.grid.columns.clear(),t=0;t<n._newValue.rows.length;t++)r=n._newValue.rows[t],n._owner.rows.push(r),n._owner.selectedSheet.grid.rows.push(r);for(i=0;i<n._newValue.columns.length;i++)u=n._newValue.columns[i],n._owner.columns.push(u),n._owner.selectedSheet.grid.columns.push(u);n._owner._resetFormulas(n._newValue.formulas);n._owner._isUndoing=!1;setTimeout(function(){n._owner._setFlexSheetToDirty();n._owner.refresh(!0)},10)}}))},t.prototype.saveNewState=function(){var n,t,i=[],r=[];if(!this._owner.itemsSource){for(n=0;n<this._owner.rows.length;n++)r.push(this._owner.rows[n]);for(t=0;t<this._owner.columns.length;t++)i.push(this._owner.columns[t])}return this._newValue={sortList:this._owner.sortManager._committedList.slice(),rows:r,columns:i,formulas:this._owner._scanFormulas()},!0},t}(b);t._SortColumnAction=dt;lt=function(n){function t(t,i,r,u){var f=this,o,e,s,h,c;if(f=n.call(this,t)||this,t.selectedSheet){for(f._isDraggingColumns=i.topRow===0&&i.bottomRow===t.rows.length-1?!0:!1,f._isCopyCells=u,f._dragRange=i,f._dropRange=r,f._oldDroppingCells=[],f._oldDroppingColumnSetting={},o=r.topRow;o<=r.bottomRow;o++)for(e=r.leftCol;e<=r.rightCol;e++)f._isDraggingColumns&&(f._oldDroppingColumnSetting[e]||(f._oldDroppingColumnSetting[e]={dataType:t.columns[e].dataType,align:t.columns[e].align,format:t.columns[e].format})),s=o*f._owner.columns.length+e,c=f._owner.selectedSheet._styledCells[s]?JSON.parse(JSON.stringify(f._owner.selectedSheet._styledCells[s])):undefined,h=f._owner.getCellData(o,e,!1),f._oldDroppingCells.push({rowIndex:o,columnIndex:e,cellContent:h,cellStyle:c});if(!u)for(f._draggingCells=[],f._draggingColumnSetting={},o=i.topRow;o<=i.bottomRow;o++)for(e=i.leftCol;e<=i.rightCol;e++)f._isDraggingColumns&&(f._draggingColumnSetting[e]||(f._draggingColumnSetting[e]={dataType:t.columns[e].dataType,align:t.columns[e].align,format:t.columns[e].format})),s=o*f._owner.columns.length+e,c=f._owner.selectedSheet._styledCells[s]?JSON.parse(JSON.stringify(f._owner.selectedSheet._styledCells[s])):undefined,h=f._owner.getCellData(o,e,!1),f._draggingCells.push({rowIndex:o,columnIndex:e,cellContent:h,cellStyle:c});return f}}return __extends(t,n),t.prototype.undo=function(){var n=this,r,t,e,u,f;if(n._owner.selectedSheet){for(n._owner._clearCalcEngine(),r=0;r<n._oldDroppingCells.length;r++)t=n._oldDroppingCells[r],n._owner.setCellData(t.rowIndex,t.columnIndex,t.cellContent),e=t.rowIndex*n._owner.columns.length+t.columnIndex,t.cellStyle?n._owner.selectedSheet._styledCells[e]=t.cellStyle:delete n._owner.selectedSheet._styledCells[e];if(n._isDraggingColumns&&!!n._oldDroppingColumnSetting&&Object.keys(n._oldDroppingColumnSetting).forEach(function(t){n._owner.columns[+t].dataType=n._oldDroppingColumnSetting[+t].dataType?n._oldDroppingColumnSetting[+t].dataType:i.DataType.Object;n._owner.columns[+t].align=n._oldDroppingColumnSetting[+t].align;n._owner.columns[+t].format=n._oldDroppingColumnSetting[+t].format}),!n._isCopyCells){for(r=0;r<n._draggingCells.length;r++)t=n._draggingCells[r],n._owner.setCellData(t.rowIndex,t.columnIndex,t.cellContent),e=t.rowIndex*n._owner.columns.length+t.columnIndex,t.cellStyle&&(n._owner.selectedSheet._styledCells[e]=t.cellStyle);if(n._isDraggingColumns&&!!n._draggingColumnSetting&&Object.keys(n._draggingColumnSetting).forEach(function(t){n._owner.columns[+t].dataType=n._draggingColumnSetting[+t].dataType?n._draggingColumnSetting[+t].dataType:i.DataType.Object;n._owner.columns[+t].align=n._draggingColumnSetting[+t].align;n._owner.columns[+t].format=n._draggingColumnSetting[+t].format}),n._isDraggingColumns)if(n._dragRange.leftCol<n._dropRange.leftCol)for(f=n._dragRange.leftCol,u=n._dropRange.leftCol;u<=n._dropRange.rightCol;u++)n._owner._updateColumnFiler(u,f),f++;else for(f=n._dragRange.rightCol,u=n._dropRange.rightCol;u>=n._dropRange.leftCol;u--)n._owner._updateColumnFiler(u,f),f--}}},t.prototype.redo=function(){var n=this,r,t,f,u,e;if(n._owner.selectedSheet){if(n._owner._clearCalcEngine(),!n._isCopyCells){for(r=0;r<n._draggingCells.length;r++)t=n._draggingCells[r],n._owner.setCellData(t.rowIndex,t.columnIndex,null),f=t.rowIndex*n._owner.columns.length+t.columnIndex,n._owner.selectedSheet._styledCells[f]&&delete n._owner.selectedSheet._styledCells[f];n._isDraggingColumns&&!!n._draggingColumnSetting&&Object.keys(n._draggingColumnSetting).forEach(function(t){n._owner.columns[+t].dataType=i.DataType.Object;n._owner.columns[+t].align=null;n._owner.columns[+t].format=null})}for(r=0;r<n._newDroppingCells.length;r++)t=n._newDroppingCells[r],n._owner.setCellData(t.rowIndex,t.columnIndex,t.cellContent),f=t.rowIndex*n._owner.columns.length+t.columnIndex,t.cellStyle?n._owner.selectedSheet._styledCells[f]=t.cellStyle:delete n._owner.selectedSheet._styledCells[f];if(n._isDraggingColumns&&!!n._newDroppingColumnSetting&&Object.keys(n._newDroppingColumnSetting).forEach(function(t){n._owner.columns[+t].dataType=n._newDroppingColumnSetting[+t].dataType?n._newDroppingColumnSetting[+t].dataType:i.DataType.Object;n._owner.columns[+t].align=n._newDroppingColumnSetting[+t].align;n._owner.columns[+t].format=n._newDroppingColumnSetting[+t].format}),n._isDraggingColumns&&!n._isCopyCells)if(n._dragRange.leftCol>n._dropRange.leftCol)for(e=n._dropRange.leftCol,u=n._dragRange.leftCol;u<=n._dragRange.rightCol;u++)n._owner._updateColumnFiler(u,e),e++;else for(e=n._dropRange.rightCol,u=n._dragRange.rightCol;u>=n._dragRange.leftCol;u--)n._owner._updateColumnFiler(u,e),e--}},t.prototype.saveNewState=function(){var t,n,i,r,u;if(!this._owner.selectedSheet)return!1;if(this._dropRange){for(this._newDroppingCells=[],this._newDroppingColumnSetting={},t=this._dropRange.topRow;t<=this._dropRange.bottomRow;t++)for(n=this._dropRange.leftCol;n<=this._dropRange.rightCol;n++)this._isDraggingColumns&&(this._newDroppingColumnSetting[n]||(this._newDroppingColumnSetting[n]={dataType:this._owner.columns[n].dataType,align:this._owner.columns[n].align,format:this._owner.columns[n].format})),i=t*this._owner.columns.length+n,u=this._owner.selectedSheet._styledCells[i]?JSON.parse(JSON.stringify(this._owner.selectedSheet._styledCells[i])):undefined,r=this._owner.getCellData(t,n,!1),this._newDroppingCells.push({rowIndex:t,columnIndex:n,cellContent:r,cellStyle:u});return!0}return!1},t}(b);t._MoveCellsAction=lt;ot=function(n){function t(t){var i=this,u,r,f,e;for(i=n.call(this,t)||this,i._oldValues=[],i._oldCutValues=[],i._mergeAction=new et(t),i._cutSheet=t._copiedSheet,i._selection=t.selection,i._cutSelection=t._copiedRanges[0],e=i._cutSheet===t.selectedSheet?t:i._cutSheet.grid,u=i._cutSelection.topRow;u<=i._cutSelection.bottomRow;u++)for(r=i._cutSelection.leftCol;r<=i._cutSelection.rightCol;r++)f=e.getCellData(u,r,!!e.columns[r].dataMap),f=f==null?'':f,i._oldCutValues.push({row:u,col:r,value:f});return i}return __extends(t,n),t.prototype.undo=function(){var n=this;n._owner._clearCalcEngine();n._owner.selectedSheet.selectionRanges.clear();n._owner.deferUpdate(function(){var t,i,r=n._cutSheet===n._owner.selectedSheet?n._owner:n._cutSheet.grid;for(n._owner.selectedSheet.selectionRanges.push(n._selection),t=0;t<n._oldCutValues.length;t++)i=n._oldCutValues[t],r.setCellData(i.row,i.col,i.value);for(t=0;t<n._oldValues.length;t++)i=n._oldValues[t],n._owner.setCellData(i.row,i.col,i.value);n._mergeAction.undo();n._owner.refresh(!1)})},t.prototype.redo=function(){var n=this;n._owner._clearCalcEngine();n._owner.selectedSheet.selectionRanges.clear();n._owner.deferUpdate(function(){var t,i,r=n._cutSheet===n._owner.selectedSheet?n._owner:n._cutSheet.grid;for(n._owner.selectedSheet.selectionRanges.push(n._selection),t=0;t<n._newCutValues.length;t++)i=n._newCutValues[t],r.setCellData(i.row,i.col,i.value);for(t=0;t<n._newValues.length;t++)i=n._newValues[t],n._owner.setCellData(i.row,i.col,i.value);n._mergeAction.redo();n._owner.refresh(!1)})},t.prototype.saveNewState=function(){var t,n,r,i,u=this._cutSheet===this._owner.selectedSheet?this._owner:this._cutSheet.grid;for(this._newCutValues=[],t=this._cutSelection.topRow;t<=this._cutSelection.bottomRow;t++)for(n=this._cutSelection.leftCol;n<=this._cutSelection.rightCol;n++)i=u.getCellData(t,n,!!u.columns[n].dataMap),i=i==null?'':i,this._newCutValues.push({row:t,col:n,value:i});for(this._newValues=[],t=this._selection.topRow;t<=this._selection.bottomRow;t++)for(n=this._selection.leftCol;n<=this._selection.rightCol;n++){if(r=this._owner.columns[n],!r)return!1;i=this._owner.getCellData(t,n,!!this._owner.columns[n].dataMap);i=i==null?'':i;this._newValues.push({row:t,col:n,value:i})}return this._mergeAction.saveNewState(),!0},t.prototype.updateForPasting=function(n){var t=this._owner.getCellData(n.row,n.col,!!this._owner.columns[n.col].dataMap);t=t==null?'':t;this._oldValues.push({row:n.row,col:n.col,value:t});this._selection.row=Math.min(this._selection.topRow,n.topRow);this._selection.row2=Math.max(this._selection.bottomRow,n.bottomRow);this._selection.col=Math.min(this._selection.leftCol,n.leftCol);this._selection.col2=Math.max(this._selection.rightCol,n.rightCol)},t}(b);t._CutAction=ot;at=function(n){function t(t,i){var r=n.call(this,t)||this;return r._owner=i,r.applyTemplate('',r.getTemplate(),{_insRows:'insert-rows',_delRows:'delete-rows',_insCols:'insert-columns',_delCols:'delete-columns'}),r._init(),r}return __extends(t,n),t.prototype.show=function(n,t){var i=(t?t.x:n.clientX)+(n?window.pageXOffset:0),r=(t?t.y:n.clientY)+(n?window.pageYOffset:0);this.hostElement.style.position='absolute';this.hostElement.style.display='inline';r+this.hostElement.clientHeight>window.innerHeight&&(r-=this.hostElement.clientHeight);i+this.hostElement.clientWidth>window.innerWidth&&(i-=this.hostElement.clientWidth);this.hostElement.style.top=r+'px';this.hostElement.style.left=i+'px'},t.prototype.hide=function(){this.hostElement.style.display='none'},t.prototype._init=function(){var n=this;n.hostElement.style.zIndex='9999';document.querySelector('body').appendChild(n.hostElement);n.addEventListener(n.hostElement,'contextmenu',function(n){n.preventDefault()});n.addEventListener(n._insRows,'click',function(){n._owner.insertRows();n.hide();n._owner.hostElement.focus()});n.addEventListener(n._delRows,'click',function(){n._owner.deleteRows();n.hide();n._owner.hostElement.focus()});n.addEventListener(n._insCols,'click',function(){n._owner.insertColumns();n.hide();n._owner.hostElement.focus()});n.addEventListener(n._delCols,'click',function(){n._owner.deleteColumns();n.hide();n._owner.hostElement.focus()})},t}(i.Control);at.controlTemplate='<div class="wj-context-menu" width="150px"><div class="wj-context-menu-item" wj-part="insert-rows">Insert Row<\/div><div class="wj-context-menu-item" wj-part="delete-rows">Delete Rows<\/div><div class="wj-context-menu-item" wj-part="insert-columns">Insert Column<\/div><div class="wj-context-menu-item" wj-part="delete-columns">Delete Columns<\/div><\/div>';t._ContextMenu=at;vt=function(n){function t(t,i){var r=n.call(this,t)||this;return r._splitterMousedownHdl=r._splitterMousedownHandler.bind(r),r._owner=i,r.hostElement.attributes.tabindex&&r.hostElement.attributes.removeNamedItem('tabindex'),r.applyTemplate('',r.getTemplate(),{_divSheet:'left',_divSplitter:'splitter',_divRight:'right'}),r._init(),r}return __extends(t,n),Object.defineProperty(t.prototype,"sheetControl",{get:function(){return this._sheetControl},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visible",{get:function(){return this.hostElement.style.display!=='none'},set:function(n){this.hostElement.style.display=n?'block':'none';this._divSheet.style.display=n?'block':'none'},enumerable:!0,configurable:!0}),t.prototype.getSheetBlanketSize=function(){return 20},t.prototype.adjustSize=function(){var t=this._owner.scrollSize.width-this._owner.clientSize.width,i=this._owner.scrollSize.height-this._owner.clientSize.height,n=this._divSplitter.parentElement;t<=0?(n.style.minWidth='100px',this._divSplitter.style.display='none',this._divRight.style.display='none',this._divSheet.style.width='100%',this._divSplitter.removeEventListener('mousedown',this._splitterMousedownHdl,!0)):(n.style.minWidth='300px',this._divSplitter.style.display='none',this._divRight.style.display='none',this._divSheet.style.width='100%',this._divSplitter.removeEventListener('mousedown',this._splitterMousedownHdl,!0),this._divSplitter.addEventListener('mousedown',this._splitterMousedownHdl,!0));this._sheetControl._adjustSize()},t.prototype._init=function(){var n=this;n._funSplitterMousedown=function(t){n._splitterMouseupHandler(t)};n._divSplitter.parentElement.style.height=n.getSheetBlanketSize()+'px';n._sheetControl=new yt(n._divSheet,this._owner)},t.prototype._splitterMousedownHandler=function(n){this._startPos=n.pageX;document.addEventListener('mousemove',this._splitterMousemoveHandler.bind(this),!0);document.addEventListener('mouseup',this._funSplitterMousedown,!0);n.preventDefault()},t.prototype._splitterMousemoveHandler=function(n){this._startPos!==null&&typeof this._startPos!='undefined'&&this._adjustDis(n.pageX-this._startPos)},t.prototype._splitterMouseupHandler=function(n){document.removeEventListener('mousemove',this._splitterMousemoveHandler,!0);document.removeEventListener('mouseup',this._funSplitterMousedown,!0);this._adjustDis(n.pageX-this._startPos);this._startPos=null},t.prototype._adjustDis=function(n){var t=this._divRight.offsetWidth-n,i=this._divSheet.offsetWidth+n;(t<=100?(t=100,n=this._divRight.offsetWidth-t,i=this._divSheet.offsetWidth+n):i<=100&&(i=100,n=i-this._divSheet.offsetWidth,t=this._divRight.offsetWidth-n),n!=0)&&(this._divRight.style.width=t+'px',this._divSheet.style.width=i+'px',this._startPos=this._startPos+n)},t}(i.Control);vt.controlTemplate='<div><div wj-part="left" style ="float:left;height:100%;overflow:hidden"><\/div><div wj-part="splitter" style="float:left;height:100%;width:6px;background-color:#e9eaee;padding:2px;cursor:e-resize"><div style="background-color:#8a9eb2;height:100%"><\/div><\/div><div wj-part="right" style="float:left;height:100%;background-color:#e9eaee"><\/div><\/div>';t._TabHolder=vt;gt=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.updateCell=function(t,r,f,e,o){var g=t.grid,ht=r,ct=f,et,nt,s,y,c,b,ot,l,p,it,k,v,rt,d,ut,st,ft,a;t.cellType===u.CellType.Cell&&this._resetCellStyle(t.columns[f],e);n.prototype.updateCell.call(this,t,r,f,e,o);o&&!o.isSingleCell&&(r=o.row,f=o.col,ht=o.row2,ct=o.col2);k=g._getBindingColumn(t,r,t.columns[f]);switch(t.cellType){case u.CellType.RowHeader:e.textContent=r+1+'';break;case u.CellType.ColumnHeader:et=tt.convertNumberToAlpha(f);e.innerHTML=e.innerHTML.replace(i.escapeHtml(e.textContent),'')+et;e.style.textAlign='center';break;case u.CellType.Cell:if(s=t.grid,nt=r*s.columns.length+f,l=s.selectedSheet&&s.selectedSheet._styledCells?s.selectedSheet._styledCells[nt]:null,!o||o.isSingleCell||(rt=this._getFirstVisibleCell(s,o),r=rt.row,f=rt.col),t.rows[r]instanceof w)t.columns[f].dataType===i.DataType.Boolean&&e.childElementCount===1&&e.firstElementChild instanceof HTMLInputElement&&e.firstElementChild.type==='checkbox'&&(e.innerHTML=i.escapeHtml(t.columns[f].header)),i.addClass(e,'wj-header-row');else if(c=s.getCellValue(r,f,!1),b=s.getCellData(r,f,!1),ot=b!=null&&typeof b=='string'&&b[0]==='=',d=t.rows[r]instanceof u.GroupRow,v=(l?l.format:null)||(d?null:k.format),s.editRange&&s.editRange.contains(r,f)?!i.isNumber(c)||k.dataMap||ot||(v&&(c=this._getFormattedValue(c,v)),it=e.querySelector('input'),it&&(it.value=c)):t.columns[f].dataType===i.DataType.Boolean?(p=e.querySelector('[type="checkbox"]'),p&&(p.checked=s.getCellValue(r,f),p.disabled=p.disabled||!s.canEditCell(r,f))):k.dataMap&&!d?(c=s.getCellValue(r,f,!0),y=e.firstChild,y&&y.nodeType===3&&y.nodeValue!==c&&(y.nodeValue=c)):e.childElementCount===0&&e.textContent===s.getCellData(r,f,!0)&&(c=s.getCellValue(r,f,!0),c!==''&&i.isNumber(+c)&&!isNaN(+c)&&/[hsmy\:]/i.test(v)&&(ut=h._fromOADate(+c),isNaN(ut.getTime())||(c=i.Globalize.formatDate(ut,v))),(v||!d)&&(e.innerHTML=i.escapeHtml(c))),l){st=e.style;for(a in l)a==='className'?l.className&&i.addClass(e,l.className):a!=='format'&&(ft=l[a])&&(st[a]=(i.hasClass(e,'wj-state-selected')||i.hasClass(e,'wj-state-multi-selected'))&&(a==='color'||a==='backgroundColor')?'':a==='whiteSpace'&&ft==='normal'?'':ft)}!e.style.backgroundColor&&!e.style.color||(l||(s.selectedSheet._styledCells[nt]=l={}),!e.style.backgroundColor||(l.backgroundColor=e.style.backgroundColor),!e.style.color||(l.color=e.style.color))}t.cellType===u.CellType.Cell&&(r!==g._lastVisibleFrozenRow||i.hasClass(e,'wj-frozen-row')||i.addClass(e,'wj-frozen-row'),f!==g._lastVisibleFrozenColumn||i.hasClass(e,'wj-frozen-col')||i.addClass(e,'wj-frozen-col'))},t.prototype._resetCellStyle=function(n,t){['fontFamily','fontSize','fontStyle','fontWeight','textDecoration','textAlign','verticalAlign','backgroundColor','color','whiteSpace','borderLeftStyle','borderLeftColor','borderLeftWidth','borderRightStyle','borderRightColor','borderRightWidth','borderTopStyle','borderTopColor','borderTopWidth','borderBottomStyle','borderBottomColor','borderBottomWidth'].forEach(function(i){i==='textAlign'?t.style.textAlign=n.getAlignment():t.style[i]=''})},t.prototype._getFormattedValue=function(n,t){return n!==Math.round(n)&&(t=t.replace(/([a-z])(\d*)(.*)/ig,'$0112$3')),i.Globalize.formatNumber(n,t,!0)},t.prototype._getFirstVisibleCell=function(n,t){for(var r,i=t.topRow;i<=t.bottomRow;i++)if(n.rows[i].isVisible)break;for(r=t.leftCol;r<=t.rightCol;r++)if(n.columns[r].isVisible)break;return new u.CellRange(i,r)},t}(u.CellFactory);t._FlexSheetCellFactory=gt;ni=[{name:'abs',description:'Returns the absolute value of a number.'},{name:'acos',description:'Returns the arccosine of a number.'},{name:'and',description:'Returns TRUE if all of its arguments are TRUE.'},{name:'asin',description:'Returns the arcsine of a number.'},{name:'atan',description:'Returns the arctangent of a number.'},{name:'atan2',description:'Returns the arctangent from x- and y-coordinates.'},{name:'average',description:'Returns the average of its arguments.'},{name:'ceiling',description:'Rounds a number to the nearest integer or to the nearest multiple of significance.'},{name:'char',description:'Returns the character specified by the code number.'},{name:'choose',description:'Chooses a value from a list of values.'},{name:'code',description:'Returns a numeric code for the first character in a text string.'},{name:'column',description:'Returns the column number of a reference.'},{name:'columns',description:'Returns the number of columns in a reference.'},{name:'concatenate',description:'Joins several text items into one text item.'},{name:'cos',description:'Returns the cosine of a number.'},{name:'count',description:'Counts how many numbers are in the list of arguments.'},{name:'counta',description:'Counts how many values are in the list of arguments.'},{name:'countblank',description:'Counts the number of blank cells within a range.'},{name:'countif',description:'Counts the number of cells within a range that meet the given criteria.'},{name:'countifs',description:'Counts the number of cells within a range that meet multiple criteria.'},{name:'date',description:'Returns the serial number of a particular date.'},{name:'datedif',description:'Calculates the number of days, months, or years between two dates.'},{name:'day',description:'Converts a serial number to a day of the month.'},{name:'dcount',description:'Counts the cells that contain numbers in a database.'},{name:'exp',description:'Returns e raised to the power of a given number.'},{name:'false',description:'Returns the logical value FALSE.'},{name:'find',description:'Finds one text value within another (case-sensitive).'},{name:'floor',description:'Rounds a number down, toward zero.'},{name:'hlookup',description:'Looks in the top row of an array and returns the value of the indicated cell.'},{name:'hour',description:'Converts a serial number to an hour.'},{name:'if',description:'Specifies a logical test to perform.'},{name:'index',description:'Uses an index to choose a value from a reference.'},{name:'left',description:'Returns the leftmost characters from a text value.'},{name:'len',description:'Returns the number of characters in a text string.'},{name:'ln',description:'Returns the natural logarithm of a number.'},{name:'lower',description:'Converts text to lowercase.'},{name:'max',description:'Returns the maximum value in a list of arguments.'},{name:'mid',description:'Returns a specific number of characters from a text string starting at the position you specify.'},{name:'min',description:'Returns the minimum value in a list of arguments.'},{name:'mod',description:'Returns the remainder from division.'},{name:'month',description:'Converts a serial number to a month.'},{name:'not',description:'Reverses the logic of its argument.'},{name:'now',description:'Returns the serial number of the current date and time.'},{name:'or',description:'Returns TRUE if any argument is TRUE.'},{name:'pi',description:'Returns the value of pi.'},{name:'power',description:'Returns the result of a number raised to a power.'},{name:'product',description:'Multiplies its arguments.'},{name:'proper',description:'Capitalizes the first letter in each word of a text value.'},{name:'rand',description:'Returns a random number between 0 and 1.'},{name:'rank',description:'Returns the rank of a number in a list of numbers.'},{name:'rate',description:'Returns the interest rate per period of an annuity.'},{name:'replace',description:'Replaces characters within text.'},{name:'rept',description:'Repeats text a given number of times.'},{name:'right',description:'Returns the rightmost characters from a text value.'},{name:'round',description:'Rounds a number to a specified number of digits.'},{name:'rounddown',description:'Rounds a number down, toward zero.'},{name:'roundup',description:'Rounds a number up, away from zero.'},{name:'row',description:'Returns the row number of a reference.'},{name:'rows',description:'Returns the number of rows in a reference.'},{name:'search',description:'Finds one text value within another (not case-sensitive).'},{name:'sin',description:'Returns the sine of the given angle.'},{name:'sqrt',description:'Returns a positive square root.'},{name:'stdev',description:'Estimates standard deviation based on a sample.'},{name:'stdevp',description:'Calculates standard deviation based on the entire population.'},{name:'substitute',description:'Substitutes new text for old text in a text string.'},{name:'subtotal',description:'Returns a subtotal in a list or database.'},{name:'sum',description:'Adds its arguments.'},{name:'sumif',description:'Adds the cells specified by a given criteria.'},{name:'sumifs',description:'Adds the cells in a range that meet multiple criteria.'},{name:'sumproduct',description:'Multiplies corresponding components in the given arrays, and returns the sum of those products.'},{name:'tan',description:'Returns the tangent of a number.'},{name:'text',description:'Formats a number and converts it to text.'},{name:'time',description:'Returns the serial number of a particular time.'},{name:'today',description:'Returns the serial number of today\'s date.'},{name:'trim',description:'Removes spaces from text.'},{name:'true',description:'Returns the logical value TRUE.'},{name:'trunc',description:'Truncates a number to an integer.'},{name:'upper',description:'Converts text to uppercase.'},{name:'value',description:'Converts a text argument to a number.'},{name:'var',description:'Estimates variance based on a sample.'},{name:'varp',description:'Calculates variance based on the entire population.'},{name:'year',description:'Converts a serial number to a year.'},];tt=function(n){function t(t,r){var f=n.call(this,t,r)||this;return f._selectedSheetIndex=-1,f._columnHeaderClicked=!1,f._addingSheet=!1,f._mouseMoveHdl=f._mouseMove.bind(f),f._clickHdl=f._click.bind(f),f._touchStartHdl=f._touchStart.bind(f),f._touchEndHdl=f._touchEnd.bind(f),f._isContextMenuKeyDown=!1,f._isClicking=!1,f._resettingFilter=!1,f._definedNames=new i.ObservableArray,f.selectedSheetChanged=new i.Event,f.draggingRowColumn=new i.Event,f.droppingRowColumn=new i.Event,f.loaded=new i.Event,f.unknownFunction=new i.Event,f.sheetCleared=new i.Event,f.prepareChangingRow=new i.Event,f.prepareChangingColumn=new i.Event,f.rowChanged=new i.Event,f.columnChanged=new i.Event,f._eCt.style.backgroundColor='white',i.addClass(f.hostElement,'wj-flexsheet'),i.setCss(f.hostElement,{fontFamily:'Arial'}),f._cf=new gt,f._init(),f.showSort=!1,f.allowSorting=!1,f.showGroups=!1,f.showMarquee=!0,f.showSelectedHeaders=u.HeadersVisibility.All,f.allowResizing=u.AllowResizing.Both,f.allowDragging=u.AllowDragging.None,f}return __extends(t,n),Object.defineProperty(t.prototype,"sheets",{get:function(){return this._sheets||(this._sheets=new ui,this._sheets.selectedSheetChanged.addHandler(this._selectedSheetChange,this),this._sheets.collectionChanged.addHandler(this._sourceChange,this),this._sheets.sheetVisibleChanged.addHandler(this._sheetVisibleChange,this),this._sheets.sheetCleared.addHandler(this.onSheetCleared,this)),this._sheets},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selectedSheetIndex",{get:function(){return this._selectedSheetIndex},set:function(n){n!==this._selectedSheetIndex&&(this._showSheet(n),this._sheets.selectedIndex=n)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selectedSheet",{get:function(){return this._sheets[this._selectedSheetIndex]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isFunctionListOpen",{get:function(){return this._functionListHost&&this._functionListHost.style.display!=='none'},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isTabHolderVisible",{get:function(){return this._tabHolder.visible},set:function(n){n!==this._tabHolder.visible&&(this._divContainer.style.height=n?this._divContainer.parentElement.clientHeight-this._tabHolder.getSheetBlanketSize()+'px':this._divContainer.parentElement.clientHeight+'px',this._tabHolder.visible=n)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"undoStack",{get:function(){return this._undoStack},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sortManager",{get:function(){return this._sortManager},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"showFilterIcons",{get:function(){return!this._filter?!1:this._filter.showFilterIcons},set:function(n){!this._filter||this._filter.showFilterIcons===n||(this._filter.showFilterIcons=n)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"definedNames",{get:function(){return this._definedNames},enumerable:!0,configurable:!0}),t.prototype.onSelectedSheetChanged=function(n){this._sortManager._refresh();this.selectedSheetChanged.raise(this,n)},t.prototype.onDraggingRowColumn=function(n){this.draggingRowColumn.raise(this,n)},t.prototype.onDroppingRowColumn=function(){this.droppingRowColumn.raise(this,new i.EventArgs)},t.prototype.onLoaded=function(){var n=this;n._toRefresh&&(clearTimeout(n._toRefresh),n._toRefresh=null);n._toRefresh=setTimeout(function(){n._setFlexSheetToDirty();n.invalidate()},10);n.loaded.raise(this,new i.EventArgs)},t.prototype.onUnknownFunction=function(n){this.unknownFunction.raise(this,n)},t.prototype.onSheetCleared=function(){this.sheetCleared.raise(this,new i.EventArgs)},t.prototype.onPrepareChangingRow=function(){this.prepareChangingRow.raise(this,new i.EventArgs)},t.prototype.onPrepareChangingColumn=function(){this.prepareChangingColumn.raise(this,new i.EventArgs)},t.prototype.onRowChanged=function(n){this.rowChanged.raise(this,n)},t.prototype.onColumnChanged=function(n){this.columnChanged.raise(this,n)},t.prototype.refresh=function(t){var u,e,f,i,r;if(t===void 0&&(t=!0),this._divContainer.style.height=this._divContainer.parentElement.clientHeight-(this.isTabHolderVisible?this._tabHolder.getSheetBlanketSize():0)+'px',this.preserveSelectedState||!this.selectedSheet||(this.selectedSheet.selectionRanges.clear(),this.selectedSheet.selectionRanges.push(this.selection)),t&&this._calcEngine._clearExpressionCache(),this._lastVisibleFrozenRow=-1,this.frozenRows>0)for(i=this.frozenRows-1;i>=0;i--)if(this.rows[i]&&this.rows[i].isVisible){this._lastVisibleFrozenRow=i;break}if(this._lastVisibleFrozenColumn=-1,this.frozenColumns>0)for(r=this.frozenColumns-1;r>=0;r--)if(this.columns[r]&&this.columns[r].isVisible){this._lastVisibleFrozenColumn=r;break}if(this.selectedSheet){if(this.selectedSheet._freezeHiddenRowCnt>0)for(u=0;u<this.selectedSheet._freezeHiddenRowCnt;u++)e=this.rows[u],e instanceof w||(e.visible=!1);if(this.selectedSheet._freezeHiddenColumnCnt>0)for(f=0;f<this.selectedSheet._freezeHiddenColumnCnt;f++)this.columns[f].visible=!1}n.prototype.refresh.call(this,t);this._tabHolder.adjustSize()},t.prototype.setCellData=function(n,t,r,u){u===void 0&&(u=!1);var f=i.isString(r)&&r.length>1&&r[0]==='=';return this._calcEngine._clearExpressionCache(),this.cells.setCellData(n,t,r,u&&!f)},t.prototype.containsFocus=function(){return this.isFunctionListOpen||n.prototype.containsFocus.call(this)},t.prototype.addUnboundSheet=function(n,t,i,r,u){var f=this._addSheet(n,t,i,r,u);return f.selectionRanges.length===0&&f.selectionRanges.push(this.selection),f},t.prototype.addBoundSheet=function(n,t,i,r){var u=this._addSheet(n,0,0,i,r);return t&&(u.itemsSource=t,this.childItemsPath&&(u.grid.childItemsPath=this.childItemsPath)),u.selectionRanges.length===0&&u.selectionRanges.push(this.selection),u},t.prototype.applyCellsStyle=function(n,t,i){i===void 0&&(i=!1);var u,f,o=t||[this.selection],r,e,s;if(this.selectedSheet){if(!n&&this._cloneStyle){this.selectedSheet._styledCells=JSON.parse(JSON.stringify(this._cloneStyle));this._cloneStyle=null;this.refresh(!1);return}if(o){for(t||i?i&&!this._cloneStyle&&(this._cloneStyle=JSON.parse(JSON.stringify(this.selectedSheet._styledCells))):(s=new kt(this,this._cloneStyle),this._cloneStyle=null),e=0;e<o.length;e++)for(r=o[e],u=r.topRow;u<=r.bottomRow;u++)for(f=r.leftCol;f<=r.rightCol;f++)this._applyStyleForCell(u,f,n);t||i||(s.saveNewState(),this._undoStack._addAction(s))}t||this.refresh(!1)}},t.prototype.freezeAtCursor=function(){var n=this,i,t,u,f,r,e;if(n.selectedSheet){if(n.selection&&n.frozenRows===0&&n.frozenColumns===0){if(n._ptScrl.y<0)for(i=0;i<n.selection.topRow-1;i++)if(r=n.rows[i],!(r instanceof w))if(r._pos+n._ptScrl.y<0)r.visible=!1;else{n.selectedSheet._freezeHiddenRowCnt=i;break}if(n._ptScrl.x<0)for(t=0;t<n.selection.leftCol-1;t++)if(e=n.columns[t],e._pos+n._ptScrl.x<0)n.columns[t].visible=!1;else{n.selectedSheet._freezeHiddenColumnCnt=t;break}u=n.selection.leftCol>0?n.selection.leftCol:0;f=n.selection.topRow>0?n.selection.topRow:0}else{for(i=0;i<n.frozenRows-1;i++)n.rows[i].visible=!0;for(t=0;t<n.frozenColumns-1;t++)n.columns[t].visible=!0;n._filter.apply();u=0;f=0;n.selectedSheet._freezeHiddenRowCnt=0;n.selectedSheet._freezeHiddenColumnCnt=0}n.frozenRows=n.selectedSheet.grid.frozenRows=f;n.frozenColumns=n.selectedSheet.grid.frozenColumns=u;setTimeout(function(){n._setFlexSheetToDirty();n.invalidate();n.scrollIntoView(n.selection.topRow,n.selection.leftCol)},10)}},t.prototype.showColumnFilter=function(){var n=this.selection.col>0?this.selection.col:0;this.columns.length>0&&this._filter.editColumnFilter(this.columns[n])},t.prototype.clear=function(){this.selection=new u.CellRange;this.sheets.clear();this._selectedSheetIndex=-1;this.columns.clear();this.rows.clear();this.columnHeaders.columns.clear();this.rowHeaders.rows.clear();this._undoStack.clear();this._ptScrl=new i.Point;this._clearCalcEngine();this.definedNames.clear();this.addUnboundSheet()},t.prototype.getSelectionFormatState=function(){var n,t,r=this.rows.length,u=this.columns.length,i={isBold:!1,isItalic:!1,isUnderline:!1,textAlign:'left',isMergedCell:!1};if(r===0||u===0)return i;if(this.selection){if(this.selection.row>=r||this.selection.row2>=r||this.selection.col>=u||this.selection.col2>=u)return i;for(n=this.selection.topRow;n<=this.selection.bottomRow;n++)for(t=this.selection.leftCol;t<=this.selection.rightCol;t++)this._checkCellFormat(n,t,i)}return i},t.prototype.insertRows=function(n,t){var r=i.isNumber(n)&&n>=0?n:this.selection&&this.selection.topRow>-1?this.selection.topRow:0,f=i.isNumber(t)?t:1,e=new ft(this),s=this.rows[r],o;if(this.selectedSheet&&!this.itemsSource){for(this._clearCalcEngine(),this.finishEditing(),r===0&&s&&s.constructor===w&&(r=1),this.onPrepareChangingRow(),this._updateCellsForUpdatingRow(this.rows.length,r,f),e._affectedFormulas=this._updateAffectedFormula(r,f,!0,!0),this.rows.beginUpdate(),o=0;o<f;o++)this.rows.insert(r,new u.Row);this.rows.endUpdate();this.selection&&this.selection.row!==-1&&this.selection.col!==-1||(this.selection=new u.CellRange(0,0));this._copyTo(this.selectedSheet);e.saveNewState();this._undoStack._addAction(e);this.onRowChanged(new it(r,f,!0))}},t.prototype.deleteRows=function(n,t){var o=i.isNumber(t)&&t>=0?t:this.selection&&this.selection.topRow>-1?this.selection.bottomRow-this.selection.topRow+1:1,f=i.isNumber(n)&&n>=0?n:this.selection&&this.selection.topRow>-1?this.selection.topRow:-1,r=i.isNumber(n)&&n>=0?n+o-1:this.selection&&this.selection.topRow>-1?this.selection.bottomRow:-1,s=new ft(this),c=!1,e,l,h;if(this.selectedSheet&&!this.itemsSource&&(this._clearCalcEngine(),this.finishEditing(),f>-1&&r>-1)){for(this.onPrepareChangingRow(),this._updateCellsForUpdatingRow(this.rows.length,f,o,!0),s._affectedFormulas=this._updateAffectedFormula(r,r-f+1,!1,!0),this.rows.beginUpdate();r>=f;r--)(e=this.rows[r],e&&e.constructor===w)||(e.dataItem&&this.collectionView?(this.collectionView.beginUpdate(),l=this._getCvIndex(r),l>-1&&this.itemsSource.splice(r-1,1),this.collectionView.endUpdate()):this.rows.removeAt(r),c=!0);if(this.rows.endUpdate(),h=this.rows.length,h===0?(this.selectedSheet.selectionRanges.clear(),this.select(new u.CellRange),this.hostElement.style.cursor==='move'&&(this.hostElement.style.cursor='default')):r===h-1?this.select(new u.CellRange(r,0,r,this.columns.length-1)):this.select(new u.CellRange(this.selection.topRow,this.selection.col,this.selection.topRow,this.selection.col2)),this._copyTo(this.selectedSheet),c){s.saveNewState();this._undoStack._addAction(s);this.onRowChanged(new it(f,o,!1))}}},t.prototype.insertColumns=function(n,t){var r=i.isNumber(n)&&n>=0?n:this.selection&&this.selection.leftCol>-1?this.selection.leftCol:0,f=i.isNumber(t)?t:1,e=new ut(this),o,s;if(this.selectedSheet&&!this.itemsSource){for(this._clearCalcEngine(),this.finishEditing(),this.onPrepareChangingColumn(),this._updateCellsForUpdatingColumn(this.columns.length,r,f),e._affectedFormulas=this._updateAffectedFormula(r,f,!0,!1),this.columns.beginUpdate(),s=0;s<f;s++)o=new u.Column,o.isRequired=!1,this.columns.insert(r,o);this.columns.endUpdate();this.selection&&this.selection.row!==-1&&this.selection.col!==-1||(this.selection=new u.CellRange(0,0));this._copyTo(this.selectedSheet);e.saveNewState();this._undoStack._addAction(e);this.onColumnChanged(new it(r,f,!0))}},t.prototype.deleteColumns=function(n,t){var e,o=i.isNumber(t)&&t>=0?t:this.selection&&this.selection.leftCol>-1?this.selection.rightCol-this.selection.leftCol+1:1,f=i.isNumber(n)&&n>=0?n:this.selection&&this.selection.leftCol>-1?this.selection.leftCol:-1,r=i.isNumber(n)&&n>=0?n+o-1:this.selection&&this.selection.leftCol>-1?this.selection.rightCol:-1,s=new ut(this);if(this.selectedSheet&&!this.itemsSource&&(this._clearCalcEngine(),this.finishEditing(),f>-1&&r>-1)){for(this.onPrepareChangingColumn(),this._updateCellsForUpdatingColumn(this.columns.length,f,o,!0),s._affectedFormulas=this._updateAffectedFormula(r,r-f+1,!1,!1),this.columns.beginUpdate();r>=f;r--)this.columns.removeAt(r),this._sortManager.deleteSortLevel(r);this.columns.endUpdate();this._sortManager.commitSort(!1);e=this.columns.length;e===0?(this.selectedSheet.selectionRanges.clear(),this.select(new u.CellRange),this.hostElement.style.cursor==='move'&&(this.hostElement.style.cursor='default')):r===e-1?this.select(new u.CellRange(0,r,this.rows.length-1,r)):this.select(new u.CellRange(this.selection.row,this.selection.leftCol,this.selection.row2,this.selection.leftCol));this._copyTo(this.selectedSheet);s.saveNewState();this._undoStack._addAction(s);this.onColumnChanged(new it(f,o,!1))}},t.prototype.mergeRange=function(n,t){t===void 0&&(t=!1);var r,f,s,i=n||this.selection,o,e=-1;if(this.selectedSheet){if(i){if(i.rowSpan===1&&i.columnSpan===1)return;if(n||t||(o=new et(this),this.hostElement.focus()),!this._resetMergedRange(i)){for(r=i.topRow;r<=i.bottomRow;r++)if(e<0&&this.rows[r].visible&&(e=r),!(e<0))for(f=i.leftCol;f<=i.rightCol;f++)s=r*this.columns.length+f,this.selectedSheet._mergedRanges[s]=new u.CellRange(e,i.leftCol,i.bottomRow,i.rightCol);n||t||(o.saveNewState(),this._undoStack._addAction(o))}}n||this.refresh()}},t.prototype.getMergedRange=function(t,i,r,f){f===void 0&&(f=!0);var l=i*this.columns.length+r,e=this.selectedSheet?this.selectedSheet._mergedRanges[l]:null,h,o,c,s;return t===this.cells&&e?!e.isSingleCell&&(this.frozenRows>0||this.frozenColumns>0)&&(e.topRow<this.frozenRows&&e.bottomRow>=this.frozenRows||e.leftCol<this.frozenColumns&&e.rightCol>=this.frozenColumns)?(h=e.topRow,o=e.bottomRow,c=e.leftCol,s=e.rightCol,i>=this.frozenRows&&e.topRow<this.frozenRows&&(h=this.frozenRows),i<this.frozenRows&&e.bottomRow>=this.frozenRows&&(o=this.frozenRows-1),o>=this.rows.length&&(o=this.rows.length-1),r>=this.frozenColumns&&e.leftCol<this.frozenColumns&&(c=this.frozenColumns),r<this.frozenColumns&&e.rightCol>=this.frozenColumns&&(s=this.frozenColumns-1),s>=this.columns.length&&(s=this.columns.length-1),new u.CellRange(h,c,o,s)):e.bottomRow>=this.rows.length?new u.CellRange(e.topRow,e.leftCol,this.rows.length-1,e.rightCol):e.rightCol>=this.columns.length?new u.CellRange(e.topRow,e.leftCol,e.bottomRow,this.columns.length-1):e.clone():r>=0&&this.columns&&this.columns.length>r&&i>=0&&this.rows&&this.rows.length>r?n.prototype.getMergedRange.call(this,t,i,r,f):null},t.prototype.evaluate=function(n,t,i){return this._evaluate(n,t,i)},t.prototype.getCellValue=function(n,t,r,u){r===void 0&&(r=!1);var e=u?u.grid.columns[t]:this.columns[t],s=this._getCellStyle(n,t,u),o,f;return o=s&&s.format?s.format:'',f=u?u.grid.getCellData(n,t,!1):this.getCellData(n,t,!1),i.isString(f)&&f[0]==='='&&(f=this._evaluate(f,r?o:'',u,n,t)),i.isPrimitive(f)?r&&(e.dataMap&&(f=e.dataMap.getDisplayValue(f)),f=!i.isInt(f)||e.format||e.dataMap||o?f!=null?i.Globalize.format(f,o||e.format):'':f.toString()):f&&(f=r?!i.isInt(f.value)||e.format||e.dataMap||o||f.format?f.value!=null?i.Globalize.format(f.value,o||f.format||e.format):'':f.value.toString():f.value),f==null?'':f},t.prototype.showFunctionList=function(n){var t=this,e=t._cumulativeOffset(n),f=t._cumulativeOffset(t._root),r,u;t._functionTarget=i.tryCast(n,HTMLInputElement);t._functionTarget&&t._functionTarget.value&&t._functionTarget.value[0]==='='?(t._functionList._cv.filter=function(n){var u=n.actualvalue.toLowerCase(),i=t._getCurrentFormulaIndex(t._functionTarget.value),r;return(i===-1&&(i=0),r=t._functionTarget.value.substr(i+1).trim().toLowerCase(),r.length>0&&u.indexOf(r)===0||t._functionTarget.value==='=')?!0:!1},t._functionList.selectedIndex=0,r=e.y+n.clientHeight+2+(i.hasClass(n,'wj-grid-editor')?this._ptScrl.y:0),u=e.x+(i.hasClass(n,'wj-grid-editor')?this._ptScrl.x:0),i.setCss(t._functionListHost,{height:t._functionList._cv.items.length>5?'218px':'auto',display:t._functionList._cv.items.length>0?'block':'none',top:'',left:''}),t._functionListHost.scrollTop=0,t._functionListHost.offsetHeight+r>f.y+t._root.offsetHeight?r=r-n.clientHeight-t._functionListHost.offsetHeight-5:r+=5,t._functionListHost.offsetWidth+u>f.x+t._root.offsetWidth&&(u=f.x+t._root.offsetWidth-t._functionListHost.offsetWidth),i.setCss(t._functionListHost,{top:r,left:u})):t.hideFunctionList()},t.prototype.hideFunctionList=function(){this._functionListHost.style.display='none'},t.prototype.selectPreviousFunction=function(){var n=this._functionList.selectedIndex;n>0&&this._functionList.selectedIndex--},t.prototype.selectNextFunction=function(){var n=this._functionList.selectedIndex;n<this._functionList.itemsSource.length&&this._functionList.selectedIndex++},t.prototype.applyFunctionToCell=function(){var n=this,t;n._functionTarget&&(t=n._getCurrentFormulaIndex(n._functionTarget.value),t===-1?t=n._functionTarget.value.indexOf('='):t+=1,n._functionTarget.value=n._functionTarget.value.substring(0,t)+n._functionList.selectedValue+'(',n._functionTarget.value[0]!=='='&&(n._functionTarget.value='='+n._functionTarget.value),n._functionTarget.focus(),n.hideFunctionList())},t.prototype.save=function(n){var t=this._saveToWorkbook();return n&&t.save(n),t},t.prototype.saveAsync=function(n,t,i){var r=this._saveToWorkbook();return n&&r.saveAsync(n,t,i),r},t.prototype.saveToWorkbookOM=function(){var n=this._saveToWorkbook();return n._serialize()},t.prototype.load=function(n){var t,u,f=this;if(n instanceof Blob)u=new FileReader,u.onload=function(){var n=u.result;n=r.Workbook._base64EncArr(new Uint8Array(n));t=new r.Workbook;t.load(n);f._loadFromWorkbook(t)},u.readAsArrayBuffer(n);else if(n instanceof r.Workbook)f._loadFromWorkbook(n);else{if(n instanceof ArrayBuffer)n=r.Workbook._base64EncArr(new Uint8Array(n));else if(!i.isString(n))throw'Invalid workbook.';t=new r.Workbook;t.load(n);f._loadFromWorkbook(t)}},t.prototype.loadAsync=function(n,t,u){var f,e,o=this;if(n instanceof Blob)e=new FileReader,e.onload=function(){var n=e.result;n=r.Workbook._base64EncArr(new Uint8Array(n));f=new r.Workbook;f.loadAsync(n,function(n){o._loadFromWorkbook(n);t&&t(n)},u)},e.readAsArrayBuffer(n);else if(n instanceof r.Workbook)o._loadFromWorkbook(n),t&&t(n);else{if(n instanceof ArrayBuffer)n=r.Workbook._base64EncArr(new Uint8Array(n));else if(!i.isString(n))throw'Invalid workbook.';f=new r.Workbook;f.loadAsync(n,function(n){o._loadFromWorkbook(n);t&&t(n)},u)}},t.prototype.loadFromWorkbookOM=function(n){var t;n instanceof r.Workbook?t=n:(t=new r.Workbook,t._deserialize(n));this._loadFromWorkbook(t)},t.prototype.undo=function(){var n=this;setTimeout(function(){n._undoStack.undo()},100)},t.prototype.redo=function(){var n=this;setTimeout(function(){n._undoStack.redo()},100)},t.prototype.select=function(t,i){i===void 0&&(i=!0);var r,u,f;if(t.rowSpan!==this.rows.length&&t.columnSpan!==this.columns.length)for(u=t.topRow;u<=t.bottomRow;u++)for(f=t.leftCol;f<=t.rightCol;f++)r=this.getMergedRange(this.cells,u,f),r&&!t.equals(r)&&(t.row<=t.row2?(t.row=Math.min(t.topRow,r.topRow),t.row2=Math.max(t.bottomRow,r.bottomRow)):(t.row=Math.max(t.bottomRow,r.bottomRow),t.row2=Math.min(t.topRow,r.topRow)),t.col<=t.col2?(t.col=Math.min(t.leftCol,r.leftCol),t.col2=Math.max(t.rightCol,r.rightCol)):(t.col=Math.max(t.rightCol,r.rightCol),t.col2=Math.min(t.leftCol,r.leftCol)));this.collectionView&&t.topRow===0&&t.bottomRow===this.rows.length-1&&t.leftCol===0&&t.rightCol===this.columns.length-1&&(t.row=1,t.row2=this.rows.length-1);n.prototype.select.call(this,t,i)},t.prototype.addCustomFunction=function(n,t,r,u,f){i._deprecated('addCustomFunction','addFunction');this._calcEngine.addCustomFunction(n,t,u,f);this._addCustomFunctionDescription(n,r)},t.prototype.addFunction=function(n,t,i,r,u){this._calcEngine.addFunction(n,t,r,u);this._addCustomFunctionDescription(n,i)},t.prototype.dispose=function(){var t=window.navigator.userAgent;document.removeEventListener('mousemove',this._mouseMoveHdl);document.body.removeEventListener('click',this._clickHdl);(t.match(/iPad/i)||t.match(/iPhone/i))&&(document.body.removeEventListener('touchstart',this._touchStartHdl),document.body.removeEventListener('touchend',this._touchEndHdl));this.hideFunctionList();n.prototype.dispose.call(this)},t.prototype.getClipString=function(n){var t='',r,a,f,h=!0,e,s,c,l,o;if(!n){if(this._isMultipleRowsSelected()){for(t='',r=this.selectedSheet.selectionRanges.slice(0),r.length===0&&(r=[this.selection]),r.sort(this._sortByRow),f=0;f<r.length;f++)t&&(t+='\n'),t+=this.getClipString(r[f]);return t}if(this._isMultipleColumnsSelected())for(t='',r=this.selectedSheet.selectionRanges.slice(0),r.length===0&&(r=[this.selection]),r.sort(this._sortByColumn),a=0,h=!0;a<this.rows.length;a++){for(h||(t+='\n'),h=!1,f=0,o=!0;f<r.length;f++)o||(t+='\t'),o=!1,t+=this.getClipString(r[f]);return t}else{n=this.selection;switch(this.selectionMode){case u.SelectionMode.Row:case u.SelectionMode.RowRange:n.col=0;n.col2=this.columns.length-1;break;case u.SelectionMode.ListBox:for(n.col=0,n.col2=this.columns.length-1,s=0;s<this.rows.length;s++)this.rows[s].isSelected&&this.rows[s].isVisible&&(n.row=n.row2=s,t&&(t+='\n'),t+=this.getClipString(n));return t}}}for(n=i.asType(n,u.CellRange),c=n.topRow;c<=n.bottomRow;c++)if(this.rows[c].isVisible)for(h||(t+='\n'),h=!1,l=n.leftCol,o=!0;l<=n.rightCol;l++)this.columns[l].isVisible&&(o||(t+='\t'),o=!1,e=this.getCellValue(c,l,!0).toString(),e=e.replace(/\t/g,' '),e.indexOf('\n')>-1&&(e='"'+e.replace(/"/g,'""')+'"'),t+=e);return t},t.prototype.setClipString=function(t,f){var ct=f==null,ft=!1,h,s,o,k,y,d,et,c,p,w,g,nt,v,ht,ot,tt,e,st=!1,l,a,it,rt,ut,b;if(f=f?i.asType(f,u.CellRange):this.selection,t=i.asString(t).replace(/\r\n/g,'\n').replace(/\r/g,'\n'),t&&t[t.length-1]=='\n'&&(t=t.substring(0,t.length-1)),ut=t,ct&&!f.isSingleCell&&(t=this._edtHdl._expandClipString(t,f)),d=this._edtHdl._clipToRows(t),st=this._containsMultiLineText(d),(!this._copiedRanges||this._copiedRanges.length===0||ut!==this._getRangeString(this._copiedRanges,this._copiedSheet)&&!this._containsRandFormula(this._copiedRanges,this._copiedSheet)||!!this._cutData)&&!st){this._cutData!=null?(this.beginUpdate(),this._delCutData(),n.prototype.setClipString.call(this,this._cutData,f),this.endUpdate(),this._cutData=null,this._cutValue=ut):(this._cutValue===null||ut!==this._cutValue)&&(this._cutValue=null,n.prototype.setClipString.call(this,t,f));this._copiedRanges=null;this._copiedSheet=null;return}if(h=new u.CellRange(f.topRow,f.leftCol),this.beginUpdate(),st||!this._copiedRanges||this._copiedRanges.length>1||this._copiedRanges.length===0)for(s=f.topRow,e=this._copiedRanges&&this._copiedRanges.length>1?this._copiedRanges[0]:new u.CellRange,k=e.topRow,w=0;w<d.length&&s<this.rows.length;w++,s++){if(!this.rows[s].isVisible){w--;continue}for(et=this._edtHdl._clipToCells(d[w]),y=e.leftCol,o=f.leftCol,tt=o-y,b=0;b<et.length&&o<this.columns.length;b++,o++){if(!this.columns[o].isVisible){b--;continue}c=et[b];this.columns[o].isReadOnly||this.rows[s].isReadOnly||(ft=this._postSetClipStringProcess(c,s,o,k,y),h.row2=Math.max(h.row2,s),h.col2=Math.max(h.col2,o));y>=0&&y++}k>=0&&k++}else if(this._copiedRanges&&this._copiedRanges.length===1)for(l=0,e=this._copiedRanges[0],it=e.rowSpan>f.rowSpan?e.rowSpan:f.rowSpan,rt=e.columnSpan>f.columnSpan?e.columnSpan:f.columnSpan,s=f.topRow;s<f.topRow+it&&s<this.rows.length;s++)if(a=0,this.rows[s].isVisible){if(l>=e.rowSpan)if(it%e.rowSpan==0&&rt%e.columnSpan==0)l=l%e.rowSpan;else break;for(ot=s-e.topRow-l,o=f.leftCol;o<f.leftCol+rt&&o<this.columns.length;o++)if(this.columns[o].isVisible){if(a>=e.columnSpan)if(it%e.rowSpan==0&&rt%e.columnSpan==0)a=a%e.columnSpan;else break;if(tt=o-e.leftCol-a,!this.columns[o].isReadOnly&&!this.rows[s].isReadOnly){if(c=this._copiedSheet.grid.getCellData(e.topRow+l,e.leftCol+a,!0).toString(),!!c&&typeof c=='string'&&c[0]==='='&&(ot!==0||tt!==0)&&(p=c.match(/(?=\b\D)\$?[A-Za-z]+\$?\d+/g),!!p&&p.length>0))for(g=0;g<p.length;g++)nt=p[g],nt.toLowerCase()!=='atan2'&&(v=r.Workbook.tableAddress(nt),v.row+=ot,v.col+=tt,ht=r.Workbook.xlsxAddress(v.row,v.col,v.absRow,v.absCol),c=c.replace(nt,ht));ft=this._postSetClipStringProcess(c,s,o,e.topRow+l,e.leftCol+a);h.row2=Math.max(h.row2,s);h.col2=Math.max(h.col2,o)}a++}l++}this.endUpdate();this.collectionView&&ft&&this.collectionView.refresh();this.select(h)},t.prototype._getCvIndex=function(t){var i;return t>-1&&this.collectionView?(i=this.rows[t],i instanceof w?t:n.prototype._getCvIndex.call(this,t)):-1},t.prototype._init=function(){var f=this,n=this,t=window.navigator.userAgent,r=function(t){document.removeEventListener('mouseup',r);n._mouseUp(t)};n.hostElement.setAttribute('tabindex','-1');n._divContainer=n.hostElement.querySelector('[wj-part="container"]');n._tabHolder=new vt(n.hostElement.querySelector('[wj-part="tab-holder"]'),n);n._contextMenu=new at(n.hostElement.querySelector('[wj-part="context-menu"]'),n);n._gpCells=new rt(n,u.CellType.Cell,n.rows,n.columns,n._eCt);n._gpCHdr=new rt(n,u.CellType.ColumnHeader,n._hdrRows,n.columns,n._eCHdrCt);n._gpRHdr=new rt(n,u.CellType.RowHeader,n.rows,n._hdrCols,n._eRHdrCt);n._gpTL=new rt(n,u.CellType.TopLeft,n._hdrRows,n._hdrCols,n._eTLCt);n._sortManager=new fi(n);n._filter=new ai(n);n._calcEngine=new wt(n);n._calcEngine.unknownFunction.addHandler(function(t,i){n.onUnknownFunction(i)},n);n._initFuncsList();n._undoStack=new ei(n);n.loadedRows.addHandler(function(){var t,r,i;if(n.itemsSource&&!(n.rows[0]instanceof w)){for(t=new w,i=0;i<n.columns.length;i++)r=n.columns[i],t._ubv||(t._ubv={}),t._ubv[r._hash]=r.header;n.rows.insert(0,t)}n._filter&&n._filter.apply()});n.itemsSourceChanged.addHandler(function(){for(var t=0;t<n.columns.length;t++)n.columns[t].isRequired=!1});n.copied.addHandler(function(t,i){var r;n._copiedSheet=n.selectedSheet;n._isMultipleRowsSelected()?(r=n.selectedSheet.selectionRanges.slice(0),r.sort(n._sortByRow),n._copiedRanges=r):n._isMultipleColumnsSelected()?(r=n.selectedSheet.selectionRanges.slice(0),r.sort(n._sortByColumn),n._copiedRanges=r):n._copiedRanges=[i.range]});n.rows.collectionChanged.addHandler(function(){n._clearForEmptySheet('rows')},n);n.columns.collectionChanged.addHandler(function(){n._clearForEmptySheet('columns')},n);n.definedNames.collectionChanged.addHandler(function(t,r){if(r.action===i.NotifyCollectionChangedAction.Add||r.action===i.NotifyCollectionChangedAction.Change){if(!(r.item&&r.item.name&&r.item.value!=null)){n.definedNames.remove(r.item);throw'Invalidate defined name was '+(r.action===i.NotifyCollectionChangedAction.Add?'inserted.':'updated.');}if(r.item.sheetName!=null&&!n._validateSheetName(r.item.sheetName)){n.definedNames.remove(r.item);throw'The sheet name:('+r.item.sheetName+') does not exist in FlexSheet.';}}});n.addEventListener(n.hostElement,'mousedown',function(t){document.addEventListener('mouseup',r);n._isDescendant(n._divContainer,t.target)&&n._mouseDown(t)},!0);n.addEventListener(n.hostElement,'drop',function(){n._columnHeaderClicked=!1});n.addEventListener(n.hostElement,'contextmenu',function(t){var r,o,s,h,c,v,l,a,e;t.defaultPrevented||n.activeEditor||(n._isContextMenuKeyDown&&n.selection.row>-1&&n.selection.col>-1&&n.rows.length>0&&n.columns.length>0?(s=n.columns[n.selection.col],o=n.rows[n.selection.row],l=n._cumulativeOffset(n.hostElement),a=n._cumulativeScrollOffset(n.hostElement),h=s.pos+n._eCt.offsetLeft+l.x+s.renderSize/2+n._ptScrl.x,c=o.pos+n._eCt.offsetTop+l.y+o.renderSize/2+n._ptScrl.y,v=new i.Point(h-a.x,c-a.y),r=n.hitTest(h,c),n._isContextMenuKeyDown=!1):r=n.hitTest(t),t.preventDefault(),r&&r.cellType!==u.CellType.None&&(f.itemsSource||n._contextMenu.show(t,v),e=new u.CellRange(r.row,r.col),r.cellType!==u.CellType.Cell||e.intersects(n.selection)||(n.selectedSheet&&n.selectedSheet.selectionRanges.clear(),n.selection=e,n.selectedSheet.selectionRanges.push(e))))});n.prepareCellForEdit.addHandler(n._prepareCellForEditHandler,n);n.cellEditEnded.addHandler(function(t,i){i.data&&(i.data.keyCode===46||i.data.keyCode===8)||setTimeout(function(){n.hideFunctionList()},200)});n.cellEditEnding.addHandler(function(t,i){i.data&&(i.data.keyCode===46||i.data.keyCode===8)||n._clearCalcEngine()});n.pasted.addHandler(function(){n._clearCalcEngine()});n.addEventListener(n.hostElement,'keydown',function(t){var r,e,f;if(t.ctrlKey&&(t.keyCode===89&&(n.finishEditing(),n.redo(),t.preventDefault()),t.keyCode===90&&(n.finishEditing(),n.undo(),t.preventDefault()),!n.selectedSheet||t.keyCode!==65||(n.selectedSheet.selectionRanges.clear(),n.selectedSheet.selectionRanges.push(n.selection)),(t.keyCode===67||t.keyCode==45)&&(!n.activeEditor||(n._copiedRanges=null,n._copiedSheet=null),n._cutValue=null),t.keyCode===88)){if(n.finishEditing(),r=new u.CellRangeEventArgs(n.cells,n.selection),n.onCopying(r)){n._cutData=null;n._cutValue=null;e=n.getClipString();n._cutData=n._getRangeString(n.selection,n.selectedSheet,!1);i.Clipboard.copy(e);n.onCopied(r)}t.stopPropagation()}if(t.keyCode===i.Key.Escape&&n._contextMenu.hide(),(t.keyCode===93||t.shiftKey&&t.keyCode===121)&&(n._isContextMenuKeyDown=!0),!!n.selectedSheet)switch(t.keyCode){case i.Key.Left:case i.Key.Right:case i.Key.Up:case i.Key.Down:case i.Key.PageUp:case i.Key.PageDown:case i.Key.Home:case i.Key.End:case i.Key.Tab:case i.Key.Enter:f=n.selectedSheet.selectionRanges.length;f>0&&(n.selectedSheet.selectionRanges[f-1]=n.selection)}});n.addEventListener(document.body,'keydown',function(t){(n._isDescendant(n.hostElement,t.target)||n.hostElement===t.target)&&!n._edtHdl.activeEditor&&(t.keyCode===i.Key.Delete||t.keyCode===i.Key.Back)&&(n._delSeletionContent(t),t.preventDefault())},!0);document.body.addEventListener('click',n._clickHdl);document.addEventListener('mousemove',n._mouseMoveHdl);(t.match(/iPad/i)||t.match(/iPhone/i))&&(document.body.addEventListener('touchstart',n._touchStartHdl),document.body.addEventListener('touchend',n._touchEndHdl));n.addEventListener(n.hostElement,'drop',function(){n._htDown=null})},t.prototype._initFuncsList=function(){var n=this;n._functionListHost=document.createElement('div');i.addClass(n._functionListHost,'wj-flexsheet-formula-list');document.querySelector('body').appendChild(n._functionListHost);n._functionListHost.style.display='none';n._functionListHost.style.position='absolute';n._functionList=new f.ListBox(n._functionListHost);n._functionList.isContentHtml=!0;n._functionList.itemsSource=n._getFunctions();n._functionList.displayMemberPath='displayValue';n._functionList.selectedValuePath='actualvalue';n.addEventListener(n._functionListHost,'click',n.applyFunctionToCell.bind(n));n.addEventListener(n._functionListHost,'keydown',function(t){t.keyCode===i.Key.Escape&&(n.hideFunctionList(),n.hostElement.focus(),t.preventDefault());t.keyCode===i.Key.Enter&&(n.applyFunctionToCell(),n.hostElement.focus(),t.preventDefault(),t.stopPropagation())})},t.prototype._getFunctions=function(){for(var i=[],t=0,n;t<ni.length;t++)n=ni[t],i.push({displayValue:'<div class="wj-flexsheet-formula-name">'+n.name+'</div><div class="wj-flexsheet-formula-description">'+n.description+'</div>',actualvalue:n.name});return i},t.prototype._addCustomFunctionDescription=function(n,t){for(var f={displayValue:'<div class="wj-flexsheet-formula-name">'+n+'</div>'+(t?'<div class="wj-flexsheet-formula-description">'+t+'</div>':''),actualvalue:n},i=this._functionList.itemsSource,u=-1,r=0,e;r<i.length;r++)if(e=i[r],e.actualvalue===n){u=r;break}u>-1?i.splice(u,1,f):i.push(f)},t.prototype._getCurrentFormulaIndex=function(n){var t=-1;return['+','-','*','/','^','(','&'].forEach(function(i){var r=n.lastIndexOf(i);r>t&&(t=r)}),t},t.prototype._prepareCellForEditHandler=function(){var n=this,t=n._edtHdl._edt;t&&(n.addEventListener(t,'keydown',function(t){if(n.isFunctionListOpen)switch(t.keyCode){case i.Key.Up:n.selectPreviousFunction();t.preventDefault();t.stopPropagation();break;case i.Key.Down:n.selectNextFunction();t.preventDefault();t.stopPropagation();break;case i.Key.Tab:case i.Key.Enter:n.applyFunctionToCell();t.preventDefault();t.stopPropagation();break;case i.Key.Escape:n.hideFunctionList();t.preventDefault();t.stopPropagation()}}),n.addEventListener(t,'keyup',function(r){(r.keyCode>40||r.keyCode<32)&&r.keyCode!==i.Key.Tab&&r.keyCode!==i.Key.Escape&&setTimeout(function(){n.showFunctionList(t)},0)}))},t.prototype._addSheet=function(n,t,i,r,u){var f=this,e=new ri(f,u,n,t,i);return f.sheets.isValidSheetName(e)||e._setValidName(f.sheets.getValidSheetName(e)),e.nameChanged.addHandler(function(n,t){f._updateDefinedNameWithSheetRefUpdating(t.oldValue,t.newValue)}),typeof r=='number'?(r<0&&(r=0),r>=f.sheets.length&&(r=f.sheets.length)):r=f.sheets.length,f.sheets.insert(r,e),r<=f._selectedSheetIndex&&(f._selectedSheetIndex+=1),f.selectedSheetIndex=r,e},t.prototype._showSheet=function(n){!this.sheets||!this.sheets.length||n>=this.sheets.length||n<0||n===this.selectedSheetIndex||this.sheets[n]&&!this.sheets[n].visible||(this.finishEditing(),this.selectedSheetIndex>-1&&this.selectedSheetIndex<this.sheets.length&&(this._copyTo(this.sheets[this.selectedSheetIndex]),this._resetFilterDefinition()),this.sheets[n]&&(this._selectedSheetIndex=n,this._copyFrom(this.sheets[n])),this._filter.closeEditor())},t.prototype._selectedSheetChange=function(n,t){this._showSheet(t.newValue);this.invalidate(!0);this.onSelectedSheetChanged(t)},t.prototype._sourceChange=function(n,t){var r,u;if(t.action===i.NotifyCollectionChangedAction.Add||t.action===i.NotifyCollectionChangedAction.Change)r=t.item,r._attachOwner(this),t.action===i.NotifyCollectionChangedAction.Add?(this._addingSheet=!0,t.index<=this.selectedSheetIndex&&(this._selectedSheetIndex+=1)):t.index===this.selectedSheetIndex&&this._copyFrom(t.item,!0),this.selectedSheetIndex=t.index;else if(t.action===i.NotifyCollectionChangedAction.Reset){for(u=0;u<this.sheets.length;u++)r=this.sheets[u],r._attachOwner(this);this.sheets.length>0?(this.selectedSheetIndex===0&&this._copyFrom(this.selectedSheet,!0),this.selectedSheetIndex=0):(this.rows.clear(),this.columns.clear(),this._selectedSheetIndex=-1)}else this.sheets.length>0?this.selectedSheetIndex>=this.sheets.length?this.selectedSheetIndex=0:this.selectedSheetIndex>t.index&&(this._selectedSheetIndex-=1):(this.rows.clear(),this.columns.clear(),this._selectedSheetIndex=-1);this.invalidate(!0)},t.prototype._sheetVisibleChange=function(n,t){t.item.visible||t.index===this.selectedSheetIndex&&(this.selectedSheetIndex=this.selectedSheetIndex===this.sheets.length-1?t.index-1:t.index+1)},t.prototype._applyStyleForCell=function(n,t,i){var u=this,o=u.rows[n],r,e,f;o==null||o instanceof w||!o.isVisible||(f=n*u.columns.length+t,e=u.selectedSheet._mergedRanges[f],e&&(f=e.topRow*u.columns.length+e.leftCol),r=u.selectedSheet._styledCells[f],r?(r.className=i.className==='normal'?'':i.className||r.className,r.textAlign=i.textAlign||r.textAlign,r.verticalAlign=i.verticalAlign||r.verticalAlign,r.fontFamily=i.fontFamily||r.fontFamily,r.fontSize=i.fontSize||r.fontSize,r.backgroundColor=i.backgroundColor||r.backgroundColor,r.color=i.color||r.color,r.fontStyle=i.fontStyle==='none'?'':i.fontStyle||r.fontStyle,r.fontWeight=i.fontWeight==='none'?'':i.fontWeight||r.fontWeight,r.textDecoration=i.textDecoration==='none'?'':i.textDecoration||r.textDecoration,r.format=i.format||r.format,r.whiteSpace=i.whiteSpace||r.whiteSpace):u.selectedSheet._styledCells[f]={className:i.className,textAlign:i.textAlign,verticalAlign:i.verticalAlign,fontStyle:i.fontStyle,fontWeight:i.fontWeight,fontFamily:i.fontFamily,fontSize:i.fontSize,textDecoration:i.textDecoration,backgroundColor:i.backgroundColor,color:i.color,format:i.format,whiteSpace:i.whiteSpace})},t.prototype._checkCellFormat=function(n,t,i){var f=n*this.columns.length+t,u,r;this.selectedSheet&&(u=this.selectedSheet._mergedRanges[f],u&&(i.isMergedCell=!0,f=u.topRow*this.columns.length+u.leftCol),r=this.selectedSheet._styledCells[f],r&&(i.isBold=i.isBold||r.fontWeight==='bold',i.isItalic=i.isItalic||r.fontStyle==='italic',i.isUnderline=i.isUnderline||r.textDecoration==='underline'),n===this.selection.row&&t===this.selection.col&&(r&&r.textAlign?i.textAlign=r.textAlign:t>-1&&(i.textAlign=this.columns[t].getAlignment()||i.textAlign)))},t.prototype._resetMergedRange=function(n){for(var r,e,u,f,o,t,s=!1,i=n.topRow;i<=n.bottomRow;i++)for(r=n.leftCol;r<=n.rightCol;r++)if(e=i*this.columns.length+r,t=this.selectedSheet._mergedRanges[e],t)for(s=!0,u=t.topRow;u<=t.bottomRow;u++)for(f=t.leftCol;f<=t.rightCol;f++)o=u*this.columns.length+f,delete this.selectedSheet._mergedRanges[o];return s},t.prototype._updateCellsForUpdatingRow=function(n,t,i,r){var l=this,s,f,e,o,u,h={},c=n*this.columns.length;if(r)for(s=t*this.columns.length,f=s;f<c;f++)e=f-i*this.columns.length,o=this.selectedSheet._styledCells[f],o&&(f>=(t+i)*this.columns.length&&(this.selectedSheet._styledCells[e]=o),delete this.selectedSheet._styledCells[f]),u=this.selectedSheet._mergedRanges[f],u&&(t<=u.topRow&&t+i>u.bottomRow?delete this.selectedSheet._mergedRanges[f]:u.bottomRow<t||u.topRow>=t+i?(u.topRow>t&&(u.row-=i),u.row2-=i,this.selectedSheet._mergedRanges[e]=u,delete this.selectedSheet._mergedRanges[f]):this._updateCellMergeRangeForRow(u,t,i,h,!0));else for(s=t*this.columns.length-1,f=c-1;f>s;f--)e=f+this.columns.length*i,o=this.selectedSheet._styledCells[f],o&&(this.selectedSheet._styledCells[e]=o,delete this.selectedSheet._styledCells[f]),u=this.selectedSheet._mergedRanges[f],u&&(u.topRow<t&&u.bottomRow>=t?this._updateCellMergeRangeForRow(u,t,i,h):(u.row+=i,u.row2+=i,this.selectedSheet._mergedRanges[e]=u,delete this.selectedSheet._mergedRanges[f]));Object.keys(h).forEach(function(n){l.selectedSheet._mergedRanges[n]=h[n]})},t.prototype._updateCellMergeRangeForRow=function(n,t,i,r,u){var e,s,o,c,l,h,f;if(u)for(e=n.topRow;e<=n.bottomRow;e++)for(s=n.leftCol;s<=n.rightCol;s++)o=e*this.columns.length+s,c=o-i*this.columns.length,h=this.selectedSheet._mergedRanges[o],h&&(f=h.clone(),f.row>t&&(f.row-=f.row-t),f.row2-=f.row2<t+i-1?f.row2-t+1:i,e<t?r[o]=f:(e>=t+i&&(r[c]=f),delete this.selectedSheet._mergedRanges[o]));else for(e=n.bottomRow;e>=n.topRow;e--)for(s=n.rightCol;s>=n.leftCol;s--)if(o=e*this.columns.length+s,h=this.selectedSheet._mergedRanges[o],h){for(f=h.clone(),f.row2+=i,e<t&&(r[o]=f.clone()),l=1;l<=i;l++)c=o+this.columns.length*l,r[c]=f;delete this.selectedSheet._mergedRanges[o]}},t.prototype._updateCellsForUpdatingColumn=function(n,t,i,r){var a=this,u,e,o,h,s,f,c={},l=this.rows.length*n;if(r)for(u=t;u<l;u++)h=Math.floor(u/n),s=u%n,e=u-i*(h+(s>=t?1:0)),o=this.selectedSheet._styledCells[u],o&&((s<t||s>=t+i)&&(this.selectedSheet._styledCells[e]=o),delete this.selectedSheet._styledCells[u]),f=this.selectedSheet._mergedRanges[u],f&&(t<=f.leftCol&&t+i>f.rightCol?delete this.selectedSheet._mergedRanges[u]:f.rightCol<t||f.leftCol>=t+i?(f.leftCol>=t&&(f.col-=i,f.col2-=i),this.selectedSheet._mergedRanges[e]=f,delete this.selectedSheet._mergedRanges[u]):this._updateCellMergeRangeForColumn(f,t,i,n,c,!0));else for(u=l-1;u>=t;u--)h=Math.floor(u/n),s=u%n,e=u+h*i+(s>=t?1:0),o=this.selectedSheet._styledCells[u],o&&(this.selectedSheet._styledCells[e]=o,delete this.selectedSheet._styledCells[u]),f=this.selectedSheet._mergedRanges[u],f&&(f.leftCol<t&&f.rightCol>=t?this._updateCellMergeRangeForColumn(f,t,i,n,c):(f.leftCol>=t&&(f.col+=i,f.col2+=i),this.selectedSheet._mergedRanges[e]=f,delete this.selectedSheet._mergedRanges[u]));Object.keys(c).forEach(function(n){a.selectedSheet._mergedRanges[n]=c[n]})},t.prototype._updateCellMergeRangeForColumn=function(n,t,i,r,u,f){var s,e,h,c,a,l,o;if(f)for(s=n.topRow;s<=n.bottomRow;s++)for(e=n.leftCol;e<=n.rightCol;e++)h=s*r+e,c=h-i*(s+(e>=t?1:0)),l=this.selectedSheet._mergedRanges[h],l&&(o=l.clone(),o.col>t&&(o.col-=o.col-t),o.col2-=o.col2<t+i-1?o.col2-t+1:i,(e<t||e>=t+i)&&(u[c]=o),delete this.selectedSheet._mergedRanges[h]);else for(s=n.bottomRow;s>=n.topRow;s--)for(e=n.rightCol;e>=n.leftCol;e--)if(h=s*r+e,c=h+s*i+(e>=t?1:0),l=this.selectedSheet._mergedRanges[h],l){if(o=l.clone(),o.col2+=i,e===t&&(u[c-1]=o.clone()),e>=t)for(a=0;a<i;a++)u[c+a]=o;else u[c]=o;delete this.selectedSheet._mergedRanges[h]}},t.prototype._cloneMergedCells=function(){var i,n,t;if(!this.selectedSheet)return null;if(n=this.selectedSheet._mergedRanges,null==n||"object"!=typeof n)return n;if(n instanceof Object){i={};for(t in n)n.hasOwnProperty(t)&&n[t]&&n[t].clone&&(i[t]=n[t].clone());return i}throw new Error("Unable to copy obj! Its type isn't supported.");},t.prototype._evaluate=function(n,t,i,r,u){return n&&n.length>1?(n=n[0]==='='?n:'='+n,this._calcEngine.evaluate(n,t,i,r,u)):n},t.prototype._copyTo=function(n){var t=this,o=n.grid.autoGenerateColumns,r,f,e;if(n._storeRowSettings(),n.grid.selection=new u.CellRange,n.grid.rows.clear(),n.grid.columns.clear(),n.grid.columnHeaders.columns.clear(),n.grid.rowHeaders.rows.clear(),t.itemsSource){if(n.grid.autoGenerateColumns=!1,n.itemsSource=t.itemsSource,n.grid.collectionView.beginUpdate(),!(n.grid.itemsSource instanceof i.CollectionView))for(n.grid.collectionView.sortDescriptions.clear(),e=0;e<t.collectionView.sortDescriptions.length;e++)n.grid.collectionView.sortDescriptions.push(t.collectionView.sortDescriptions[e])}else for(n.itemsSource=null,f=0;f<t.rows.length;f++)n.grid.rows.push(t.rows[f]);for(n._filterDefinition=t._filter.filterDefinition,r=0;r<t.columns.length;r++)n.grid.columns.push(t.columns[r]);n.grid.collectionView&&(t._resetMappedColumns(n.grid),n.grid.collectionView.endUpdate());n.grid.autoGenerateColumns=o;n.grid.frozenRows=t.frozenRows;n.grid.frozenColumns=t.frozenColumns;n.grid.selection=t.selection;n._scrollPosition=t.scrollPosition;setTimeout(function(){t._setFlexSheetToDirty();t.refresh(!0)},10)},t.prototype._copyFrom=function(n,t){t===void 0&&(t=!0);var r=this,l=r.autoGenerateColumns,e,f,o,s,c,h;if(r._isCopying=!0,r._dragable=!1,r.itemsSource=null,r.rows.clear(),r.columns.clear(),r.columnHeaders.columns.clear(),r.rowHeaders.rows.clear(),r.selection=new u.CellRange,n.selectionRanges.length>1&&r.selectionMode===u.SelectionMode.CellRange&&(r._enableMulSel=!0),n.itemsSource){if(r.autoGenerateColumns=!1,r.itemsSource=n.itemsSource,r.collectionView.beginUpdate(),!(r.itemsSource instanceof i.CollectionView))for(r.collectionView.sortDescriptions.clear(),o=0;o<n.grid.collectionView.sortDescriptions.length;o++)r.collectionView.sortDescriptions.push(n.grid.collectionView.sortDescriptions[o])}else for(f=0;f<n.grid.rows.length;f++)r.rows.push(n.grid.rows[f]);for(e=0;e<n.grid.columns.length;e++)c=n.grid.columns[e],c.isRequired=!1,r.columns.push(c);if(r.collectionView)for(r._resetMappedColumns(r),r.collectionView.endUpdate(),r.collectionView.collectionChanged.addHandler(function(n,t){t.action===i.NotifyCollectionChangedAction.Reset&&r.invalidate()},r),f=0;f<r.rows.length;f++)s=n._rowSettings[f],s&&(h=r.rows[f],h.height=s.height,h instanceof u.GroupRow&&(h.isCollapsed=s.isCollapsed));r.rows.length&&r.columns.length&&(r.selection=n.grid.selection);n._filterDefinition&&(r._filter.filterDefinition=n._filterDefinition);r.autoGenerateColumns=l;r.frozenRows=n.grid.frozenRows;r.frozenColumns=n.grid.frozenColumns;r._isCopying=!1;r._addingSheet?(r._toRefresh&&(clearTimeout(r._toRefresh),r._toRefresh=null),r._toRefresh=setTimeout(function(){r._setFlexSheetToDirty();r.invalidate()},10),r._addingSheet=!1):t&&r.refresh();r.scrollPosition=n._scrollPosition},t.prototype._resetMappedColumns=function(n){var t,i,r=0;if(n._mappedColumns=null,n.collectionView)for(i=n.collectionView.sortDescriptions;r<i.length;r++)t=n.columns.getColumn(i[r].property),t&&t.dataMap&&(n._mappedColumns||(n._mappedColumns={}),n._mappedColumns[t.binding]=t.dataMap)},t.prototype._resetFilterDefinition=function(){this._resettingFilter=!0;this._filter.filterDefinition=JSON.stringify({defaultFilterType:e.FilterType.Both,filters:[]});this._resettingFilter=!1},t.prototype._loadFromWorkbook=function(n){var f,i,r=0,t=this,u;if(n.sheets!=null&&n.sheets.length!==0){for(t.clear(),t._reservedContent=n.reservedContent,f=n.sheets.length;r<f;r++)r>0&&t.addUnboundSheet(),t.selectedSheet.grid.wj_sheetInfo={},o.FlexGridXlsxConverter.load(t.selectedSheet.grid,n,{sheetIndex:r,includeColumnHeaders:!1}),t.selectedSheet.name=t.selectedSheet.grid.wj_sheetInfo.name,t.selectedSheet.visible=t.selectedSheet.grid.wj_sheetInfo.visible,t.selectedSheet._styledCells=t.selectedSheet.grid.wj_sheetInfo.styledCells,t.selectedSheet._mergedRanges=t.selectedSheet.grid.wj_sheetInfo.mergedRanges,t._copyFrom(t.selectedSheet,!1);if(t.selectedSheetIndex=n.activeWorksheet!=null&&n.activeWorksheet>-1&&n.activeWorksheet<t.sheets.length?n.activeWorksheet:0,n.definedNames&&n.definedNames.length>0)for(u=0;u<n.definedNames.length;u++)i=n.definedNames[u],t.definedNames.push({name:i.name,value:i.value,sheetName:i.sheetName});t.onLoaded()}},t.prototype._saveToWorkbook=function(){var t,s,u,n,i,e,f;if(this.sheets.length===0)throw'The flexsheet is empty.';for(n=this.sheets[0],this.selectedSheetIndex===0&&(n._storeRowSettings(),n._setRowSettings()),t=o.FlexGridXlsxConverter.save(n.grid,{sheetName:n.name,sheetVisible:n.visible,includeColumnHeaders:!1}),t.reservedContent=this._reservedContent,i=1;i<this.sheets.length;i++)n=this.sheets[i],this.selectedSheetIndex===i&&(n._storeRowSettings(),n._setRowSettings()),s=o.FlexGridXlsxConverter.save(n.grid,{sheetName:n.name,sheetVisible:n.visible,includeColumnHeaders:!1}),t._addWorkSheet(s.sheets[0],i);for(t.activeWorksheet=this.selectedSheetIndex,e=0;e<this.definedNames.length;e++)f=this.definedNames[e],u=new r.DefinedName,u.name=f.name,u.value=f.value,u.sheetName=f.sheetName,t.definedNames.push(u);return t},t.prototype._mouseDown=function(n){var e=window.navigator.userAgent,t=this.hitTest(n),o=this.columns,r,f;if(this._wholeColumnsSelected=!1,this._dragable){this._isDragging=!0;this._draggingMarker=document.createElement('div');i.setCss(this._draggingMarker,{position:'absolute',display:'none',borderStyle:'dotted',cursor:'move'});document.body.appendChild(this._draggingMarker);this._draggingTooltip=new i.Tooltip;this._draggingCells=this.selection;this.selectedSheet&&this.selectedSheet.selectionRanges.clear();this.onDraggingRowColumn(new ti(this._draggingRow,n.shiftKey));n.preventDefault();return}if((t.cellType!==u.CellType.None&&(this._isClicking=!0),this.selectionMode===u.SelectionMode.CellRange?n.ctrlKey?this._enableMulSel||(this._enableMulSel=!0):t.cellType!==u.CellType.None&&(this.selectedSheet&&this.selectedSheet.selectionRanges.clear(),this._enableMulSel&&this.refresh(!1),this._enableMulSel=!1):(this._enableMulSel=!1,this.selectedSheet&&this.selectedSheet.selectionRanges.clear()),this._htDown=t,this.rows.length!==0&&this.columns.length!==0)&&(e.match(/iPad/i)||e.match(/iPhone/i)||this._contextMenu.hide(),this.selectionMode===u.SelectionMode.CellRange)){if(t.cellType===u.CellType.RowHeader&&n.which===3){f=new u.CellRange(t.row,0,t.row,this.columns.length-1);this.selection.contains(f)||(this.selection=f);return}if((t.cellType===u.CellType.ColumnHeader||t.cellType===u.CellType.None)&&(!(t.col>-1)||!this.columns[t.col].isSelected)&&i.hasClass(n.target,'wj-cell')&&!t.edgeRight)if(this._columnHeaderClicked=!0,this._wholeColumnsSelected=!0,n.shiftKey)this._multiSelectColumns(t);else{if(r=new u.CellRange(this.itemsSource?1:0,t.col,this.rows.length-1,t.col),n.which===3&&this.selection.contains(r))return;this.select(r)}}},t.prototype._mouseMove=function(n){var t=this.hitTest(n),i=this.selection,f=this.rows.length,e=this.columns.length,r=this.hostElement.style.cursor,o;if(this.rows.length===0||this.columns.length===0){this._dragable=!1;t.cellType===u.CellType.Cell&&(this.hostElement.style.cursor='default');return}if(this._isDragging){this.hostElement.style.cursor='move';this._showDraggingMarker(n);return}(o=this.itemsSource?i.topRow===0||i.topRow===1:i.topRow===0,i&&t.cellType!==u.CellType.None&&!this.itemsSource&&(this._draggingColumn=o&&i.bottomRow===f-1,this._draggingRow=i.leftCol===0&&i.rightCol===e-1,t.cellType===u.CellType.Cell?(this._draggingColumn&&((t.col===i.leftCol-1||t.col===i.rightCol)&&t.edgeRight||t.row===f-1&&t.edgeBottom)&&(r='move'),this._draggingRow&&!this._containsGroupRows(i)&&((t.row===i.topRow-1||t.row===i.bottomRow)&&t.edgeBottom||t.col===e-1&&t.edgeRight)&&(r='move')):t.cellType===u.CellType.ColumnHeader?t.edgeBottom&&(this._draggingColumn&&t.col>=i.leftCol&&t.col<=i.rightCol?r='move':this._draggingRow&&i.topRow===0&&(r='move')):t.cellType===u.CellType.RowHeader&&t.edgeRight&&(this._draggingColumn&&i.leftCol===0?r='move':this._draggingRow&&t.row>=i.topRow&&t.row<=i.bottomRow&&!this._containsGroupRows(i)&&(r='move')),this._dragable=r==='move'?!0:!1,this.hostElement.style.cursor=r),this._htDown&&this._htDown.panel)&&(t=new u.HitTestInfo(this._htDown.panel,n),this._multiSelectColumns(t),t.cellType===u.CellType.Cell&&this.scrollIntoView(t.row,t.col))},t.prototype._mouseUp=function(n){this._isDragging&&(this._draggingCells.equals(this._dropRange)||(this._handleDropping(n),this.onDroppingRowColumn()),this._draggingCells=null,this._dropRange=null,document.body.removeChild(this._draggingMarker),this._draggingMarker=null,this._draggingTooltip.hide(),this._draggingTooltip=null,this._isDragging=!1,this._draggingColumn=!1,this._draggingRow=!1);this._htDown&&this._htDown.cellType!==u.CellType.None&&this.selection.isValid&&this.selectedSheet&&(this._htDown.cellType===u.CellType.TopLeft?this.selectedSheet.selectionRanges.push(new u.CellRange(this.selectedSheet.itemsSource?1:0,0,this.rows.length-1,this.columns.length-1)):this.selectedSheet.selectionRanges.push(this.selection),this._enableMulSel=!1);this._isClicking=!1;this._columnHeaderClicked=!1;this._htDown=null},t.prototype._click=function(){var n=this,t=window.navigator.userAgent;t.match(/iPad/i)||t.match(/iPhone/i)||n._contextMenu.hide();setTimeout(function(){n.hideFunctionList()},200)},t.prototype._touchStart=function(n){var t=this;i.hasClass(n.target,'wj-context-menu-item')||t._contextMenu.hide();t._longClickTimer=setTimeout(function(){var r;r=t.hitTest(n);r&&r.cellType!==u.CellType.None&&!t.itemsSource&&t._contextMenu.show(undefined,new i.Point(n.pageX+10,n.pageY+10))},500)},t.prototype._touchEnd=function(){clearTimeout(this._longClickTimer)},t.prototype._showDraggingMarker=function(n){var a=new u.HitTestInfo(this.cells,n),v=this.selection,w=this.columns.length,b=this.rows.length,y=this._cumulativeScrollOffset(this.hostElement),k=this._root.getBoundingClientRect(),d=k.left+y.x,g=k.top+y.y,e,f,r,c,s,l,h,p,o;if(this.scrollIntoView(a.row,a.col),this._draggingColumn){for(f=v.rightCol-v.leftCol+1,r=a.col,s=0,(r<0||r+f>w)&&(r=w-f),e=this.cells.getCellBoundingRect(0,r),l=this._root.offsetHeight-this._eCHdr.offsetHeight,c=this.cells.height,c=c>l?l:c,h=0;h<f;h++)s+=this.columns[r+h].renderSize;p=t.convertNumberToAlpha(r)+' : '+t.convertNumberToAlpha(r+f-1);this._dropRange?(this._dropRange.col=r,this._dropRange.col2=r+f-1):this._dropRange=new u.CellRange(0,r,this.rows.length-1,r+f-1)}else if(this._draggingRow){for(f=v.bottomRow-v.topRow+1,r=a.row,c=0,(r<0||r+f>b)&&(r=b-f),e=this.cells.getCellBoundingRect(r,0),l=this._root.offsetWidth-this._eRHdr.offsetWidth,h=0;h<f;h++)c+=this.rows[r+h].renderSize;s=this.cells.width;s=s>l?l:s;p=r+1+' : '+(r+f);this._dropRange?(this._dropRange.row=r,this._dropRange.row2=r+f-1):this._dropRange=new u.CellRange(r,0,r+f-1,this.columns.length-1)}if(e){if(o={display:'inline',zIndex:'9999',opacity:.5,top:e.top-(this._draggingColumn?this._ptScrl.y:0)+y.y,left:e.left-(this._draggingRow?this._ptScrl.x:0)+y.x,height:c,width:s},e.top=e.top-(this._draggingColumn?this._ptScrl.y:0),e.left=e.left-(this._draggingRow?this._ptScrl.x:0),this.rightToLeft&&this._draggingRow&&(o.left=o.left-s+e.width+2*this._ptScrl.x,e.left=e.left+2*this._ptScrl.x),this._draggingRow){if(d+this._eRHdr.offsetWidth!==o.left||g+this._root.offsetHeight+1<o.top+o.height)return}else if(g+this._eCHdr.offsetHeight!==o.top||d+this._root.offsetWidth+1<o.left+o.width)return;i.setCss(this._draggingMarker,o);this._draggingTooltip.show(this.hostElement,p,e)}},t.prototype._handleDropping=function(n){var t=this,f,r,e,u,o;if(t.selectedSheet&&t._draggingCells&&t._dropRange&&!t._containsMergedCells(t._draggingCells)&&!t._containsMergedCells(t._dropRange)){if(t._clearCalcEngine(),t._draggingColumn&&t._draggingCells.leftCol>t._dropRange.leftCol||t._draggingRow&&t._draggingCells.topRow>t._dropRange.topRow)if(n.shiftKey){if(t._draggingColumn)for(u=t._dropRange.leftCol,r=t._draggingCells.leftCol;r<=t._draggingCells.rightCol;r++)t.columns.moveElement(r,u),u++;else if(t._draggingRow)for(e=t._dropRange.topRow,f=t._draggingCells.topRow;f<=t._draggingCells.bottomRow;f++)t.rows.moveElement(f,e),e++;t._exchangeCellStyle(!0)}else{for(o=new lt(t,t._draggingCells,t._dropRange,n.ctrlKey),e=t._dropRange.topRow,f=t._draggingCells.topRow;f<=t._draggingCells.bottomRow;f++){for(u=t._dropRange.leftCol,r=t._draggingCells.leftCol;r<=t._draggingCells.rightCol;r++)t._moveCellContent(f,r,e,u,n.ctrlKey),t._draggingColumn&&e===t._dropRange.topRow&&(t.columns[u].dataType=t.columns[r].dataType?t.columns[r].dataType:i.DataType.Object,t.columns[u].align=t.columns[r].align,t.columns[u].format=t.columns[r].format,n.ctrlKey||(t.columns[r].dataType=i.DataType.Object,t.columns[r].align=null,t.columns[r].format=null)),u++;e++}if(t._draggingColumn&&!n.ctrlKey)for(u=t._dropRange.leftCol,r=t._draggingCells.leftCol;r<=t._draggingCells.rightCol;r++)t._updateColumnFiler(r,u),u++;o.saveNewState()&&t._undoStack._addAction(o)}else if(t._draggingColumn&&t._draggingCells.leftCol<t._dropRange.leftCol||t._draggingRow&&t._draggingCells.topRow<t._dropRange.topRow)if(n.shiftKey){if(t._draggingColumn)for(u=t._dropRange.rightCol,r=t._draggingCells.rightCol;r>=t._draggingCells.leftCol;r--)t.columns.moveElement(r,u),u--;else if(t._draggingRow)for(e=t._dropRange.bottomRow,f=t._draggingCells.bottomRow;f>=t._draggingCells.topRow;f--)t.rows.moveElement(f,e),e--;t._exchangeCellStyle(!1)}else{for(o=new lt(t,t._draggingCells,t._dropRange,n.ctrlKey),e=t._dropRange.bottomRow,f=t._draggingCells.bottomRow;f>=t._draggingCells.topRow;f--){for(u=t._dropRange.rightCol,r=t._draggingCells.rightCol;r>=t._draggingCells.leftCol;r--)t._moveCellContent(f,r,e,u,n.ctrlKey),t._draggingColumn&&e===t._dropRange.bottomRow&&(t.columns[u].dataType=t.columns[r].dataType?t.columns[r].dataType:i.DataType.Object,t.columns[u].align=t.columns[r].align,t.columns[u].format=t.columns[r].format,n.ctrlKey||(t.columns[r].dataType=i.DataType.Object,t.columns[r].align=null,t.columns[r].format=null)),u--;e--}if(t._draggingColumn&&!n.ctrlKey)for(u=t._dropRange.rightCol,r=t._draggingCells.rightCol;r>=t._draggingCells.leftCol;r--)t._updateColumnFiler(r,u),u--;o.saveNewState()&&t._undoStack._addAction(o)}t.select(t._dropRange);t.selectedSheet.selectionRanges.push(t.selection);t.hostElement.focus()}},t.prototype._moveCellContent=function(n,t,i,r,u){var s=this.getCellData(n,t,!1),f=n*this.columns.length+t,e=i*this.columns.length+r,o=this.selectedSheet._styledCells[f];this.setCellData(i,r,s);o?this.selectedSheet._styledCells[e]=JSON.parse(JSON.stringify(o)):delete this.selectedSheet._styledCells[e];u||(this.setCellData(n,t,undefined),delete this.selectedSheet._styledCells[f])},t.prototype._exchangeCellStyle=function(n){for(var i,r,u,f,o=0,e=[],t=this._draggingCells.topRow;t<=this._draggingCells.bottomRow;t++)for(i=this._draggingCells.leftCol;i<=this._draggingCells.rightCol;i++)r=t*this.columns.length+i,this.selectedSheet._styledCells[r]?(e.push(JSON.parse(JSON.stringify(this.selectedSheet._styledCells[r]))),delete this.selectedSheet._styledCells[r]):e.push(undefined);if(n){if(this._draggingColumn)for(f=this._draggingCells.rightCol-this._draggingCells.leftCol+1,i=this._draggingCells.leftCol-1;i>=this._dropRange.leftCol;i--)for(t=0;t<this.rows.length;t++)r=t*this.columns.length+i,u=t*this.columns.length+i+f,this.selectedSheet._styledCells[r]?(this.selectedSheet._styledCells[u]=JSON.parse(JSON.stringify(this.selectedSheet._styledCells[r])),delete this.selectedSheet._styledCells[r]):delete this.selectedSheet._styledCells[u];else if(this._draggingRow)for(f=this._draggingCells.bottomRow-this._draggingCells.topRow+1,t=this._draggingCells.topRow-1;t>=this._dropRange.topRow;t--)for(i=0;i<this.columns.length;i++)r=t*this.columns.length+i,u=(t+f)*this.columns.length+i,this.selectedSheet._styledCells[r]?(this.selectedSheet._styledCells[u]=JSON.parse(JSON.stringify(this.selectedSheet._styledCells[r])),delete this.selectedSheet._styledCells[r]):delete this.selectedSheet._styledCells[u]}else if(this._draggingColumn)for(f=this._draggingCells.rightCol-this._draggingCells.leftCol+1,i=this._draggingCells.rightCol+1;i<=this._dropRange.rightCol;i++)for(t=0;t<this.rows.length;t++)r=t*this.columns.length+i,u=t*this.columns.length+i-f,this.selectedSheet._styledCells[r]?(this.selectedSheet._styledCells[u]=JSON.parse(JSON.stringify(this.selectedSheet._styledCells[r])),delete this.selectedSheet._styledCells[r]):delete this.selectedSheet._styledCells[u];else if(this._draggingRow)for(f=this._draggingCells.bottomRow-this._draggingCells.topRow+1,t=this._draggingCells.bottomRow+1;t<=this._dropRange.bottomRow;t++)for(i=0;i<this.columns.length;i++)r=t*this.columns.length+i,u=(t-f)*this.columns.length+i,this.selectedSheet._styledCells[r]?(this.selectedSheet._styledCells[u]=JSON.parse(JSON.stringify(this.selectedSheet._styledCells[r])),delete this.selectedSheet._styledCells[r]):delete this.selectedSheet._styledCells[u];for(t=this._dropRange.topRow;t<=this._dropRange.bottomRow;t++)for(i=this._dropRange.leftCol;i<=this._dropRange.rightCol;i++)r=t*this.columns.length+i,e[o]?this.selectedSheet._styledCells[r]=e[o]:delete this.selectedSheet._styledCells[r],o++},t.prototype._containsMergedCells=function(n){var t,i,u,r;if(!this.selectedSheet)return!1;for(t=n.topRow;t<=n.bottomRow;t++)for(i=n.leftCol;i<=n.rightCol;i++)if(u=t*this.columns.length+i,r=this.selectedSheet._mergedRanges[u],r&&r.isValid&&!r.isSingleCell)return!0;return!1},t.prototype._multiSelectColumns=function(n){var t;n&&this._columnHeaderClicked&&(t=new u.CellRange(n.row,n.col),t.row=!this.selectedSheet.itemsSource?0:1,t.row2=this.rows.length-1,t.col2=this.selection.col2,this.select(t))},t.prototype._cumulativeOffset=function(n){var t=0,r=0;do t+=n.offsetTop||0,r+=n.offsetLeft||0,n=n.offsetParent;while(n);return new i.Point(r,t)},t.prototype._cumulativeScrollOffset=function(n){var t=0,r=0;do t+=n.scrollTop||0,r+=n.scrollLeft||0,n=n.offsetParent;while(n&&!(n instanceof HTMLBodyElement));return t+=document.body.scrollTop||document.documentElement.scrollTop,r+=document.body.scrollLeft||document.documentElement.scrollLeft,new i.Point(r,t)},t.prototype._checkHitWithinSelection=function(n){var t;return n!=null&&n.cellType===u.CellType.Cell&&((t=this.getMergedRange(this.cells,n.row,n.col),t&&t.contains(this.selection))||this.selection.row===n.row&&this.selection.col===n.col)?!0:!1},t.prototype._clearForEmptySheet=function(n){this.selectedSheet&&this[n].length===0&&this._isCopying!==!0&&this._isUndoing!==!0&&(this.selectedSheet._mergedRanges=null,this.selectedSheet._styledCells=null,this.select(new u.CellRange))},t.prototype._containsGroupRows=function(n){for(var i,t=n.topRow;t<=n.bottomRow;t++)if(i=this.rows[t],i instanceof u.GroupRow)return!0;return!1},t.prototype._delSeletionContent=function(n){var c=this.selectedSheet.selectionRanges,f,h,s,r,t,e,l=!1,o,a=new d(this);if(!this.isReadOnly){for(this.beginUpdate(),s=0;s<c.length;s++)for(f=c[s],h=new u.CellRange,o=new u.CellEditEndingEventArgs(this.cells,h,n),t=f.topRow;t<=f.bottomRow;t++)if(this.rows[t]&&!this.rows[t].isReadOnly)for(r=f.leftCol;r<=f.rightCol;r++)if(e=this._getBindingColumn(this.cells,t,this.columns[r]),(!e.isReadOnly&&e.isRequired===!1||e.isRequired==null&&e.dataType==i.DataType.String)&&this.getCellData(t,r,!0)&&(h.setRange(t,r),o.cancel=!1,this.onBeginningEdit(o))){this.setCellData(t,r,'',!0);l=!0;this.onCellEditEnding(o);this.onCellEditEnded(o)}l&&(a.saveNewState(),this._undoStack._addAction(a));this.endUpdate()}},t.prototype._updateAffectedFormula=function(n,t,u,f){for(var s,a,v,l,y,p,c,w,b,k=[],d=[],e,h,o=0;o<this.rows.length;o++)for(s=0;s<this.columns.length;s++)if(h=this.getCellData(o,s,!1),!!h&&typeof h=='string'&&h[0]==='='&&(l=h.match(/(?=\b\D)\$?[A-Za-z]+\$?\d+/g),!!l&&l.length>0)){for(p=!1,y=0;y<l.length;y++)w=l[y],w.toLowerCase()!=='atan2'&&(e=r.Workbook.tableAddress(w),c=!1,f?u?e.row>=n&&(e.row+=t,c=!0):e.row>n-t&&(e.row>n?e.row-=t:e.row=n-t+1,c=!0):u?e.col>=n&&(e.col+=t,c=!0):e.col>n-t&&(e.col>n?e.col-=t:e.col=n-t+1,c=!0),!p&&c&&(p=!0,k.push({point:new i.Point(o,s),formula:h})),b=r.Workbook.xlsxAddress(e.row,e.col,e.absRow,e.absCol),h=h.replace(w,b));if(p){if(a=o,v=s,f?o>=n&&(u?a+=t:a-=t):s>=n&&(u?v+=t:v-=t),!u&&(f&&o<=n&&o>=n-t||!f&&s<=n&&s>=n-t))continue;this.setCellData(o,s,h);d.push({point:new i.Point(a,v),formula:h})}}return{oldFormulas:k,newFormulas:d}},t.prototype._updateColumnFiler=function(n,t){for(var u,i=JSON.parse(this._filter.filterDefinition),r=0;r<i.filters.length;r++)if(u=i.filters[r],u.columnIndex===n){u.columnIndex=t;break}this._filter.filterDefinition=JSON.stringify(i)},t.prototype._isDescendant=function(n,t){for(var i=t.parentNode;i!=null;){if(i===n)return!0;i=i.parentNode}return!1},t.prototype._clearCalcEngine=function(){this._calcEngine._clearExpressionCache()},t.prototype._getRangeString=function(n,t,r){var f,y,o,l,p,s,e,v,h,c,a;if(r===void 0&&(r=!0),f='',l=!0,i.isArray(n)&&n.length>1){if(this._isMultipleRowsSelected(n,t)){for(f='',o=0;o<n.length;o++)f&&(f+='\n'),f+=this._getRangeString(n[o],t);return f}if(this._isMultipleColumnsSelected(n,t))for(f='',y=0,l=!0;y<t.grid.rows.length;y++){for(l||(f+='\n'),l=!1,o=0,a=!0;o<n.length;o++)p=n[o].clone(),p.row=p.row2=y,a||(f+='\t'),a=!1,f+=this._getRangeString(n[o],t);return f}else{e=n[0];switch(this.selectionMode){case u.SelectionMode.Row:case u.SelectionMode.RowRange:return e.col=0,e.col2=t.grid.columns.length-1,this._getRangeString(e,t);case u.SelectionMode.ListBox:for(e.col=0,e.col2=t.grid.columns.length-1,v=0;v<t.grid.rows.length;v++)t.grid.rows[v].isSelected&&t.grid.rows[v].isVisible&&(e.row=e.row2=v,f&&(f+='\n'),f+=this._getRangeString(e,t));return f}}}for(e=i.asType(i.isArray(n)?n[0]:n,u.CellRange),h=e.topRow;h<=e.bottomRow;h++)if(this.rows[h]&&this.rows[h].isVisible)for(l||(f+='\n'),l=!1,c=e.leftCol,a=!0;c<=e.rightCol;c++)this.columns[c]&&this.columns[c].isVisible&&(a||(f+='\t'),a=!1,s=r?this.getCellValue(h,c,!0,t).toString():this.getCellData(h,c,!0).toString(),s=s.replace(/\t/g,' '),s.indexOf('\n')>-1&&(s='"'+s.replace(/"/g,'""')+'"'),f+=s);return f},t.prototype._containsRandFormula=function(n,t){for(var r,f,e,o,u=0;u<n.length;u++)for(r=n[u],f=r.topRow;f<=r.bottomRow;f++)for(e=r.leftCol;e<=r.rightCol;e++)if(o=t.grid.getCellData(f,e,!1),i.isString(o)&&o[0]==='='&&o.search(/rand/i)!==-1)return!0;return!1},t.prototype._isMultipleRowsSelected=function(n,t){for(var i,u=n||this.selectedSheet.selectionRanges||[this.selection],r=0;r<u.length;r++)if(i=u[r],t){if(i.leftCol!==0||i.rightCol!==t.grid.columns.length-1)return!1}else if(i.leftCol!==0||i.rightCol!==this.columns.length-1)return!1;return!0},t.prototype._isMultipleColumnsSelected=function(n,t){for(var i,u=n||this.selectedSheet.selectionRanges||[this.selection],r=0;r<u.length;r++)if(i=u[r],t){if(i.bottomRow!==t.grid.rows.length-1||!t.grid.itemsSource&&i.topRow!==0||!!t.grid.itemsSource&&i.topRow!==1)return!1}else if(i.bottomRow!==this.rows.length-1||!this.selectedSheet.itemsSource&&i.topRow!==0||!!this.selectedSheet.itemsSource&&i.topRow!==1)return!1;return!0},t.prototype._postSetClipStringProcess=function(n,t,i,r,f){var e,o,s,c,l=!1,h;if(r>=0&&f>=0&&(e=this.getMergedRange(this.cells,r,f),!e||e.topRow!==r||e.leftCol!==f||(o=t+e.rowSpan-1,o=o<this.rows.length?o:this.rows.length-1,s=i+e.columnSpan-1,s=s<this.columns.length?s:this.columns.length-1,this.mergeRange(new u.CellRange(t,i,o,s),!0))),c=new u.CellRangeEventArgs(this.cells,new u.CellRange(t,i),n),this.onPastingCell(c)&&this.cells.setCellData(t,i,n)){h=n.match(/\n/g);h&&h.length>0&&(this._applyStyleForCell(t,i,{whiteSpace:'pre'}),this.rows[t].height=this.rows.defaultSize*(h.length+1));this.onPastedCell(c);l=!0}return l},t.prototype._delCutData=function(){for(var t,u,f=this._copiedRanges[0],r=this._copiedSheet===this.selectedSheet?this:this._copiedSheet.grid,n=f.topRow;n<=f.bottomRow;n++)for(t=f.leftCol;t<=f.rightCol;t++)u=r._getBindingColumn(r.cells,n,r.columns[t]),(u.isRequired==!1||u.isRequired==null&&u.dataType==i.DataType.String)&&r.getCellData(n,t,!0)&&r.setCellData(n,t,'',!0)},t.prototype._containsMultiLineText=function(n){for(var i,t=0;t<n.length;t++)if(i=n[t],i.indexOf('\n')>=0)return!0;return!1},t.prototype._sortByRow=function(n,t){return n.topRow>t.topRow?1:n.topRow<t.topRow?-1:0},t.prototype._sortByColumn=function(n,t){return n.leftCol>t.leftCol?1:n.leftCol<t.leftCol?-1:0},t.prototype._setFlexSheetToDirty=function(){this.columns._dirty=!0;this.rows._dirty=!0;this.rowHeaders.columns._dirty=!0;this.rowHeaders.rows._dirty=!0;this.columnHeaders.columns._dirty=!0;this.columnHeaders.rows._dirty=!0},t.convertNumberToAlpha=function(n){var t='',i,r;if(n>=0)do i=Math.floor(n/26),r=n%26,t=String.fromCharCode(r+65)+t,n=i-1;while(i);return t},t.prototype._updateFormulaForReorderingRows=function(n,t){for(var h,l=t-n,i,e,o,c,u,f,s=0;s<this.columns.length;s++)if(i=this.getCellData(t,s,!1),!!i&&typeof i=='string'&&i[0]==='='&&(e=i.match(/(?=\b\D)\$?[A-Za-z]+\$?\d+/g),!!e&&e.length>0)){for(h=0;h<e.length;h++)o=e[h],o.toLowerCase()!=='atan2'&&(u=r.Workbook.tableAddress(o),f=u.row+l,f<0?f=0:f>=this.rows.length&&(f=this.rows.length-1),u.row=f,c=r.Workbook.xlsxAddress(u.row,u.col,u.absRow,u.absCol),i=i.replace(o,c));this.setCellData(t,s,i)}},t.prototype._scanFormulas=function(){for(var n,t,u=[],r=0;r<this.rows.length;r++)for(n=0;n<this.columns.length;n++)t=this.getCellData(r,n,!1),t&&i.isString(t)&&t[0]==='='&&u.push({row:r,column:n,formula:t});return u},t.prototype._resetFormulas=function(n){var t=this;n&&t.deferUpdate(function(){for(var r,i=0;i<n.length;i++)r=n[i],t.setCellData(r.row,r.column,r.formula)})},t.prototype._getCellStyle=function(n,t,i){var i=i||this.selectedSheet,r;return i?(r=n*i.grid.columns.length+t,i._styledCells[r]):null},t.prototype._validateSheetName=function(n){for(var t=0;t<this.sheets.length;t++)if(this.sheets[t].name===n)return!0;return!1},t.prototype._updateDefinedNameWithSheetRefUpdating=function(n,t){for(var f,i,r,u,o,e=0;e<this.definedNames.length;e++)if(i=this.definedNames[e],i.sheetName===n&&(i.sheetName=t),r=i.value.match(/(\w+)\!\$?[A-Za-z]+\$?\d+/g),r&&r.length>0)for(f=0;f<r.length;f++)u=r[f],o=u.substring(0,u.indexOf('!')),o===n&&(i.value=i.value.replace(u,u.replace(n,t)))},t}(u.FlexGrid);tt.controlTemplate='<div style="width:100%;height:100%"><div wj-part="container" style="width:100%">'+u.FlexGrid.controlTemplate+'<\/div><div wj-part="tab-holder" style="width:100%; min-width:100px"><\/div><div wj-part="context-menu" style="display:none;z-index:100"><\/div><\/div>';t.FlexSheet=tt;ti=function(n){function t(t,i){var r=n.call(this)||this;return r._isDraggingRows=t,r._isShiftKey=i,r}return __extends(t,n),Object.defineProperty(t.prototype,"isDraggingRows",{get:function(){return this._isDraggingRows},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isShiftKey",{get:function(){return this._isShiftKey},enumerable:!0,configurable:!0}),t}(i.EventArgs);t.DraggingRowColumnEventArgs=ti;ii=function(n){function t(t,i){var r=n.call(this)||this;return r._funcName=t,r._params=i,r}return __extends(t,n),Object.defineProperty(t.prototype,"funcName",{get:function(){return this._funcName},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"params",{get:function(){return this._params},enumerable:!0,configurable:!0}),t}(i.EventArgs);t.UnknownFunctionEventArgs=ii;it=function(n){function t(t,i,r){var u=n.call(this)||this;return u._index=t,u._count=i,u._added=r,u}return __extends(t,n),Object.defineProperty(t.prototype,"index",{get:function(){return this._index},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"count",{get:function(){return this._count},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"added",{get:function(){return this._added},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isAdd",{get:function(){return i._deprecated('RowColumnChangedEventArgs.isAdd','RowColumnChangedEventArgs.added'),this._added},enumerable:!0,configurable:!0}),t}(i.EventArgs);t.RowColumnChangedEventArgs=it;rt=function(n){function t(t,i,r,u,f){return n.call(this,t,i,r,u,f)||this}return __extends(t,n),t.prototype.getSelectedState=function(t,i,r){var o,s,e,f,c,h;if(!this.grid)return undefined;if(h=this.grid.getMergedRange(this,t,i),o=this.grid.selectedSheet?this.grid.selectedSheet.selectionRanges:null,c=n.prototype.getSelectedState.call(this,t,i,r),s=o?o.length:0,c===u.SelectedState.None&&s>0&&this.grid._enableMulSel)for(e=0;e<o.length;e++)if(f=o[e],f&&f instanceof u.CellRange){if(this.cellType===u.CellType.Cell){if(h){if(h.contains(f.row,f.col))return e===s-1&&!this.grid._isClicking?this.grid.showMarquee?u.SelectedState.None:u.SelectedState.Cursor:u.SelectedState.Selected;if(h.intersects(f))return u.SelectedState.Selected}if(f.row===t&&f.col===i)return e===s-1&&!this.grid._isClicking?this.grid.showMarquee?u.SelectedState.None:u.SelectedState.Cursor:u.SelectedState.Selected;if(f.contains(t,i))return u.SelectedState.Selected}if(this.grid.showSelectedHeaders&u.HeadersVisibility.Row&&this.cellType===u.CellType.RowHeader&&f.containsRow(t)||this.grid.showSelectedHeaders&u.HeadersVisibility.Column&&this.cellType===u.CellType.ColumnHeader&&f.containsColumn(i))return u.SelectedState.Selected}return c},t.prototype.getCellData=function(t,r,u){var o=n.prototype.getCellData.call(this,t,r,u),s=this.columns[i.asNumber(r,!1,!0)],e=this.grid?this.grid._getBindingColumn(this,t,s):s,h,f;return u&&(f=n.prototype.getCellData.call(this,t,r,!1),h=this.grid?this.grid._getCellStyle(t,r):null,!i.isNumber(f)||f===0||!e||e.format||e.dataMap||h||(o=f.toString())),o},t.prototype.setCellData=function(t,r,u,f){f===void 0&&(f=!0);var e,o=this.getCellData(t,r,!1);return f&&u&&i.isString(u)&&(this.grid.columns[r].dataType===i.DataType.String||i.isNullOrWhiteSpace(u)||isNaN(+u)?u[0]!=='='&&(e=i.Globalize.parseDate(u,''),e&&(u=e)):u=+u),(u&&i.isString(u)&&u[0]==='='||o==='')&&(f=!1),n.prototype.setCellData.call(this,t,r,u,f)},t.prototype._renderCell=function(t,r,f,e,o,s){var h=t.childNodes[s],c,a=r*this.grid.columns.length+f,l=this.grid.getMergedRange(this,r,f);return(s=n.prototype._renderCell.call(this,t,r,f,e,o,s),this.cellType!==u.CellType.Cell)?s:l&&a>l.topRow*this.grid.columns.length+l.leftCol?s:(i.hasClass(h,'wj-state-selected')||i.hasClass(h,'wj-state-multi-selected')?(h.style.backgroundColor='',h.style.color=''):this.grid.selectedSheet&&(c=this.grid.selectedSheet._styledCells[a],h&&c&&(h.style.backgroundColor=c.backgroundColor,h.style.color=c.color)),s)},t}(u.GridPanel);t.FlexSheetPanel=rt;w=function(n){function t(){var t=n.call(this)||this;return t.isReadOnly=!0,t}return __extends(t,n),t}(u.Row);t.HeaderRow=w;ri=function(){function n(n,t,r,u,f){this._visible=!0;this._unboundSortDesc=new i.ObservableArray;this._currentStyledCells={};this._currentMergedRanges={};this._isEmptyGrid=!1;this._rowSettings=[];this._scrollPosition=new i.Point;this._freezeHiddenRowCnt=0;this._freezeHiddenColumnCnt=0;this.nameChanged=new i.Event;this.visibleChanged=new i.Event;var e=this;e._owner=n;e._name=r;e._rowCount=i.isNumber(u)&&!isNaN(u)&&u>=0?u:200;e._columnCount=i.isNumber(f)&&!isNaN(f)&&f>=0?f:20;e._grid=t||this._createGrid();e._grid.itemsSourceChanged.addHandler(this._gridItemsSourceChanged,this);e._addHeaderRow();e._unboundSortDesc.collectionChanged.addHandler(function(){for(var r=e._unboundSortDesc,u,t,n=0;n<r.length;n++)if(u=i.tryCast(r[n],pt),!u)throw'sortDescriptions array must contain SortDescription objects.';if(e._owner){if(e._owner.rows.beginUpdate(),e._owner.rows.sort(e._compareRows()),!e._owner._isUndoing)for(n=0;n<e._owner.rows.length;n++)t=e._owner.rows[n],n!==t._idx&&e._owner._updateFormulaForReorderingRows(t._idx,n);e._owner.rows.endUpdate();e._owner.rows._dirty=!0;e._owner.rows._update();e._owner.selectedSheet&&(e._owner._copyTo(e._owner.selectedSheet),e._owner._copyFrom(e._owner.selectedSheet))}})}return Object.defineProperty(n.prototype,"grid",{get:function(){return this._grid.wj_sheetInfo==null&&(this._grid.wj_sheetInfo={}),this._grid},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"name",{get:function(){return this._name},set:function(n){if(!i.isNullOrWhiteSpace(n)&&(this._name&&this._name.toLowerCase()!==n.toLowerCase()||!this._name)){var t=new i.PropertyChangedEventArgs('sheetName',this._name,n);this._name=n;this.grid.wj_sheetInfo.name=n;this.onNameChanged(t)}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"visible",{get:function(){return this._visible},set:function(n){if(this._visible!==n){this._visible=n;this.grid.wj_sheetInfo.visible=n;this.onVisibleChanged(new i.EventArgs)}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"rowCount",{get:function(){return this._grid!=null?this._grid.rows.length:0},set:function(n){var t;if(!this.itemsSource&&i.isNumber(n)&&!isNaN(n)&&n>=0&&this._rowCount!==n){if(this._rowCount<n)for(t=0;t<n-this._rowCount;t++)this.grid.rows.push(new u.Row);else this.grid.rows.splice(n,this._rowCount-n);this._rowCount=n;this._owner&&this._owner.selectedSheet&&this._name===this._owner.selectedSheet.name&&this._owner._copyFrom(this,!0)}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"columnCount",{get:function(){return this._grid!=null?this._grid.columns.length:0},set:function(n){var t;if(!this.itemsSource&&i.isNumber(n)&&!isNaN(n)&&n>=0&&this._columnCount!==n){if(this._columnCount<n)for(t=0;t<n-this._columnCount;t++)this._grid.columns.push(new u.Column);else this._grid.columns.splice(n,this._columnCount-n);this._columnCount=n;this._owner&&this._owner.selectedSheet&&this._name===this._owner.selectedSheet.name&&this._owner._copyFrom(this,!0)}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"selectionRanges",{get:function(){var n=this;return this._selectionRanges||(this._selectionRanges=new i.ObservableArray,this._selectionRanges.collectionChanged.addHandler(function(){var t,i;n._owner&&!n._owner._isClicking&&(t=n._selectionRanges.length,t>0&&(i=n._selectionRanges[t-1],i&&i instanceof u.CellRange&&(n._owner.selection=i)),t>1&&(n._owner._enableMulSel=!0),n._owner.refresh(),n._owner._enableMulSel=!1)},this)),this._selectionRanges},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"itemsSource",{get:function(){return this._grid!=null?this._grid.itemsSource:null},set:function(n){var t=this;t._grid==null&&(t._createGrid(),t._grid.itemsSourceChanged.addHandler(t._gridItemsSourceChanged,t));t._isEmptyGrid&&t._clearGrid();t._grid.loadedRows.addHandler(function(){t._addHeaderRow()});t._grid.itemsSource=n},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"_styledCells",{get:function(){return this._currentStyledCells||(this._currentStyledCells={}),this._currentStyledCells},set:function(n){this._currentStyledCells=n},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"_mergedRanges",{get:function(){return this._currentMergedRanges||(this._currentMergedRanges={}),this._currentMergedRanges},set:function(n){this._currentMergedRanges=n},enumerable:!0,configurable:!0}),n.prototype.onNameChanged=function(n){this.nameChanged.raise(this,n)},n.prototype.onVisibleChanged=function(n){this.visibleChanged.raise(this,n)},n.prototype.getCellStyle=function(n,t){var i,u=this._grid.rows.length,r=this._grid.columns.length;return n>=u||t>=r?null:(i=n*r+t,this._styledCells[i])},n.prototype._attachOwner=function(n){this._owner!==n&&(this._owner=n)},n.prototype._setValidName=function(n){this._name=n;this.grid.wj_sheetInfo.name=n},n.prototype._storeRowSettings=function(){var t=0,n;for(this._rowSettings=[];t<this._grid.rows.length;t++)n=this._owner.rows[t],n&&(this._rowSettings[t]={height:n.height,isCollapsed:n instanceof u.GroupRow?n.isCollapsed:null})},n.prototype._setRowSettings=function(){for(var n=0,t;n<this._rowSettings.length;n++)t=this._rowSettings[n],t&&(this._grid.rows[n].height=t.height)},n.prototype._compareRows=function(){var n=this,t=this._unboundSortDesc;return function(r,u){for(var o,s=0;s<t.length;s++){var h=t[s],f=r._ubv?r._ubv[h.column._hash]:'',e=u._ubv?u._ubv[h.column._hash]:'';if(i.isString(f)&&f[0]==='='&&(f=n._owner.evaluate(f),f==null||i.isPrimitive(f)||(f=f.value)),i.isString(e)&&e[0]==='='&&(e=n._owner.evaluate(e),e==null||i.isPrimitive(e)||(e=e.value)),f!==f&&(f=null),e!==e&&(e=null),i.isString(f)&&(f=f.toLowerCase()+f),i.isString(e)&&(e=e.toLowerCase()+e),f===''||f==null)return 1;if(e===''||e==null)return-1;if(o=f<e?-1:f>e?1:0,i.isString(f)&&i.isNumber(e)&&(o=1),i.isString(e)&&i.isNumber(f)&&(o=-1),o!==0)return h.ascending?+o:-o}return 0}},n.prototype._createGrid=function(){var t=document.createElement('div'),n,i,r,f;for(this._isEmptyGrid=!0,t.style.visibility='hidden',document.body.appendChild(t),n=new u.FlexGrid(t),document.body.removeChild(t),f=0;f<this._rowCount;f++)n.rows.push(new u.Row);for(r=0;r<this._columnCount;r++)i=new u.Column,i.isRequired=!1,n.columns.push(i);return n.wj_sheetInfo={name:this.name,visible:this.visible,styledCells:this._styledCells,mergedRanges:this._mergedRanges},n},n.prototype._clearGrid=function(){this._grid.rows.clear();this._grid.columns.clear();this._grid.columnHeaders.columns.clear();this._grid.rowHeaders.rows.clear()},n.prototype._gridItemsSourceChanged=function(){var n=this;n._owner&&n._owner.selectedSheet&&n._name===n._owner.selectedSheet.name&&(n._owner._filter.clear(),n._owner._copyFrom(n,!1),setTimeout(function(){n._owner._setFlexSheetToDirty();n._owner.invalidate()},10))},n.prototype._addHeaderRow=function(){var n,i,t;if(this._grid.itemsSource&&!(this._grid.rows[0]instanceof w)){for(n=new w,t=0;t<this._grid.columns.length;t++)i=this._grid.columns[t],n._ubv||(n._ubv={}),n._ubv[i._hash]=i.header;this._grid.rows.insert(0,n)}},n}();t.Sheet=ri;ui=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t._current=-1,t.sheetCleared=new i.Event,t.selectedSheetChanged=new i.Event,t.sheetNameChanged=new i.Event,t.sheetVisibleChanged=new i.Event,t}return __extends(t,n),t.prototype.onSheetCleared=function(){this.sheetCleared.raise(this,new i.EventArgs)},Object.defineProperty(t.prototype,"selectedIndex",{get:function(){return this._current},set:function(n){this._moveCurrentTo(+n)},enumerable:!0,configurable:!0}),t.prototype.onSelectedSheetChanged=function(n){this.selectedSheetChanged.raise(this,n)},t.prototype.insert=function(t,i){var r;r=i.name?this.getValidSheetName(i):this._getUniqueName();r!==i.name&&(i.name=r);n.prototype.insert.call(this,t,i);this._postprocessSheet(i)},t.prototype.push=function(){for(var f,t,u,i=[],r=0;r<arguments.length;r++)i[r]=arguments[r];for(f=this.length,t=0;t<i.length;t++)u=i[t].name?this.getValidSheetName(i[t]):this._getUniqueName(),u!==i[t].name&&(i[t].name=u),n.prototype.push.call(this,i[t]),this._postprocessSheet(i[t]);return this.length},t.prototype.splice=function(t,i,r){var u;return r?(u=r.name?this.getValidSheetName(r):this._getUniqueName(),u!==r.name&&(r.name=u),this._postprocessSheet(r),n.prototype.splice.call(this,t,i,r)):n.prototype.splice.call(this,t,i,r)},t.prototype.removeAt=function(t){var i=this.hide(t);i&&(n.prototype.removeAt.call(this,t),t<this.selectedIndex&&(this._current-=1))},t.prototype.onSheetNameChanged=function(n){this.sheetNameChanged.raise(this,n)},t.prototype.onSheetVisibleChanged=function(n){this.sheetVisibleChanged.raise(this,n)},t.prototype.selectFirst=function(){return this._moveCurrentTo(0)},t.prototype.selectLast=function(){return this._moveCurrentTo(this.length-1)},t.prototype.selectPrevious=function(){return this._moveCurrentTo(this._current-1)},t.prototype.selectNext=function(){return this._moveCurrentTo(this._current+1)},t.prototype.hide=function(n){return n<0&&n>=this.length?!1:this[n].visible?(this[n].visible=!1,!0):!1},t.prototype.show=function(n){return n<0&&n>=this.length?!1:(this[n].visible=!0,this._moveCurrentTo(n),!0)},t.prototype.clear=function(){n.prototype.clear.call(this);this._current=-1;this.onSheetCleared()},t.prototype.isValidSheetName=function(n){var t=this._getSheetIndexFrom(n.name),i=this.indexOf(n);return t===-1||t===i},t.prototype.getValidSheetName=function(n){var t=n.name,i=1,u=this.indexOf(n),r;do{if(r=this._getSheetIndexFrom(t),r===-1||r===u)break;else t=n.name.concat((i+1).toString());i=i+1}while(1);return t},t.prototype._moveCurrentTo=function(n){var t=n,r;if(n<0||n>=this.length)return!1;if(this._current<t||t===0)while(t<this.length&&!this[t].visible)t++;else if(this._current>t)while(t>=0&&!this[t].visible)t--;if(t===this.length)for(t=n;t>=0&&!this[t].visible;)t--;if(t<0)return!1;if(t!==this._current){r=new i.PropertyChangedEventArgs('sheetIndex',this._current,t);this._current=t;this.onSelectedSheetChanged(r)}return!0},t.prototype._getSheetIndexFrom=function(n){var r=-1,i,u,t;if(!n)return r;for(n=n.toLowerCase(),t=0;t<this.length;t++)if(i=this[t],u=i.name?i.name.toLowerCase():'',u===n)return t;return r},t.prototype._postprocessSheet=function(n){var t=this;n.nameChanged.addHandler(function(){var r,u=t._getSheetIndexFrom(n.name);t.isValidSheetName(n)||n._setValidName(t.getValidSheetName(n));r=new i.NotifyCollectionChangedEventArgs(i.NotifyCollectionChangedAction.Change,n,i.isNumber(u)?u:t.length-1);t.onSheetNameChanged(r)});n.visibleChanged.addHandler(function(){var r=t._getSheetIndexFrom(n.name),u=new i.NotifyCollectionChangedEventArgs(i.NotifyCollectionChangedAction.Change,n,i.isNumber(r)?r:t.length-1);t.onSheetVisibleChanged(u)})},t.prototype._getUniqueName=function(){var n='Sheet1',t=0;do{if(this._getSheetIndexFrom(n)===-1)break;else n='Sheet'.concat((t+1).toString());t=t+1}while(1);return n},t}(i.ObservableArray);t.SheetCollection=ui;yt=function(n){function t(t,i,r){var f=n.call(this,t,r)||this,u;return f._rtl=!1,f._sheetTabClicked=!1,u=f,u._owner=i,u._sheets=i.sheets,u._rtl=getComputedStyle(u._owner.hostElement).direction=='rtl',u.hostElement.attributes.tabindex&&u.hostElement.attributes.removeNamedItem('tabindex'),u._initControl(),u.deferUpdate(function(){r&&u.initialize(r)}),f}return __extends(t,n),t.prototype.refresh=function(){this._tabContainer.innerHTML='';this._tabContainer.innerHTML=this._getSheetTabs();this._rtl&&this._adjustSheetsPosition();this._adjustSize()},t.prototype._sourceChanged=function(n,t){t===void 0&&(t=i.NotifyCollectionChangedEventArgs.reset);var r=t,u;switch(r.action){case i.NotifyCollectionChangedAction.Add:u=r.index-1;u<0&&(u=0);this._tabContainer.innerHTML='';this._tabContainer.innerHTML=this._getSheetTabs();this._rtl&&this._adjustSheetsPosition();this._adjustSize();break;case i.NotifyCollectionChangedAction.Remove:this._tabContainer.removeChild(this._tabContainer.children[r.index]);this._tabContainer.hasChildNodes()&&this._updateTabActive(r.index,!0);this._adjustSize();break;default:this.invalidate()}},t.prototype._selectedSheetChanged=function(n,t){this._updateTabActive(t.oldValue,!1);this._updateTabActive(t.newValue,!0);this._sheetTabClicked?this._sheetTabClicked=!1:this._scrollToActiveSheet(t.newValue,t.oldValue);this._adjustSize()},t.prototype._initControl=function(){var n=this;n.applyTemplate('',n.getTemplate(),{_sheetContainer:'sheet-container',_tabContainer:'container',_sheetPage:'sheet-page',_newSheet:'new-sheet'});n._rtl&&(n._sheetPage.style.right='0px',n._tabContainer.parentElement.style.right=n._sheetPage.clientWidth+'px',n._tabContainer.style.right='0px',n._tabContainer.style.cssFloat='right',n._newSheet.style.right=n._sheetPage.clientWidth+n._tabContainer.parentElement.clientWidth+'px');n._adjustNavigationButtons(n._rtl);n.addEventListener(n._newSheet,'click',function(){var t=n._owner.selectedSheetIndex;n._owner.addUnboundSheet();n._scrollToActiveSheet(n._owner.selectedSheetIndex,t)});n._sheets.collectionChanged.addHandler(n._sourceChanged,n);n._sheets.selectedSheetChanged.addHandler(n._selectedSheetChanged,n);n._sheets.sheetNameChanged.addHandler(n._updateSheetName,n);n._sheets.sheetVisibleChanged.addHandler(n._updateTabShown,n);n._initSheetPage();n._initSheetTab()},t.prototype._initSheetTab=function(){var n=this;n.addEventListener(n._tabContainer,'mousedown',function(t){var i=t.target,r;i instanceof HTMLLIElement&&(n._sheetTabClicked=!0,r=n._getItemIndex(n._tabContainer,i),n._scrollSheetTabContainer(i),r>-1&&(n._sheets.selectedIndex=r))})},t.prototype._initSheetPage=function(){var n=this;n.hostElement.querySelector('div.wj-sheet-page').addEventListener('click',function(t){var i=t.target.toString()==='[object HTMLButtonElement]'?t.target:t.target.parentElement,r=n._getItemIndex(n._sheetPage,i);if(n._sheets.length!==0)switch(r){case 0:n._sheets.selectFirst();break;case 1:n._sheets.selectPrevious();break;case 2:n._sheets.selectNext();break;case 3:n._sheets.selectLast()}})},t.prototype._getSheetTabs=function(){for(var t='',n=0;n<this._sheets.length;n++)t+=this._getSheetElement(this._sheets[n],this._sheets.selectedIndex===n);return t},t.prototype._getSheetElement=function(n,t){t===void 0&&(t=!1);var i='<li';return n.visible?t&&(i+=' class="active"'):i+=' class="hidden"',i+('>'+n.name+'</li>')},t.prototype._updateTabActive=function(n,t){n<0||n>=this._tabContainer.children.length||(t?i.addClass(this._tabContainer.children[n],'active'):i.removeClass(this._tabContainer.children[n],'active'))},t.prototype._updateTabShown=function(n,t){t.index<0||t.index>=this._tabContainer.children.length||(t.item.visible?i.removeClass(this._tabContainer.children[t.index],'hidden'):i.addClass(this._tabContainer.children[t.index],'hidden'),this._adjustSize())},t.prototype._adjustSize=function(){var u=this._tabContainer.childElementCount,n,i,t=0,r=0;if(this.hostElement.style.display!=='none'){for(r=this._tabContainer.parentElement.scrollLeft,this._tabContainer.parentElement.style.width='',this._tabContainer.style.width='',this._sheetPage.parentElement.style.width='',n=0;n<u;n++)t+=this._tabContainer.children[n].offsetWidth+1;i=this.hostElement.offsetWidth-this._sheetPage.offsetWidth-this._newSheet.offsetWidth-2;this._tabContainer.parentElement.style.width=(t>i?i:t)+'px';this._tabContainer.style.width=t+'px';this._sheetPage.parentElement.style.width=this._sheetPage.offsetWidth+this._newSheet.offsetWidth+this._tabContainer.parentElement.offsetWidth+3+'px';this._tabContainer.parentElement.scrollLeft=r}},t.prototype._getItemIndex=function(n,t){for(var i=0;i<n.children.length;i++)if(n.children[i]===t)return i;return-1},t.prototype._updateSheetName=function(n,t){this._tabContainer.querySelectorAll('li')[t.index].textContent=t.item.name;this._adjustSize()},t.prototype._scrollSheetTabContainer=function(n){var t=this._tabContainer.parentElement.scrollLeft,f=this._sheetPage.offsetWidth,e=this._newSheet.offsetWidth,i=this._tabContainer.parentElement.offsetWidth,r;if(this._rtl)switch(u.FlexGrid._getRtlMode()){case'rev':r=-this._tabContainer.offsetLeft;r+n.offsetLeft+n.offsetWidth>i+t?this._tabContainer.parentElement.scrollLeft+=n.offsetWidth:r+n.offsetLeft<t&&(this._tabContainer.parentElement.scrollLeft-=n.offsetWidth);break;case'neg':n.offsetLeft<t?this._tabContainer.parentElement.scrollLeft-=n.offsetWidth:n.offsetLeft+n.offsetWidth>i+t&&(this._tabContainer.parentElement.scrollLeft+=n.offsetWidth);break;default:n.offsetLeft-e+t<0?this._tabContainer.parentElement.scrollLeft+=n.offsetWidth:n.offsetLeft+n.offsetWidth-e+t>i&&(this._tabContainer.parentElement.scrollLeft-=n.offsetWidth)}else n.offsetLeft+n.offsetWidth-f>i+t?this._tabContainer.parentElement.scrollLeft+=n.offsetWidth:n.offsetLeft-f<t&&(this._tabContainer.parentElement.scrollLeft-=n.offsetWidth)},t.prototype._adjustSheetsPosition=function(){for(var t=this._tabContainer.querySelectorAll('li'),r=0,i,n=0;n<t.length;n++)i=t[n],i.style.cssFloat='right',i.style.right=r+'px',r+=t[n].clientWidth},t.prototype._scrollToActiveSheet=function(n,t){var r=this._tabContainer.querySelectorAll('li'),e,f,i;if(f=this._tabContainer.clientWidth>this._tabContainer.parentElement.clientWidth?this._tabContainer.clientWidth-this._tabContainer.parentElement.clientWidth:0,r.length>0&&n<r.length&&t<r.length){if(n===0&&!this._rtl||n===r.length-1&&this._rtl){if(this._rtl)switch(u.FlexGrid._getRtlMode()){case'rev':this._tabContainer.parentElement.scrollLeft=0;break;case'neg':this._tabContainer.parentElement.scrollLeft=-f;break;default:this._tabContainer.parentElement.scrollLeft=f}else this._tabContainer.parentElement.scrollLeft=0;return}if(n===0&&this._rtl||n===r.length-1&&!this._rtl){if(this._rtl)switch(u.FlexGrid._getRtlMode()){case'rev':this._tabContainer.parentElement.scrollLeft=f;break;case'neg':this._tabContainer.parentElement.scrollLeft=0;break;default:this._tabContainer.parentElement.scrollLeft=0}else this._tabContainer.parentElement.scrollLeft=f;return}if(n>=t)for(i=t+1;i<=n;i++)e=r[i],this._scrollSheetTabContainer(e);else for(i=t-1;i>=n;i--)e=r[i],this._scrollSheetTabContainer(e)}},t.prototype._adjustNavigationButtons=function(n){var r=this.hostElement.querySelectorAll('.wj-sheet-page button'),t;r&&r.length===4&&(n?(t=r[0].querySelector('span'),i.removeClass(t,'wj-glyph-step-backward'),i.addClass(t,'wj-glyph-step-backward-rtl'),t=r[1].querySelector('span'),i.removeClass(t,'wj-glyph-left'),i.addClass(t,'wj-glyph-left-rtl'),t=r[2].querySelector('span'),i.removeClass(t,'wj-glyph-right'),i.addClass(t,'wj-glyph-right-rtl'),t=r[3].querySelector('span'),i.removeClass(t,'wj-glyph-step-forward'),i.addClass(t,'wj-glyph-step-forward-rtl')):(t=r[0].querySelector('span'),i.removeClass(t,'wj-glyph-step-backward-rtl'),i.addClass(t,'wj-glyph-step-backward'),t=r[1].querySelector('span'),i.removeClass(t,'wj-glyph-left-rtl'),i.addClass(t,'wj-glyph-left'),t=r[2].querySelector('span'),i.removeClass(t,'wj-glyph-right-rtl'),i.addClass(t,'wj-glyph-right'),t=r[3].querySelector('span'),i.removeClass(t,'wj-glyph-step-forward-rtl'),i.addClass(t,'wj-glyph-step-forward')))},t}(i.Control);yt.controlTemplate='<div wj-part="sheet-container" class="wj-sheet" style="height:100%;position:relative"><div wj-part="sheet-page" class="wj-btn-group wj-sheet-page"><button type="button" class="wj-btn wj-btn-default"><span class="wj-sheet-icon wj-glyph-step-backward"><\/span><\/button><button type="button" class="wj-btn wj-btn-default"><span class="wj-sheet-icon wj-glyph-left"><\/span><\/button><button type="button" class="wj-btn wj-btn-default"><span class="wj-sheet-icon wj-glyph-right"><\/span><\/button><button type="button" class="wj-btn wj-btn-default"><span class="wj-sheet-icon wj-glyph-step-forward"><\/span><\/button><\/div><div class="wj-sheet-tab" style="height:100%;overflow:hidden"><ul wj-part="container"><\/ul><\/div><div wj-part="new-sheet" class="wj-new-sheet"><span class="wj-sheet-icon wj-glyph-file"><\/span><\/div><\/div>';t._SheetTabs=yt;pt=function(){function n(n,t){this._column=n;this._ascending=t}return Object.defineProperty(n.prototype,"column",{get:function(){return this._column},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"ascending",{get:function(){return this._ascending},enumerable:!0,configurable:!0}),n}();t._UnboundSortDescription=pt;fi=function(){function n(n){this._owner=n;this._sortDescriptions=new i.CollectionView;this._committedList=[new g(-1,!0)];this._sortDescriptions.newItemCreator=function(){return new g(-1,!0)};this._refresh()}return Object.defineProperty(n.prototype,"sortDescriptions",{get:function(){return this._sortDescriptions},set:function(n){this._sortDescriptions=n;this.commitSort(!0);this._refresh()},enumerable:!0,configurable:!0}),n.prototype.addSortLevel=function(n,t){t===void 0&&(t=!0);var r=this._sortDescriptions.addNew();n!=null&&!isNaN(n)&&i.isInt(n)&&(r.columnIndex=n);r.ascending=t;this._sortDescriptions.commitNew()},n.prototype.deleteSortLevel=function(n){var t;t=n!=null?this._getSortItem(n):this._sortDescriptions.currentItem;t&&this._sortDescriptions.remove(t)},n.prototype.copySortLevel=function(){var n=this._sortDescriptions.currentItem,t;n&&(t=this._sortDescriptions.addNew(),t.columnIndex=parseInt(n.columnIndex),t.ascending=n.ascending,this._sortDescriptions.commitNew())},n.prototype.editSortLevel=function(n,t){n!=null&&(this._sortDescriptions.currentItem.columnIndex=n);t!=null&&(this._sortDescriptions.currentItem.ascending=t)},n.prototype.moveSortLevel=function(n){var t=this._sortDescriptions.currentItem;if(t){var i=this._sortDescriptions.sourceCollection,r=i.indexOf(t),u=r+n;r>-1&&u>-1&&(i.splice(r,1),i.splice(u,0,t),this._sortDescriptions.refresh(),this._sortDescriptions.moveCurrentTo(t))}},n.prototype.checkSortItemExists=function(n){for(var t=0,r=this._sortDescriptions.itemCount,i;t<r;t++)if(i=this._sortDescriptions.items[t],+i.columnIndex===n)return t;return-1},n.prototype.commitSort=function(n){var l=this,t,f,e,o,r,s,h,u,c;if(n===void 0&&(n=!0),c=this._owner.itemsSource&&this._owner.itemsSource instanceof i.CollectionView,this._owner.selectedSheet){if(s=this._owner.selectedSheet._unboundSortDesc,n&&(h=new dt(this._owner)),this._committedList=this._sortDescriptions.itemCount>0?this._sortDescriptions.items.slice():[new g(-1,!0)],this._owner.collectionView){for(u=this._scanUnboundRows(),this._owner.collectionView.beginUpdate(),this._owner.selectedSheet.grid.collectionView.beginUpdate(),e=this._owner.collectionView.sortDescriptions,e.clear(),c===!1&&(o=this._owner.selectedSheet.grid.collectionView.sortDescriptions,o.clear()),r=0;r<this._sortDescriptions.itemCount;r++)t=this._sortDescriptions.items[r],t.columnIndex>-1&&(f=new i.SortDescription(this._owner.columns[t.columnIndex].binding,t.ascending),e.push(f),c===!1&&o.push(f));this._owner.collectionView.endUpdate();this._owner.selectedSheet.grid.collectionView.endUpdate();u&&Object.keys(u).forEach(function(n){l._owner.rows.splice(+n,0,u[n])})}else for(s.clear(),r=0;r<this._sortDescriptions.itemCount;r++)t=this._sortDescriptions.items[r],t.columnIndex>-1&&s.push(new pt(this._owner.columns[t.columnIndex],t.ascending));n&&(h.saveNewState(),this._owner.undoStack._addAction(h))}},n.prototype.cancelSort=function(){this._sortDescriptions.sourceCollection=this._committedList.slice();this._refresh()},n.prototype._refresh=function(){var i=[],n,t;if(this._owner.selectedSheet){if(this._owner.collectionView&&this._owner.collectionView.sortDescriptions.length>0)for(n=0;n<this._owner.collectionView.sortDescriptions.length;n++)t=this._owner.collectionView.sortDescriptions[n],i.push(new g(this._getColumnIndex(t.property),t.ascending));else if(this._owner.selectedSheet&&this._owner.selectedSheet._unboundSortDesc.length>0)for(n=0;n<this._owner.selectedSheet._unboundSortDesc.length;n++)t=this._owner.selectedSheet._unboundSortDesc[n],i.push(new g(t.column.index,t.ascending));else i.push(new g(-1,!0));this._sortDescriptions.sourceCollection=i}},n.prototype._getColumnIndex=function(n){for(var t=0,i=this._owner.columns.length;t<i;t++)if(this._owner.columns[t].binding===n)return t;return-1},n.prototype._getSortItem=function(n){var t=this.checkSortItemExists(n);return t>-1?this._sortDescriptions.items[t]:undefined},n.prototype._scanUnboundRows=function(){for(var t,i,n=0;n<this._owner.rows.length;n++)t=this._owner.rows[n],t.dataItem||t instanceof w||t instanceof u._NewRowTemplate||(i||(i={}),i[n]=t);return i},n}();t.SortManager=fi;g=function(){function n(n,t){this._columnIndex=n;this._ascending=t}return Object.defineProperty(n.prototype,"columnIndex",{get:function(){return this._columnIndex},set:function(n){this._columnIndex=n},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"ascending",{get:function(){return this._ascending},set:function(n){this._ascending=n},enumerable:!0,configurable:!0}),n}();t.ColumnSortDescription=g;ei=function(){function n(n){this.MAX_STACK_SIZE=500;this._stack=[];this._pointer=-1;this._resizingTriggered=!1;this.undoStackChanged=new i.Event;var t=this;t._owner=n;t._owner.prepareCellForEdit.addHandler(t._initCellEditAction,t);t._owner.cellEditEnded.addHandler(function(n,i){i.data&&(i.data.keyCode===46||i.data.keyCode===8)||t._pendingAction instanceof d&&!t._pendingAction.isPaste&&t._afterProcessCellEditAction(t)},t);t._owner.pasting.addHandler(t._initCellEditActionForPasting,t);t._owner.pastingCell.addHandler(function(n,i){t._pendingAction instanceof d?t._pendingAction.updateForPasting(i.range):t._pendingAction instanceof ot&&t._pendingAction.updateForPasting(i.range)},t);t._owner.pasted.addHandler(function(){t._pendingAction instanceof d&&t._pendingAction.isPaste?t._afterProcessCellEditAction(t):t._pendingAction instanceof ot&&(t._pendingAction.saveNewState(),t._addAction(t._pendingAction),t._pendingAction=null)},t);t._owner.resizingColumn.addHandler(function(n,i){t._resizingTriggered||(t._pendingAction=new ht(t._owner,i.panel,i.col),t._resizingTriggered=!0)},t);t._owner.resizedColumn.addHandler(function(){t._pendingAction instanceof ht&&t._pendingAction.saveNewState()&&t._addAction(t._pendingAction);t._pendingAction=null;t._resizingTriggered=!1},t);t._owner.resizingRow.addHandler(function(n,i){t._resizingTriggered||(t._pendingAction=new ct(t._owner,i.panel,i.row),t._resizingTriggered=!0)},t);t._owner.resizedRow.addHandler(function(){t._pendingAction instanceof ct&&t._pendingAction.saveNewState()&&t._addAction(t._pendingAction);t._pendingAction=null;t._resizingTriggered=!1},t);t._owner.draggingRowColumn.addHandler(function(n,i){i.isShiftKey&&(t._pendingAction=i.isDraggingRows?new ft(t._owner):new ut(t._owner))},t);t._owner.droppingRowColumn.addHandler(function(){t._pendingAction&&t._pendingAction.saveNewState()&&t._addAction(t._pendingAction);t._pendingAction=null},t)}return Object.defineProperty(n.prototype,"canUndo",{get:function(){return this._pointer>-1&&this._pointer<this._stack.length},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"canRedo",{get:function(){return this._pointer+1>-1&&this._pointer+1<this._stack.length},enumerable:!0,configurable:!0}),n.prototype.onUndoStackChanged=function(){this.undoStackChanged.raise(this)},n.prototype.undo=function(){var n;this.canUndo&&(n=this._stack[this._pointer],this._beforeUndoRedo(n),n.undo(),this._pointer--,this.onUndoStackChanged())},n.prototype.redo=function(){var n;this.canRedo&&(this._pointer++,n=this._stack[this._pointer],this._beforeUndoRedo(n),n.redo(),this.onUndoStackChanged())},n.prototype._addAction=function(n){this._stack.length>0&&this._stack.length>this._pointer+1&&this._stack.splice(this._pointer+1,this._stack.length-this._pointer-1);this._stack.length>=this.MAX_STACK_SIZE&&this._stack.splice(0,this._stack.length-this.MAX_STACK_SIZE+1);this._pointer=this._stack.length;this._stack.push(n);this.onUndoStackChanged()},n.prototype._pop=function(){var n=this._stack[this._pointer];return this._pointer--,n},n.prototype.clear=function(){this._stack.length=0},n.prototype._initCellEditAction=function(n,t){this._pendingAction=new d(this._owner,t.range)},n.prototype._initCellEditActionForPasting=function(){this._owner._cutData?this._pendingAction=new ot(this._owner):(this._pendingAction=new d(this._owner),this._pendingAction.markIsPaste())},n.prototype._afterProcessCellEditAction=function(n){n._pendingAction instanceof d&&n._pendingAction.saveNewState()&&n._addAction(this._pendingAction);n._pendingAction=null},n.prototype._beforeUndoRedo=function(n){this._owner.selectedSheetIndex=n.sheetIndex},n}();t.UndoStack=ei;oi=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.apply=function(n){var t=this.column.grid;return(t instanceof tt)?!this.showValues||!Object.keys(this.showValues).length?!0:(n=t.getCellValue(n,this.column.index,!0),this.showValues[n]!=undefined):!1},t}(e.ValueFilter);t._FlexSheetValueFilter=oi;si=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.updateEditor=function(){var c=this.filter.column,i=c.grid,f=c.index,r=[],l={},e,o,a,v,y,p,s,h,b,t;if(this.filter.uniqueValues){n.prototype.updateEditor.call(this);return}for(t=0;t<i.rows.length;t++)(y=this.filter.apply(t),v=this.filter.showValues,this.filter.showValues=null,p=i._filter._filter(t),this.filter.showValues=v,o=i.getMergedRange(i.cells,t,f),o&&(t!==o.topRow||f!==o.leftCol))||(e=i.rows[t],e instanceof w||e instanceof u.GroupRow||!e.visible&&(y||!p))||(a=i.getCellValue(t,f),s=i.getCellValue(t,f,!0),l[s]||(l[s]=!0,r.push({value:a,text:s})));if(h=this.filter.showValues,h&&Object.keys(h).length!=0){for(b in h)for(t=0;t<r.length;t++)if(r[t].text==b){r[t].show=!0;break}}else for(t=0;t<r.length;t++)r[t].show=!0;this._lbValues.isContentHtml=c.isContentHtml;this._cmbFilter.text=this.filter.filterText;this._filterText=this._cmbFilter.text.toLowerCase();this._view.pageSize=this.filter.maxValues;this._view.sourceCollection=r;this._view.moveCurrentToPosition(-1)},t}(e.ValueFilterEditor);t._FlexSheetValueFilterEditor=si;hi=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.apply=function(n){var r=this.column,s=r.grid,u=this.condition1,f=this.condition2,t,e,o,h,c;return(s instanceof tt)?this.isActive?(t=s.getCellValue(n,r.index),e=o=t,r.dataMap?(t=r.dataMap.getDisplayValue(t),e=o=t):i.isDate(t)?(i.isString(u.value)||i.isString(f.value))&&(t=s.getCellValue(n,r.index,!0),e=o=t):i.isNumber(t)&&(t=i.Globalize.parseFloat(s.getCellValue(n,r.index,!0)),e=o=t,t!==0||r.dataType||(u.isActive&&u.value===''&&(e=null),f.isActive&&f.value===''&&(o=null))),h=u.apply(e),c=f.apply(o),u.isActive&&f.isActive?this.and?h&&c:h||c:u.isActive?h:f.isActive?c:!0):!0:!1},t}(e.ConditionFilter);t._FlexSheetConditionFilter=hi;ci=function(n){function t(t,i){var r=n.call(this,t,i)||this;return r._valueFilter=new oi(i),r._conditionFilter=new hi(i),r}return __extends(t,n),t}(e.ColumnFilter);t._FlexSheetColumnFilter=ci;li=function(n){function t(t,i,r){r===void 0&&(r=!0);var u=n.call(this,t,i,r)||this,o=u,f,e;return r&&(u._divSort.style.display=''),f=u.cloneElement(u._btnAsc),e=u.cloneElement(u._btnDsc),u._btnAsc.parentNode.replaceChild(f,u._btnAsc),u._btnDsc.parentNode.replaceChild(e,u._btnDsc),f.addEventListener('click',function(n){o._sortBtnClick(n,!0)}),e.addEventListener('click',function(n){o._sortBtnClick(n,!1)}),u}return __extends(t,n),t.prototype._showFilter=function(t){t==e.FilterType.Value&&this._edtVal==null&&(this._edtVal=new si(this._divEdtVal,this.filter.valueFilter));n.prototype._showFilter.call(this,t)},t.prototype._sortBtnClick=function(n,t){var u=this.filter.column,i=u.grid.sortManager,r,f,e;n.preventDefault();n.stopPropagation();r=i.checkSortItemExists(u.index);r>-1?(i.sortDescriptions.moveCurrentToPosition(r),e=i.sortDescriptions.currentItem,e.ascending=t,f=-r):(i.addSortLevel(u.index,t),f=-(i.sortDescriptions.items.length-1));i.moveSortLevel(f);i.commitSort();this.updateEditor();this.onButtonClicked()},t.prototype.cloneElement=function(n){for(var t=n.cloneNode();n.firstChild;)t.appendChild(n.lastChild);return t},t}(e.ColumnFilterEditor);t._FlexSheetColumnFilterEditor=li;ai=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),Object.defineProperty(t.prototype,"filterDefinition",{get:function(){for(var n,t,u,i={defaultFilterType:this.defaultFilterType,filters:[]},r=0;r<this._filters.length;r++)n=this._filters[r],n&&n.column&&(n.conditionFilter.isActive?(t=n.conditionFilter,i.filters.push({columnIndex:n.column.index,type:'condition',condition1:{operator:t.condition1.operator,value:t.condition1.value},and:t.and,condition2:{operator:t.condition2.operator,value:t.condition2.value}})):n.valueFilter.isActive&&(u=n.valueFilter,i.filters.push({columnIndex:n.column.index,type:'value',filterText:u.filterText,showValues:u.showValues})));return JSON.stringify(i)},set:function(n){var e=JSON.parse(i.asString(n)),f,r,s;for(this.clear(),this.defaultFilterType=e.defaultFilterType,f=0;f<e.filters.length;f++){var t=e.filters[f],u=this.grid.columns[t.columnIndex],o=this.getColumnFilter(u,!0);if(o)switch(t.type){case'condition':r=o.conditionFilter;r.condition1.value=u.dataType==i.DataType.Date?i.changeType(t.condition1.value,u.dataType,null):t.condition1.value;r.condition1.operator=t.condition1.operator;r.and=t.and;r.condition2.value=u.dataType==i.DataType.Date?i.changeType(t.condition2.value,u.dataType,null):t.condition2.value;r.condition2.operator=t.condition2.operator;break;case'value':s=o.valueFilter;s.filterText=t.filterText;s.showValues=t.showValues}}this.apply()},enumerable:!0,configurable:!0}),t.prototype.apply=function(){var n=this;n.grid.deferUpdate(function(){for(var t,i=0;i<n.grid.rows.length;i++)(t=n.grid.rows[i],t instanceof w)||(t.visible=t instanceof u.GroupRow?n._checkGroupVisible(t.getCellRange()):n._filter(i));n.grid._isCopying||n.grid._resettingFilter||n.onFilterApplied()})},t.prototype.editColumnFilter=function(n,t){var e=this,r;this.closeEditor();n=i.isString(n)?this.grid.columns.getColumn(n):i.asType(n,u.Column,!1);r=new u.CellRangeEventArgs(this.grid.cells,new u.CellRange(-1,n.index));this.onFilterChanging(r);if(!r.cancel){r.cancel=!0;var f=document.createElement('div'),l=this.getColumnFilter(n),s=new li(f,l,this.showSortButtons);i.addClass(f,'wj-dropdown-panel');this.grid.rightToLeft&&(f.dir='rtl');s.filterChanged.addHandler(function(){r.cancel=!1;setTimeout(function(){r.cancel||e.apply()})});s.buttonClicked.addHandler(function(){e.closeEditor();e.onFilterChanged(r)});s.lostFocus.addHandler(function(){setTimeout(function(){var n=i.Control.getControl(e._divEdt);n&&!n.containsFocus()&&e.closeEditor()},10)});var c=this.grid.columnHeaders,a=t?t.row:c.rows.length-1,v=t?t.col:n.index,o=c.getCellBoundingRect(a,v),h=document.elementFromPoint(o.left+o.width/2,o.top+o.height/2);h=i.closest(h,'.wj-cell');h?i.showPopup(f,h,!1,!1,!1):i.showPopup(f,o);s.focus();this._divEdt=f;this._edtCol=n}},t.prototype.getColumnFilter=function(n,t){var r,f;if(t===void 0&&(t=!0),i.isString(n)?n=this.grid.columns.getColumn(n):i.isNumber(n)&&(n=this.grid.columns[n]),!n)return null;for(n=i.asType(n,u.Column),r=0;r<this._filters.length;r++)if(this._filters[r].column==n)return this._filters[r];return t?(f=new ci(this,n),this._filters.push(f),f):null},t.prototype._checkGroupVisible=function(n){for(var t=!0,i,r=n.topRow+1;r<=n.bottomRow;r++)if(i=this.grid.rows[r],i)if(i instanceof u.GroupRow)t=this._checkGroupVisible(i.getCellRange());else if(t=this._filter(r),t)break;return t},t}(e.FlexGridFilter);t._FlexSheetFilter=ai})